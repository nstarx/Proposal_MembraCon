<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MembraCon WaterLogic - Intelligent Proposal System</title>

  <!-- D3 for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet">

  <style>
    /* Dark Theme (Default) */
    :root {
      --bg: #0a0f1a;
      --panel: #0d1424;
      --card: #111b2e;
      --card-hover: #162035;
      --muted: #8fa3c0;
      --text: #e8f0ff;
      --line: #1e2d4a;
      --accent: #6366f1;
      --accent2: #22d3ee;
      --accent3: #a855f7;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --esg-green: #10b981;
      --esg-blue: #3b82f6;
      --esg-purple: #8b5cf6;
      --input-bg: rgba(0,0,0,0.2);
      --shadow: rgba(0,0,0,0.3);
    }

    /* Light Theme */
    [data-theme="light"] {
      --bg: #f5f7fa;
      --panel: #ffffff;
      --card: #ffffff;
      --card-hover: #f8fafc;
      --muted: #64748b;
      --text: #1e293b;
      --line: #e2e8f0;
      --accent: #4f46e5;
      --accent2: #0891b2;
      --accent3: #9333ea;
      --success: #16a34a;
      --warning: #d97706;
      --danger: #dc2626;
      --esg-green: #059669;
      --esg-blue: #2563eb;
      --esg-purple: #7c3aed;
      --input-bg: #f1f5f9;
      --shadow: rgba(0,0,0,0.08);
    }

    /* Light theme specific overrides */
    [data-theme="light"] .app-header {
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
      border-bottom-color: var(--line);
    }

    [data-theme="light"] .sidebar {
      background: var(--panel);
      box-shadow: 2px 0 8px var(--shadow);
    }

    [data-theme="light"] .content-panel {
      box-shadow: 0 1px 3px var(--shadow);
    }

    [data-theme="light"] .form-input {
      background: var(--input-bg);
      border-color: var(--line);
    }

    [data-theme="light"] .chip {
      background: var(--input-bg);
      border-color: var(--line);
    }

    [data-theme="light"] .tech-card {
      background: var(--input-bg);
    }

    [data-theme="light"] .workflow-step {
      background: var(--card);
      box-shadow: 0 1px 3px var(--shadow);
    }

    [data-theme="light"] .metric-card {
      box-shadow: 0 1px 3px var(--shadow);
    }

    [data-theme="light"] .solution-table th {
      background: var(--input-bg);
    }

    [data-theme="light"] .btn-secondary {
      background: var(--input-bg);
      border-color: var(--line);
    }

    [data-theme="light"] .btn-secondary:hover {
      background: #e2e8f0;
    }

    [data-theme="light"] .proposal-preview {
      box-shadow: 0 4px 12px var(--shadow);
    }

    [data-theme="light"] .override-panel {
      background: linear-gradient(135deg, rgba(245,158,11,0.05), rgba(239,68,68,0.03));
    }

    [data-theme="light"] .ai-processing {
      background: linear-gradient(135deg, rgba(79,70,229,0.08), rgba(147,51,234,0.05));
    }

    [data-theme="light"] .esg-gauge {
      background: var(--input-bg);
    }

    [data-theme="light"] .decision-item {
      background: var(--input-bg);
    }

    [data-theme="light"] .project-item {
      background: var(--input-bg);
    }

    [data-theme="light"] .nav-tab.active {
      background: linear-gradient(135deg, rgba(79,70,229,0.1), rgba(8,145,178,0.08));
    }

    [data-theme="light"] input[type="range"] {
      background: #cbd5e1;
    }

    [data-theme="light"] .gauge-bg {
      stroke: #e2e8f0;
    }

    [data-theme="light"] .sidebar-section {
      box-shadow: 0 1px 3px var(--shadow);
    }

    [data-theme="light"] .progress-bar-bg {
      background: #e2e8f0 !important;
    }

    [data-theme="light"] .logo-icon {
      box-shadow: 0 2px 8px rgba(79,70,229,0.25);
    }

    [data-theme="light"] .cost-segment {
      color: #fff;
    }

    [data-theme="light"] .confidence-bar {
      background: #e2e8f0;
    }

    /* Smooth theme transition */
    * {
      transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(180deg, rgba(13,20,36,0.98), rgba(13,20,36,0.95));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      padding: 0 24px;
      z-index: 1000;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    .logo-text span {
      color: var(--accent2);
    }

    .nav-tabs {
      display: flex;
      gap: 4px;
      margin-left: 40px;
    }

    .nav-tab {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid transparent;
    }

    .nav-tab:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(34,211,238,0.1));
      border-color: rgba(99,102,241,0.3);
      color: var(--text);
    }

    .nav-tab .material-icons-outlined {
      font-size: 18px;
    }

    .header-spacer { flex: 1; }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent3), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    /* Theme Toggle */
    .theme-toggle {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--card);
      border: 1px solid var(--line);
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .theme-toggle:hover {
      background: var(--card-hover);
      color: var(--text);
      border-color: var(--accent);
    }

    .theme-toggle .material-icons-outlined {
      font-size: 20px;
    }

    [data-theme="light"] .theme-toggle {
      background: var(--input-bg);
    }

    /* Keyboard Mode */
    [data-keyboard-mode="true"] .keyboard-toggle {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .shortcut-badge {
      display: none;
      position: absolute;
      top: -8px;
      right: -8px;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      border-radius: 4px;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    [data-keyboard-mode="true"] .shortcut-badge {
      display: flex;
    }

    .has-shortcut {
      position: relative;
    }

    /* Keyboard mode indicator */
    .keyboard-mode-bar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: var(--accent);
      color: #fff;
      font-size: 12px;
      font-weight: 500;
      align-items: center;
      justify-content: center;
      gap: 24px;
      z-index: 9999;
    }

    [data-keyboard-mode="true"] .keyboard-mode-bar {
      display: flex;
    }

    .keyboard-mode-bar kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 22px;
      padding: 0 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      font-family: inherit;
      font-size: 11px;
      font-weight: 600;
    }

    .keyboard-mode-bar .separator {
      width: 1px;
      height: 20px;
      background: rgba(255,255,255,0.3);
    }

    /* Highlight focused element in keyboard mode */
    [data-keyboard-mode="true"] .form-input:focus,
    [data-keyboard-mode="true"] select:focus {
      box-shadow: 0 0 0 3px var(--accent), 0 0 20px rgba(99,102,241,0.4);
    }

    [data-keyboard-mode="true"] .chip:focus,
    [data-keyboard-mode="true"] .workflow-step:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Input label shortcut indicator */
    .input-label .shortcut-key {
      display: none;
      margin-left: 4px;
      padding: 1px 4px;
      background: var(--accent);
      color: #fff;
      font-size: 9px;
      font-weight: 700;
      border-radius: 3px;
    }

    [data-keyboard-mode="true"] .input-label .shortcut-key {
      display: inline;
    }

    /* Workflow step shortcuts */
    [data-keyboard-mode="true"] .workflow-step::before {
      content: attr(data-shortcut);
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .workflow-step {
      position: relative;
    }

    /* Hide step shortcut when not in keyboard mode */
    .workflow-step::before {
      display: none;
    }

    [data-keyboard-mode="true"] .workflow-step::before {
      display: flex;
    }

    /* Main Layout */
    .app-container {
      margin-top: 60px;
      display: flex;
      min-height: calc(100vh - 60px);
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--panel);
      border-right: 1px solid var(--line);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebar-section {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--line);
    }

    .sidebar-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-title .material-icons-outlined {
      font-size: 16px;
    }

    /* Project Status */
    .project-item {
      padding: 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--line);
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .project-item:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(99,102,241,0.3);
    }

    .project-item.active {
      border-color: var(--accent);
      background: rgba(99,102,241,0.08);
    }

    .project-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .project-meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      gap: 10px;
    }

    .project-stage {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      margin-top: 8px;
    }

    .stage-intake { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .stage-design { background: rgba(168,85,247,0.2); color: #c084fc; }
    .stage-pricing { background: rgba(245,158,11,0.2); color: #fbbf24; }
    .stage-proposal { background: rgba(34,197,94,0.2); color: #4ade80; }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    /* View Container */
    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    /* Step Content */
    .step-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .step-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Workflow Steps */
    .workflow-header {
      margin-bottom: 24px;
    }

    .workflow-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .workflow-subtitle {
      font-size: 14px;
      color: var(--muted);
    }

    .workflow-steps {
      display: flex;
      gap: 8px;
      margin-bottom: 32px;
    }

    .workflow-step {
      flex: 1;
      padding: 14px 16px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }

    .workflow-step::after {
      content: '';
      position: absolute;
      right: -14px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      border-right: 2px solid var(--line);
      border-top: 2px solid var(--line);
      transform: translateY(-50%) rotate(45deg);
    }

    .workflow-step:last-child::after {
      display: none;
    }

    .workflow-step:hover {
      border-color: rgba(99,102,241,0.4);
    }

    .workflow-step.active {
      background: linear-gradient(135deg, rgba(99,102,241,0.12), rgba(34,211,238,0.08));
      border-color: var(--accent);
    }

    .workflow-step.completed {
      border-color: var(--success);
    }

    .workflow-step.completed .step-icon {
      background: var(--success);
    }

    .step-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .step-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--line);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .workflow-step.active .step-icon {
      background: var(--accent);
    }

    .step-name {
      font-size: 13px;
      font-weight: 600;
    }

    .step-desc {
      font-size: 11px;
      color: var(--muted);
      padding-left: 38px;
    }

    /* Content Panels */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .content-grid.three-cols {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .content-panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
    }

    .content-panel.full-width {
      grid-column: 1 / -1;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-title .material-icons-outlined {
      font-size: 20px;
      color: var(--accent);
    }

    .panel-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(99,102,241,0.15);
      color: var(--accent);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 14px;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--line);
      border-radius: 10px;
      color: var(--text);
      font-size: 13px;
      transition: all 0.15s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
    }

    .form-input::placeholder {
      color: rgba(143,163,192,0.5);
    }

    select.form-input {
      cursor: pointer;
    }

    /* Input Field with Label */
    .input-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .input-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    [data-theme="light"] .input-label {
      color: #475569;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .form-row.three-cols {
      grid-template-columns: 1fr 1fr 1fr;
    }

    /* Range Slider */
    .range-group {
      margin-bottom: 16px;
    }

    .range-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .range-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
    }

    .range-value {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent2);
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--line);
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(99,102,241,0.4);
    }

    /* Toggle Chips */
    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      padding: 8px 14px;
      border-radius: 8px;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--line);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chip:hover {
      border-color: rgba(99,102,241,0.4);
      background: rgba(99,102,241,0.08);
    }

    .chip.active {
      background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(34,211,238,0.15));
      border-color: var(--accent);
      color: var(--text);
    }

    .chip .material-icons-outlined {
      font-size: 16px;
    }

    /* Technology Cards */
    .tech-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .tech-card {
      padding: 16px;
      background: rgba(0,0,0,0.15);
      border: 1px solid var(--line);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }

    .tech-card:hover {
      border-color: rgba(99,102,241,0.4);
      background: rgba(99,102,241,0.05);
    }

    .tech-card.selected {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(99,102,241,0.12), rgba(34,211,238,0.08));
    }

    .tech-card.recommended::before {
      content: 'Recommended';
      position: absolute;
      top: -8px;
      right: 12px;
      padding: 3px 8px;
      background: var(--success);
      color: #000;
      font-size: 9px;
      font-weight: 700;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .tech-name {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .tech-full {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .tech-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .tech-stat {
      font-size: 10px;
      color: var(--muted);
    }

    .tech-stat-value {
      font-weight: 600;
      color: var(--accent2);
    }

    /* Metrics Cards */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
    }

    .metric-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-value.accent { color: var(--accent); }
    .metric-value.success { color: var(--success); }
    .metric-value.warning { color: var(--warning); }
    .metric-value.accent2 { color: var(--accent2); }

    .metric-change {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .metric-change.positive { color: var(--success); }
    .metric-change.negative { color: var(--danger); }

    /* Solution Comparison */
    .solution-table {
      width: 100%;
      border-collapse: collapse;
    }

    .solution-table th,
    .solution-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--line);
    }

    .solution-table th {
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: rgba(0,0,0,0.2);
    }

    .solution-table td {
      font-size: 13px;
    }

    .solution-table tr:hover td {
      background: rgba(99,102,241,0.05);
    }

    .solution-rank {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
    }

    .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
    .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: #000; }
    .rank-3 { background: linear-gradient(135deg, #c2855a, #a16941); color: #fff; }

    .confidence-bar {
      width: 100px;
      height: 6px;
      background: var(--line);
      border-radius: 3px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .confidence-high { background: var(--success); }
    .confidence-medium { background: var(--warning); }
    .confidence-low { background: var(--danger); }

    /* ESG Gauge */
    .esg-gauges {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .esg-gauge {
      text-align: center;
      padding: 20px;
      background: rgba(0,0,0,0.15);
      border-radius: 12px;
      border: 1px solid var(--line);
    }

    .gauge-ring {
      width: 80px;
      height: 80px;
      margin: 0 auto 12px;
      position: relative;
    }

    .gauge-ring svg {
      transform: rotate(-90deg);
    }

    .gauge-ring circle {
      fill: none;
      stroke-width: 8;
    }

    .gauge-bg { stroke: var(--line); }
    .gauge-fill { stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }

    .gauge-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: 700;
    }

    .esg-gauge.water .gauge-fill { stroke: var(--esg-blue); }
    .esg-gauge.carbon .gauge-fill { stroke: var(--esg-green); }
    .esg-gauge.energy .gauge-fill { stroke: var(--esg-purple); }

    .esg-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
    }

    /* Cost Breakdown */
    .cost-bar {
      display: flex;
      height: 32px;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .cost-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .cost-segment:hover {
      filter: brightness(1.15);
    }

    .cost-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 4px;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #818cf8);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(99,102,241,0.4);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--line);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #16a34a);
      color: #fff;
    }

    .btn .material-icons-outlined {
      font-size: 18px;
    }

    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--line);
    }

    /* Override Panel */
    .override-panel {
      background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(239,68,68,0.05));
      border: 1px solid rgba(245,158,11,0.3);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .override-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .override-header .material-icons-outlined {
      color: var(--warning);
    }

    .override-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--warning);
    }

    .override-note {
      width: 100%;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(245,158,11,0.3);
      border-radius: 8px;
      color: var(--text);
      font-size: 12px;
      resize: vertical;
      min-height: 60px;
    }

    /* Proposal Preview */
    .proposal-preview {
      background: #fff;
      color: #1a1a1a;
      border-radius: 12px;
      padding: 32px;
      max-height: 500px;
      overflow-y: auto;
    }

    .proposal-preview h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .proposal-preview h2 {
      font-size: 18px;
      color: #4f46e5;
      margin-top: 24px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }

    .proposal-preview p {
      font-size: 14px;
      line-height: 1.6;
      color: #4b5563;
      margin-bottom: 12px;
    }

    .proposal-preview table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }

    .proposal-preview table th,
    .proposal-preview table td {
      padding: 10px;
      text-align: left;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .proposal-preview table th {
      background: #f9fafb;
      font-weight: 600;
    }

    /* Documentation View */
    .docs-embed {
      width: 100%;
      height: calc(100vh - 200px);
      border: none;
      border-radius: 12px;
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.3s ease;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .content-grid { grid-template-columns: 1fr; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
      .tech-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* AI Processing Animation */
    .ai-processing {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.08));
      border: 1px solid rgba(99,102,241,0.3);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .ai-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--line);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .ai-text {
      font-size: 13px;
      color: var(--accent);
      font-weight: 500;
    }

    /* Decision Trail */
    .decision-trail {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .decision-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: rgba(0,0,0,0.15);
      border-radius: 10px;
      border-left: 3px solid var(--accent);
    }

    .decision-time {
      font-size: 11px;
      color: var(--muted);
      min-width: 60px;
    }

    .decision-content {
      flex: 1;
    }

    .decision-action {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .decision-reason {
      font-size: 11px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="logo">
      <div class="logo-icon">
        <span class="material-icons-round">water_drop</span>
      </div>
      <div class="logo-text">MembraCon <span>WaterLogic</span></div>
    </div>

    <nav class="nav-tabs">
      <div class="nav-tab active" data-view="proposal">
        <span class="material-icons-outlined">add_circle</span>
        New Proposal
      </div>
      <div class="nav-tab" data-view="projects">
        <span class="material-icons-outlined">folder_open</span>
        All Projects
      </div>
      <div class="nav-tab" data-view="docs">
        <span class="material-icons-outlined">hub</span>
        Documentation
      </div>
    </nav>

    <div class="header-spacer"></div>

    <div class="user-menu">
      <!-- Keyboard Mode Toggle -->
      <button class="theme-toggle" id="keyboardToggle" onclick="toggleKeyboardMode()" title="Toggle keyboard mode (Ctrl+K)">
        <span class="material-icons-outlined" id="keyboardIcon">keyboard</span>
      </button>
      <!-- Theme Toggle -->
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">
        <span class="material-icons-outlined" id="themeIcon">light_mode</span>
      </button>
      <span style="font-size:12px;color:var(--muted)">Internal System v1.0</span>
      <div class="user-avatar">TE</div>
    </div>
  </header>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">
          <span class="material-icons-outlined">folder_open</span>
          Active Projects
        </div>

        <div class="project-item active">
          <div class="project-name">Riverside Pharma - Purified Water</div>
          <div class="project-meta">
            <span>200 m³/h</span>
            <span>RO System</span>
          </div>
          <div class="project-stage stage-design">In Design</div>
        </div>

        <div class="project-item">
          <div class="project-name">Nordic Foods - Wastewater</div>
          <div class="project-meta">
            <span>500 m³/h</span>
            <span>MBR + UV</span>
          </div>
          <div class="project-stage stage-pricing">Pricing</div>
        </div>

        <div class="project-item">
          <div class="project-name">GreenEnergy - Cooling Tower</div>
          <div class="project-meta">
            <span>1000 m³/h</span>
            <span>UF + RO</span>
          </div>
          <div class="project-stage stage-proposal">Proposal Ready</div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">
          <span class="material-icons-outlined">insights</span>
          Quick Stats
        </div>
        <div style="font-size:12px;color:var(--muted);line-height:1.8">
          <div style="display:flex;justify-content:space-between">
            <span>Active Proposals</span>
            <span style="color:var(--accent);font-weight:600">12</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>Avg. Win Rate</span>
            <span style="color:var(--success);font-weight:600">67%</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>Avg. Turnaround</span>
            <span style="color:var(--accent2);font-weight:600">2.3 days</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>ESG Score Avg</span>
            <span style="color:var(--esg-green);font-weight:600">82</span>
          </div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">
          <span class="material-icons-outlined">memory</span>
          System Control
        </div>
        <div class="chip-group">
          <div class="chip" onclick="this.classList.toggle('active')">
            <span class="material-icons-outlined">tune</span>
            Override Mode
          </div>
          <div class="chip active">
            <span class="material-icons-outlined">smart_toy</span>
            AI Assist
          </div>
          <div class="chip">
            <span class="material-icons-outlined">history</span>
            Audit Trail
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Proposal Builder View -->
      <div class="view active" id="view-proposal">
        <div class="workflow-header">
          <h1 class="workflow-title">Proposal Builder</h1>
          <p class="workflow-subtitle">End-to-end intelligent proposal generation workflow</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar-container" style="margin-bottom:24px">
          <div class="progress-bar-bg" style="height:4px;background:var(--line);border-radius:2px;overflow:hidden">
            <div class="progress-bar-fill" id="progressFill" style="width:20%;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 0.3s ease"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:var(--muted)">
            <span>Step <span id="currentStepNum">1</span> of 5</span>
            <span id="progressPercent">20%</span>
          </div>
        </div>

        <!-- Workflow Steps -->
        <div class="workflow-steps">
          <div class="workflow-step active" data-step="1" data-content="step-intake" data-shortcut="1" tabindex="0">
            <div class="step-header">
              <div class="step-icon">
                <span class="material-icons-outlined">input</span>
              </div>
              <span class="step-name">1. Intake</span>
            </div>
            <div class="step-desc">Customer requirements</div>
          </div>
          <div class="workflow-step" data-step="2" data-content="step-design" data-shortcut="2" tabindex="0">
            <div class="step-header">
              <div class="step-icon">
                <span class="material-icons-outlined">architecture</span>
              </div>
              <span class="step-name">2. Solution Design</span>
            </div>
            <div class="step-desc">AI-optimized solution</div>
          </div>
          <div class="workflow-step" data-step="3" data-content="step-pricing" data-shortcut="3" tabindex="0">
            <div class="step-header">
              <div class="step-icon">
                <span class="material-icons-outlined">calculate</span>
              </div>
              <span class="step-name">3. Pricing</span>
            </div>
            <div class="step-desc">CapEx & OpEx modeling</div>
          </div>
          <div class="workflow-step" data-step="4" data-content="step-esg" data-shortcut="4" tabindex="0">
            <div class="step-header">
              <div class="step-icon">
                <span class="material-icons-outlined">eco</span>
              </div>
              <span class="step-name">4. ESG Analysis</span>
            </div>
            <div class="step-desc">Sustainability metrics</div>
          </div>
          <div class="workflow-step" data-step="5" data-content="step-generate" data-shortcut="5" tabindex="0">
            <div class="step-header">
              <div class="step-icon">
                <span class="material-icons-outlined">auto_awesome</span>
              </div>
              <span class="step-name">5. Generate</span>
            </div>
            <div class="step-desc">Export proposal</div>
          </div>
        </div>

        <!-- Step 1: Intake -->
        <div class="step-content active" id="step-intake">
        <div class="content-grid">
          <!-- Input Specifications Panel -->
          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">input</span>
                Input Specifications
              </div>
              <span class="panel-badge">Step 1</span>
            </div>

            <div class="form-group">
              <label class="form-label">Industry Sector</label>
              <select class="form-input" id="sector">
                <option value="pharmaceutical">Pharmaceutical</option>
                <option value="foodBeverage">Food & Beverage</option>
                <option value="power">Power Generation</option>
                <option value="municipal">Municipal</option>
                <option value="oilGas">Oil & Gas</option>
                <option value="semiconductor">Semiconductor</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <div class="input-field">
                  <label class="input-label" for="flowRate">Flow Rate (m³/h) <span class="shortcut-key">F</span></label>
                  <input type="number" class="form-input" id="flowRate" value="200" data-shortcut="f">
                </div>
              </div>
              <div class="form-group">
                <div class="input-field">
                  <label class="input-label" for="opHours">Operating Hours (hrs/year) <span class="shortcut-key">H</span></label>
                  <input type="number" class="form-input" id="opHours" value="8000" data-shortcut="h">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Feed Water Quality - Primary</label>
              <div class="form-row three-cols">
                <div class="input-field">
                  <label class="input-label" for="feedTDS">TDS (ppm) <span class="shortcut-key">T</span></label>
                  <input type="number" class="form-input" id="feedTDS" value="45" data-shortcut="t">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedTSS">TSS (ppm) <span class="shortcut-key">S</span></label>
                  <input type="number" class="form-input" id="feedTSS" value="1" data-shortcut="s">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedBOD">BOD (mg/L) <span class="shortcut-key">B</span></label>
                  <input type="number" class="form-input" id="feedBOD" value="120" data-shortcut="b">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Feed Water Quality - Extended</label>
              <div class="form-row three-cols">
                <div class="input-field">
                  <label class="input-label" for="feedConductivity">Conductivity (µS/cm) <span class="shortcut-key">C</span></label>
                  <input type="number" class="form-input" id="feedConductivity" value="11" data-shortcut="c">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedPH">pH <span class="shortcut-key">P</span></label>
                  <input type="number" class="form-input" id="feedPH" value="6" step="0.1" min="0" max="14" data-shortcut="p">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedChlorine">Chlorine (ppm) <span class="shortcut-key">L</span></label>
                  <input type="number" class="form-input" id="feedChlorine" value="0.01" step="0.01" data-shortcut="l">
                </div>
              </div>
              <div class="form-row three-cols" style="margin-top:12px">
                <div class="input-field">
                  <label class="input-label" for="feedTurbidity">Turbidity (NTU) <span class="shortcut-key">U</span></label>
                  <input type="number" class="form-input" id="feedTurbidity" value="1" step="0.1" data-shortcut="u">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedSDI">SDI <span class="shortcut-key">D</span></label>
                  <input type="number" class="form-input" id="feedSDI" value="3" step="0.1" data-shortcut="d">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedIron">Iron (mg/L) <span class="shortcut-key">I</span></label>
                  <input type="number" class="form-input" id="feedIron" value="0.01" step="0.01" data-shortcut="i">
                </div>
              </div>
              <div class="form-row three-cols" style="margin-top:12px">
                <div class="input-field">
                  <label class="input-label" for="feedHardness">Hardness (mg/L CaCO₃) <span class="shortcut-key">A</span></label>
                  <input type="number" class="form-input" id="feedHardness" value="100" data-shortcut="a">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedTemp">Temperature (°C) <span class="shortcut-key">E</span></label>
                  <input type="number" class="form-input" id="feedTemp" value="15" data-shortcut="e">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedPressure">Feed Pressure (BAR) <span class="shortcut-key">R</span></label>
                  <input type="number" class="form-input" id="feedPressure" value="4" step="0.1" data-shortcut="r">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Required Output Quality</label>
              <div class="form-row three-cols">
                <div class="input-field">
                  <label class="input-label" for="outTDS">TDS (ppm) <span class="shortcut-key">O</span></label>
                  <input type="number" class="form-input" id="outTDS" value="10" data-shortcut="o">
                </div>
                <div class="input-field">
                  <label class="input-label" for="outTSS">TSS (ppm) <span class="shortcut-key">W</span></label>
                  <input type="number" class="form-input" id="outTSS" value="0.1" step="0.01" data-shortcut="w">
                </div>
                <div class="input-field">
                  <label class="input-label" for="outConductivity">Permeate Quality (µS/cm) <span class="shortcut-key">Q</span></label>
                  <input type="number" class="form-input" id="outConductivity" value="15" data-shortcut="q">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">System Design Parameters</label>
              <div class="form-row three-cols">
                <div class="input-field">
                  <label class="input-label" for="recovery">Recovery (%) <span class="shortcut-key">Y</span></label>
                  <input type="number" class="form-input" id="recovery" value="75" min="50" max="95" data-shortcut="y">
                </div>
                <div class="input-field">
                  <label class="input-label" for="componentMarkup">Component Markup (%) <span class="shortcut-key">M</span></label>
                  <input type="number" class="form-input" id="componentMarkup" value="30" min="0" max="100" data-shortcut="m">
                </div>
                <div class="input-field">
                  <label class="input-label" for="permeateFlow">Permeate Flow (m³/hr) <span class="shortcut-key">X</span></label>
                  <input type="number" class="form-input" id="permeateFlow" value="9" data-shortcut="x">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">System Configuration</label>
              <div class="chip-group">
                <div class="chip" id="chipContainer">
                  <span class="material-icons-outlined">view_in_ar</span>
                  Container Required
                </div>
                <div class="chip active" id="chipUV">
                  <span class="material-icons-outlined">light_mode</span>
                  UV Required
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Installation Type</label>
              <div class="chip-group">
                <div class="chip active">
                  <span class="material-icons-outlined">domain</span>
                  Fixed Installation
                </div>
                <div class="chip">
                  <span class="material-icons-outlined">view_in_ar</span>
                  Containerized
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Optional Modules</label>
              <div class="chip-group">
                <div class="chip">Pre-filtration</div>
                <div class="chip active">Chemical Dosing</div>
                <div class="chip">pH Adjustment - Dosing</div>
                <div class="chip">Hardness - Anti Scale Dosing</div>
                <div class="chip">Carbon (Chlorine Removal)</div>
                <div class="chip">Iron Removal</div>
                <div class="chip">Second Stage RO</div>
                <div class="chip">Polish DI</div>
                <div class="chip">Buffer Tank</div>
                <div class="chip">CIP System</div>
                <div class="chip">Remote Monitoring</div>
              </div>
            </div>
          </div>

          <!-- AI Solution Design Panel -->
          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">smart_toy</span>
                AI Solution Design
              </div>
              <span class="panel-badge">Optimizing</span>
            </div>

            <div class="ai-processing">
              <div class="ai-spinner"></div>
              <span class="ai-text">Analyzing 847 possible configurations...</span>
            </div>

            <p style="font-size:12px;color:var(--muted);margin-bottom:16px;">
              Recommended technology train based on your specifications:
            </p>

            <div class="tech-grid">
              <div class="tech-card recommended selected">
                <div class="tech-name">UF</div>
                <div class="tech-full">Ultrafiltration</div>
                <div class="tech-stats">
                  <div class="tech-stat">TSS: <span class="tech-stat-value">99%</span></div>
                  <div class="tech-stat">Energy: <span class="tech-stat-value">0.3 kWh/m³</span></div>
                </div>
              </div>
              <div class="tech-card selected">
                <div class="tech-name">RO</div>
                <div class="tech-full">Reverse Osmosis</div>
                <div class="tech-stats">
                  <div class="tech-stat">TDS: <span class="tech-stat-value">97%</span></div>
                  <div class="tech-stat">Energy: <span class="tech-stat-value">2.5 kWh/m³</span></div>
                </div>
              </div>
              <div class="tech-card selected">
                <div class="tech-name">UV</div>
                <div class="tech-full">UV Disinfection</div>
                <div class="tech-stats">
                  <div class="tech-stat">Log: <span class="tech-stat-value">4-6</span></div>
                  <div class="tech-stat">Energy: <span class="tech-stat-value">0.1 kWh/m³</span></div>
                </div>
              </div>
            </div>

            <!-- Calculated Values Panel -->
            <div style="margin-top:16px;padding:12px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid var(--line)">
              <div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">
                RO System Calculations
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
                <div style="color:var(--muted)">Feed Flow (m³/hr):</div>
                <div style="text-align:right;font-weight:600;color:var(--accent2)" id="calcFeedFlow">11.25</div>
                <div style="color:var(--muted)">Reject Flow (m³/hr):</div>
                <div style="text-align:right;font-weight:600;color:var(--accent2)" id="calcRejectFlow">2.25</div>
                <div style="color:var(--muted)">Permeate Flow (m³/hr):</div>
                <div style="text-align:right;font-weight:600;color:var(--accent2)" id="calcPermeateFlow">9.00</div>
                <div style="color:var(--muted)">Membrane Area (m²) 8080:</div>
                <div style="text-align:right;font-weight:600;color:var(--accent2)" id="calcMembraneArea">37</div>
                <div style="color:var(--muted)">Number of Membranes:</div>
                <div style="text-align:right;font-weight:600;color:var(--accent2)" id="calcNumMembranes">9</div>
                <div style="color:var(--muted)">Total Membrane Area (m²):</div>
                <div style="text-align:right;font-weight:600;color:var(--accent2)" id="calcTotalArea">333</div>
                <div style="color:var(--muted)">Pressure Vessels:</div>
                <div style="text-align:right;font-weight:600;color:var(--accent2)" id="calcPressureVessels">3</div>
                <div style="color:var(--muted)">Estimated µS/cm 1st Stage:</div>
                <div style="text-align:right;font-weight:600;color:var(--accent2)" id="calcConductivity">1.08</div>
                <div style="color:var(--muted)">Pump Power (kW):</div>
                <div style="text-align:right;font-weight:600;color:var(--accent2)" id="calcPumpPower">7.5</div>
              </div>
            </div>

            <div style="margin-top:16px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                <span class="material-icons-outlined" style="color:var(--success);font-size:18px">check_circle</span>
                <span style="font-size:13px;font-weight:600;color:var(--success)">Solution Validated</span>
              </div>
              <p style="font-size:12px;color:var(--muted);margin:0">
                UF + RO + UV train meets all output quality requirements with 89% confidence.
                Expected water recovery: 75%. Total energy: 2.9 kWh/m³.
              </p>
            </div>

            <!-- Warning Panel (from spreadsheet) -->
            <div style="margin-top:16px;padding:12px;background:rgba(245,158,11,0.1);border-radius:10px;border:1px solid rgba(245,158,11,0.3)">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                <span class="material-icons-outlined" style="color:var(--warning);font-size:18px">warning</span>
                <span style="font-size:12px;font-weight:600;color:var(--warning)">Temperature Warning</span>
              </div>
              <p style="font-size:11px;color:var(--muted);margin:0">
                Temperature is low - check this could affect flow. Perhaps increase size of system.
              </p>
            </div>

            <!-- Engineer Override -->
            <div class="override-panel">
              <div class="override-header">
                <span class="material-icons-outlined">engineering</span>
                <span class="override-title">Engineer Override</span>
              </div>
              <textarea class="override-note" placeholder="Add manual adjustments or override AI recommendations..."></textarea>
            </div>
          </div>

          <!-- Decision Trail Panel -->
          <div class="content-panel full-width">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">account_tree</span>
                Decision Trail
              </div>
              <button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">
                <span class="material-icons-outlined" style="font-size:14px">download</span>
                Export Audit
              </button>
            </div>

            <div class="decision-trail">
              <div class="decision-item">
                <div class="decision-time">14:32:01</div>
                <div class="decision-content">
                  <div class="decision-action">Selected UF as pre-treatment</div>
                  <div class="decision-reason">High TSS in feed water (50 mg/L) requires membrane protection. UF provides 99% TSS removal.</div>
                </div>
              </div>
              <div class="decision-item">
                <div class="decision-time">14:32:02</div>
                <div class="decision-content">
                  <div class="decision-action">Selected RO for desalination</div>
                  <div class="decision-reason">TDS reduction requirement (1500 → 10 mg/L) requires 99.3% rejection. RO achieves 97% per pass.</div>
                </div>
              </div>
              <div class="decision-item">
                <div class="decision-time">14:32:03</div>
                <div class="decision-content">
                  <div class="decision-action">Added UV disinfection</div>
                  <div class="decision-reason">Pharmaceutical sector requires validated disinfection. UV selected per customer module preference.</div>
                </div>
              </div>
              <div class="decision-item">
                <div class="decision-time">14:32:04</div>
                <div class="decision-content">
                  <div class="decision-action">Rejected MBR option</div>
                  <div class="decision-reason">BOD/COD removal not primary concern for this application. UF + RO more cost-effective.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" onclick="prevStep()" style="visibility:hidden">
            <span class="material-icons-outlined">arrow_back</span>
            Previous
          </button>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
            <button class="btn btn-primary" onclick="goToStep(2)">
              Continue to Solution Design
              <span class="material-icons-outlined">arrow_forward</span>
            </button>
          </div>
        </div>
        </div><!-- End Step 1: Intake -->

        <!-- Step 2: Solution Design -->
        <div class="step-content" id="step-design">
        <div class="workflow-header">
          <h1 class="workflow-title">Solution Design & Comparison</h1>
          <p class="workflow-subtitle">Compare and rank optimized treatment solutions</p>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Solutions Analyzed</div>
            <div class="metric-value accent">847</div>
            <div class="metric-change positive">
              <span class="material-icons-outlined" style="font-size:14px">trending_up</span>
              Multi-objective optimization
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Top Confidence</div>
            <div class="metric-value success">89%</div>
            <div class="metric-change positive">
              <span class="material-icons-outlined" style="font-size:14px">verified</span>
              Auto-approve threshold
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Best Water Recovery</div>
            <div class="metric-value accent2">85%</div>
            <div class="metric-change">
              <span class="material-icons-outlined" style="font-size:14px">water_drop</span>
              Above industry avg
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Min Energy</div>
            <div class="metric-value warning">2.8 kWh/m³</div>
            <div class="metric-change">
              <span class="material-icons-outlined" style="font-size:14px">bolt</span>
              Optimized selection
            </div>
          </div>
        </div>

        <div class="content-panel full-width">
          <div class="panel-header">
            <div class="panel-title">
              <span class="material-icons-outlined">compare</span>
              Ranked Solutions
            </div>
          </div>

          <table class="solution-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Technology Train</th>
                <th>CapEx Est.</th>
                <th>OpEx/yr</th>
                <th>Water Recovery</th>
                <th>Energy</th>
                <th>ESG Score</th>
                <th>Confidence</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="solution-rank rank-1">1</span></td>
                <td><strong>UF + RO + UV</strong></td>
                <td>£1.2M</td>
                <td>£185K</td>
                <td>82%</td>
                <td>2.9 kWh/m³</td>
                <td style="color:var(--esg-green)">85</td>
                <td>
                  <div class="confidence-bar"><div class="confidence-fill confidence-high" style="width:89%"></div></div>
                  <span style="font-size:11px;color:var(--muted)">89%</span>
                </td>
              </tr>
              <tr>
                <td><span class="solution-rank rank-2">2</span></td>
                <td><strong>MBR + RO</strong></td>
                <td>£1.45M</td>
                <td>£210K</td>
                <td>78%</td>
                <td>3.3 kWh/m³</td>
                <td style="color:var(--esg-green)">82</td>
                <td>
                  <div class="confidence-bar"><div class="confidence-fill confidence-high" style="width:82%"></div></div>
                  <span style="font-size:11px;color:var(--muted)">82%</span>
                </td>
              </tr>
              <tr>
                <td><span class="solution-rank rank-3">3</span></td>
                <td><strong>DAF + UF + RO</strong></td>
                <td>£1.35M</td>
                <td>£195K</td>
                <td>80%</td>
                <td>2.85 kWh/m³</td>
                <td style="color:var(--esg-green)">79</td>
                <td>
                  <div class="confidence-bar"><div class="confidence-fill confidence-medium" style="width:76%"></div></div>
                  <span style="font-size:11px;color:var(--muted)">76%</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="content-grid" style="margin-top:20px">
          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">tune</span>
                Vendor Selection
              </div>
            </div>
            <p style="font-size:12px;color:var(--muted);margin-bottom:16px">
              Include or exclude specific vendors in the solution:
            </p>
            <div class="chip-group">
              <div class="chip active">Pentair</div>
              <div class="chip active">Koch</div>
              <div class="chip active">Dow FilmTec</div>
              <div class="chip">Toray</div>
              <div class="chip active">Suez</div>
              <div class="chip">Xylem</div>
            </div>
          </div>

          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">balance</span>
                Optimization Weights
              </div>
            </div>
            <div class="range-group">
              <div class="range-header">
                <span class="range-label">Cost Priority</span>
                <span class="range-value">40%</span>
              </div>
              <input type="range" value="40" min="0" max="100">
            </div>
            <div class="range-group">
              <div class="range-header">
                <span class="range-label">ESG Priority</span>
                <span class="range-value">35%</span>
              </div>
              <input type="range" value="35" min="0" max="100">
            </div>
            <div class="range-group">
              <div class="range-header">
                <span class="range-label">Technical Risk</span>
                <span class="range-value">25%</span>
              </div>
              <input type="range" value="25" min="0" max="100">
            </div>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" onclick="goToStep(1)">
            <span class="material-icons-outlined">arrow_back</span>
            Back to Intake
          </button>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
            <button class="btn btn-primary" onclick="goToStep(3)">
              Continue to Pricing
              <span class="material-icons-outlined">arrow_forward</span>
            </button>
          </div>
        </div>
        </div><!-- End Step 2: Solution Design -->

        <!-- Step 3: Pricing -->
        <div class="step-content" id="step-pricing">
        <div class="workflow-header">
          <h1 class="workflow-title">Pricing Intelligence</h1>
          <p class="workflow-subtitle">Dynamic CapEx & OpEx modeling with market intelligence</p>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Total CapEx</div>
            <div class="metric-value accent">£1.24M</div>
            <div class="metric-change">Base equipment + installation</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Annual OpEx</div>
            <div class="metric-value warning">£185K</div>
            <div class="metric-change">Energy + chemicals + labor</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">10yr NPV</div>
            <div class="metric-value accent2">£2.89M</div>
            <div class="metric-change">At 8% discount rate</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Recommended Price</div>
            <div class="metric-value success">£1.49M</div>
            <div class="metric-change positive">20% margin</div>
          </div>
        </div>

        <div class="content-grid">
          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">pie_chart</span>
                CapEx Breakdown
              </div>
            </div>

            <div class="cost-bar">
              <div class="cost-segment" style="width:45%;background:var(--accent)">Equipment</div>
              <div class="cost-segment" style="width:25%;background:var(--accent2)">Install</div>
              <div class="cost-segment" style="width:15%;background:var(--accent3)">Controls</div>
              <div class="cost-segment" style="width:15%;background:var(--warning)">Other</div>
            </div>

            <div class="cost-legend">
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--accent)"></div>
                <span>Equipment £558K</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--accent2)"></div>
                <span>Installation £310K</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--accent3)"></div>
                <span>Controls £186K</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--warning)"></div>
                <span>Other £186K</span>
              </div>
            </div>
          </div>

          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">trending_up</span>
                OpEx Projection (10yr)
              </div>
            </div>

            <div id="opex-chart" style="height:200px;display:flex;align-items:flex-end;gap:8px;padding:20px 0">
              <!-- Simple bar chart -->
            </div>

            <div class="cost-legend" style="margin-top:16px">
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--accent)"></div>
                <span>Energy (42%)</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--accent2)"></div>
                <span>Chemicals (28%)</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--warning)"></div>
                <span>Maintenance (18%)</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--muted)"></div>
                <span>Labor (12%)</span>
              </div>
            </div>
          </div>

          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">sell</span>
                Pricing Strategy
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Contract Model</label>
              <div class="chip-group">
                <div class="chip active">CapEx Sale</div>
                <div class="chip">BOO</div>
                <div class="chip">BOT</div>
                <div class="chip">Service</div>
              </div>
            </div>

            <div class="range-group">
              <div class="range-header">
                <span class="range-label">Target Margin</span>
                <span class="range-value">20%</span>
              </div>
              <input type="range" value="20" min="10" max="40">
            </div>

            <div style="padding:12px;background:rgba(99,102,241,0.1);border-radius:10px;border:1px solid rgba(99,102,241,0.3)">
              <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Win Probability Model</div>
              <div style="font-size:18px;font-weight:700;color:var(--accent)">72% @ £1.49M</div>
              <div style="font-size:11px;color:var(--muted)">Based on segment history + competitive positioning</div>
            </div>
          </div>

          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">analytics</span>
                Component Pricing
              </div>
            </div>

            <table class="solution-table" style="font-size:12px">
              <thead>
                <tr>
                  <th>Component</th>
                  <th>Base Cost (£)</th>
                  <th>Marked Up (£)</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>RO System with Pretreatment 5µm Filter</td>
                  <td>£15,954</td>
                  <td>£20,740</td>
                </tr>
                <tr>
                  <td>Universal Unit for Flushing with Permeate</td>
                  <td>£700</td>
                  <td>£910</td>
                </tr>
                <tr>
                  <td>RO Membranes</td>
                  <td>£4,140</td>
                  <td>£5,382</td>
                </tr>
                <tr>
                  <td>Hardness - Anti Scale Dosing</td>
                  <td>£1,400</td>
                  <td>£1,820</td>
                </tr>
                <tr>
                  <td>CIP System</td>
                  <td>£4,716</td>
                  <td>£6,131</td>
                </tr>
                <tr>
                  <td>Container</td>
                  <td>£5,500</td>
                  <td>£7,150</td>
                </tr>
                <tr>
                  <td>Pipework</td>
                  <td>£9,000</td>
                  <td>£11,700</td>
                </tr>
                <tr>
                  <td>Labour</td>
                  <td>£10,000</td>
                  <td>£13,000</td>
                </tr>
                <tr>
                  <td>Shipping</td>
                  <td>£1,500</td>
                  <td>£1,950</td>
                </tr>
                <tr>
                  <td>pH Adjustment - Dosing</td>
                  <td>£1,400</td>
                  <td>£1,820</td>
                </tr>
                <tr style="background:rgba(99,102,241,0.08)">
                  <td><strong>Base Total</strong></td>
                  <td><strong>£54,310</strong></td>
                  <td><strong>£70,603</strong></td>
                </tr>
              </tbody>
            </table>

            <div style="margin-top:16px;padding:12px;background:rgba(34,211,238,0.1);border-radius:10px;border:1px solid rgba(34,211,238,0.3)">
              <div style="font-size:11px;color:var(--muted);margin-bottom:8px">Pricing Summary</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
                <div>Base Manufacturing Cost:</div><div style="text-align:right;font-weight:600">£70,603.00</div>
                <div>Workshop (5%):</div><div style="text-align:right">£3,530.15</div>
                <div>Contingency (5%):</div><div style="text-align:right">£3,530.15</div>
                <div>Social Impact (2%):</div><div style="text-align:right">£1,412.06</div>
                <div style="border-top:1px solid var(--line);padding-top:8px"><strong>Subtotal:</strong></div>
                <div style="border-top:1px solid var(--line);padding-top:8px;text-align:right"><strong>£79,075.36</strong></div>
                <div style="color:var(--success)">Estimated GM:</div><div style="text-align:right;color:var(--success);font-weight:600">31%</div>
                <div style="color:var(--accent)">Estimated GP:</div><div style="text-align:right;color:var(--accent);font-weight:600">£24,765.36</div>
              </div>
            </div>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" onclick="goToStep(2)">
            <span class="material-icons-outlined">arrow_back</span>
            Back to Solution Design
          </button>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
            <button class="btn btn-primary" onclick="goToStep(4)">
              Continue to ESG Analysis
              <span class="material-icons-outlined">arrow_forward</span>
            </button>
          </div>
        </div>
        </div><!-- End Step 3: Pricing -->

        <!-- Step 4: ESG -->
        <div class="step-content" id="step-esg">
        <div class="workflow-header">
          <h1 class="workflow-title">ESG Optimization</h1>
          <p class="workflow-subtitle">Environmental, Social, and Governance analysis</p>
        </div>

        <div class="content-grid">
          <div class="content-panel full-width">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">speed</span>
                ESG Performance Dashboard
              </div>
            </div>

            <div class="esg-gauges">
              <div class="esg-gauge water">
                <div class="gauge-ring">
                  <svg viewBox="0 0 80 80">
                    <circle class="gauge-bg" cx="40" cy="40" r="32"></circle>
                    <circle class="gauge-fill" cx="40" cy="40" r="32"
                            stroke-dasharray="201"
                            stroke-dashoffset="36"></circle>
                  </svg>
                  <div class="gauge-value" style="color:var(--esg-blue)">82%</div>
                </div>
                <div class="esg-label">Water Recovery</div>
                <div style="font-size:11px;color:var(--muted);margin-top:4px">
                  328K m³/yr saved
                </div>
              </div>

              <div class="esg-gauge carbon">
                <div class="gauge-ring">
                  <svg viewBox="0 0 80 80">
                    <circle class="gauge-bg" cx="40" cy="40" r="32"></circle>
                    <circle class="gauge-fill" cx="40" cy="40" r="32"
                            stroke-dasharray="201"
                            stroke-dashoffset="50"></circle>
                  </svg>
                  <div class="gauge-value" style="color:var(--esg-green)">75%</div>
                </div>
                <div class="esg-label">Carbon Reduction</div>
                <div style="font-size:11px;color:var(--muted);margin-top:4px">
                  1,240 tCO₂e/yr avoided
                </div>
              </div>

              <div class="esg-gauge energy">
                <div class="gauge-ring">
                  <svg viewBox="0 0 80 80">
                    <circle class="gauge-bg" cx="40" cy="40" r="32"></circle>
                    <circle class="gauge-fill" cx="40" cy="40" r="32"
                            stroke-dasharray="201"
                            stroke-dashoffset="42"></circle>
                  </svg>
                  <div class="gauge-value" style="color:var(--esg-purple)">79%</div>
                </div>
                <div class="esg-label">Energy Efficiency</div>
                <div style="font-size:11px;color:var(--muted);margin-top:4px">
                  2.9 kWh/m³ vs 4.5 baseline
                </div>
              </div>
            </div>
          </div>

          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">balance</span>
                ESG Priority Weights
              </div>
            </div>

            <div class="range-group">
              <div class="range-header">
                <span class="range-label">Water Stewardship</span>
                <span class="range-value">40%</span>
              </div>
              <input type="range" value="40" min="0" max="100">
            </div>
            <div class="range-group">
              <div class="range-header">
                <span class="range-label">Carbon Footprint</span>
                <span class="range-value">35%</span>
              </div>
              <input type="range" value="35" min="0" max="100">
            </div>
            <div class="range-group">
              <div class="range-header">
                <span class="range-label">Energy Intensity</span>
                <span class="range-value">25%</span>
              </div>
              <input type="range" value="25" min="0" max="100">
            </div>

            <button class="btn btn-secondary" style="width:100%;margin-top:16px">
              <span class="material-icons-outlined">refresh</span>
              Recalculate with New Weights
            </button>
          </div>

          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">verified</span>
                ESG Compliance
              </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:10px">
              <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(34,197,94,0.1);border-radius:8px;border:1px solid rgba(34,197,94,0.3)">
                <span class="material-icons-outlined" style="color:var(--success)">check_circle</span>
                <span style="font-size:12px">ISO 14001 Aligned</span>
              </div>
              <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(34,197,94,0.1);border-radius:8px;border:1px solid rgba(34,197,94,0.3)">
                <span class="material-icons-outlined" style="color:var(--success)">check_circle</span>
                <span style="font-size:12px">GRI Standards Ready</span>
              </div>
              <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(34,197,94,0.1);border-radius:8px;border:1px solid rgba(34,197,94,0.3)">
                <span class="material-icons-outlined" style="color:var(--success)">check_circle</span>
                <span style="font-size:12px">CDP Water Security</span>
              </div>
              <div style="display:flex;align-items:center;gap:10px;padding:10px;background:rgba(245,158,11,0.1);border-radius:8px;border:1px solid rgba(245,158,11,0.3)">
                <span class="material-icons-outlined" style="color:var(--warning)">info</span>
                <span style="font-size:12px">SASB Metrics: Partial</span>
              </div>
            </div>
          </div>

          <div class="content-panel full-width">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">compare_arrows</span>
                Trade-off Analysis
              </div>
            </div>

            <p style="font-size:12px;color:var(--muted);margin-bottom:16px">
              Compare cost-optimized vs ESG-optimized solutions:
            </p>

            <table class="solution-table">
              <thead>
                <tr>
                  <th>Scenario</th>
                  <th>CapEx</th>
                  <th>OpEx/yr</th>
                  <th>Water Recovery</th>
                  <th>Carbon</th>
                  <th>ESG Score</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Cost Optimized</strong></td>
                  <td>£1.15M</td>
                  <td>£175K</td>
                  <td>78%</td>
                  <td>1,450 tCO₂e</td>
                  <td style="color:var(--warning)">68</td>
                </tr>
                <tr style="background:rgba(34,197,94,0.08)">
                  <td><strong>Balanced (Selected)</strong></td>
                  <td>£1.24M</td>
                  <td>£185K</td>
                  <td>82%</td>
                  <td>1,240 tCO₂e</td>
                  <td style="color:var(--esg-green)">85</td>
                </tr>
                <tr>
                  <td><strong>ESG Maximized</strong></td>
                  <td>£1.45M</td>
                  <td>£165K</td>
                  <td>88%</td>
                  <td>980 tCO₂e</td>
                  <td style="color:var(--success)">94</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" onclick="goToStep(3)">
            <span class="material-icons-outlined">arrow_back</span>
            Back to Pricing
          </button>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
            <button class="btn btn-primary" onclick="goToStep(5)">
              Continue to Generate
              <span class="material-icons-outlined">arrow_forward</span>
            </button>
          </div>
        </div>
        </div><!-- End Step 4: ESG -->

        <!-- Step 5: Generate -->
        <div class="step-content" id="step-generate">
        <div class="workflow-header">
          <h1 class="workflow-title">Generate Proposal</h1>
          <p class="workflow-subtitle">Review and export your complete technical and commercial proposal</p>
        </div>

        <div class="content-grid">
          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">checklist</span>
                Pre-flight Checklist
              </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:10px">
              <div style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
                <span class="material-icons-outlined" style="color:var(--success);font-size:20px">check_circle</span>
                <div>
                  <div style="font-size:13px;font-weight:600">Customer Requirements</div>
                  <div style="font-size:11px;color:var(--muted)">All specifications captured</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
                <span class="material-icons-outlined" style="color:var(--success);font-size:20px">check_circle</span>
                <div>
                  <div style="font-size:13px;font-weight:600">Technical Solution</div>
                  <div style="font-size:11px;color:var(--muted)">UF + RO + UV train validated (89% confidence)</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
                <span class="material-icons-outlined" style="color:var(--success);font-size:20px">check_circle</span>
                <div>
                  <div style="font-size:13px;font-weight:600">Pricing Complete</div>
                  <div style="font-size:11px;color:var(--muted)">CapEx: £1.49M | OpEx: £185K/yr</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
                <span class="material-icons-outlined" style="color:var(--success);font-size:20px">check_circle</span>
                <div>
                  <div style="font-size:13px;font-weight:600">ESG Analysis</div>
                  <div style="font-size:11px;color:var(--muted)">Score: 85/100 | Carbon: 1,240 tCO₂e avoided</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(99,102,241,0.1);border-radius:10px;border:1px solid rgba(99,102,241,0.3)">
                <span class="material-icons-outlined" style="color:var(--accent);font-size:20px">info</span>
                <div>
                  <div style="font-size:13px;font-weight:600">Engineer Override</div>
                  <div style="font-size:11px;color:var(--muted)">No manual overrides applied</div>
                </div>
              </div>
            </div>
          </div>

          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">download</span>
                Export Options
              </div>
            </div>

            <div style="display:flex;flex-direction:column;gap:12px">
              <button class="btn btn-primary" style="width:100%;justify-content:center;padding:14px" onclick="exportProposal('pdf')">
                <span class="material-icons-outlined">picture_as_pdf</span>
                Export as PDF
              </button>
              <button class="btn btn-secondary" style="width:100%;justify-content:center;padding:14px" onclick="exportProposal('word')">
                <span class="material-icons-outlined">description</span>
                Export as Word Document
              </button>
              <button class="btn btn-secondary" style="width:100%;justify-content:center;padding:14px" onclick="exportProposal('json')">
                <span class="material-icons-outlined">data_object</span>
                Export as JSON (API)
              </button>
              <button class="btn btn-secondary" style="width:100%;justify-content:center;padding:14px" onclick="exportProposal('email')">
                <span class="material-icons-outlined">email</span>
                Send via Email
              </button>
            </div>

            <div style="margin-top:20px;padding:16px;background:rgba(0,0,0,0.2);border-radius:12px">
              <div style="font-size:12px;color:var(--muted);margin-bottom:8px">Template Selection</div>
              <select class="form-input">
                <option>MembraCon Standard Template</option>
                <option>Technical Detail Template</option>
                <option>Executive Summary Only</option>
                <option>ESG-Focused Template</option>
              </select>
            </div>
          </div>

          <div class="content-panel full-width">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">preview</span>
                Proposal Preview
              </div>
              <div style="display:flex;gap:8px">
                <button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">
                  <span class="material-icons-outlined" style="font-size:14px">edit</span>
                  Edit
                </button>
                <button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">
                  <span class="material-icons-outlined" style="font-size:14px">fullscreen</span>
                  Full Screen
                </button>
              </div>
            </div>

            <div class="proposal-preview">
              <div style="text-align:center;margin-bottom:24px">
                <div style="font-size:28px;font-weight:700;color:#1e40af">MembraCon</div>
                <div style="font-size:14px;color:#6b7280">Water Treatment Solutions</div>
              </div>

              <h1>Technical Proposal</h1>
              <p style="color:#6b7280">
                <strong>Client:</strong> Riverside Pharmaceuticals Ltd<br>
                <strong>Reference:</strong> PROP-2026-00142<br>
                <strong>Date:</strong> 21 January 2026
              </p>

              <h2>Executive Summary</h2>
              <p>
                Based on your requirements for <strong>200 m³/h</strong> purified water production,
                we propose a comprehensive <strong>UF + RO + UV</strong> treatment system.
                This solution achieves pharmaceutical-grade water quality with 99.3% TDS rejection
                and validated disinfection, while maintaining excellent water recovery of 82%.
              </p>
              <p>
                The proposed system offers a compelling ESG profile with 1,240 tonnes CO₂e annual
                carbon savings and industry-leading energy efficiency at 2.9 kWh/m³.
              </p>

              <h2>Technical Solution</h2>
              <table>
                <tr>
                  <th>Stage</th>
                  <th>Technology</th>
                  <th>Function</th>
                  <th>Vendor</th>
                </tr>
                <tr>
                  <td>1</td>
                  <td>Ultrafiltration (UF)</td>
                  <td>Pre-treatment, particle removal</td>
                  <td>Pentair X-Flow</td>
                </tr>
                <tr>
                  <td>2</td>
                  <td>Reverse Osmosis (RO)</td>
                  <td>Desalination, demineralization</td>
                  <td>Dow FilmTec BW30</td>
                </tr>
                <tr>
                  <td>3</td>
                  <td>UV Disinfection</td>
                  <td>Validated pathogen inactivation</td>
                  <td>Trojan UV Swift</td>
                </tr>
              </table>

              <h2>Water Quality Performance</h2>
              <table>
                <tr>
                  <th>Parameter</th>
                  <th>Feed Water</th>
                  <th>Target</th>
                  <th>Guaranteed</th>
                </tr>
                <tr>
                  <td>TDS (mg/L)</td>
                  <td>1,500</td>
                  <td>&lt;10</td>
                  <td style="color:#16a34a;font-weight:600">&lt;10</td>
                </tr>
                <tr>
                  <td>TSS (mg/L)</td>
                  <td>50</td>
                  <td>&lt;0.1</td>
                  <td style="color:#16a34a;font-weight:600">&lt;0.1</td>
                </tr>
                <tr>
                  <td>BOD (mg/L)</td>
                  <td>120</td>
                  <td>&lt;1</td>
                  <td style="color:#16a34a;font-weight:600">&lt;1</td>
                </tr>
              </table>

              <h2>Commercial Summary</h2>
              <table>
                <tr>
                  <td style="width:70%">Capital Investment (CapEx)</td>
                  <td style="font-size:18px;font-weight:700;color:#1e40af">£1,490,000</td>
                </tr>
                <tr>
                  <td>Annual Operating Cost (OpEx)</td>
                  <td style="font-weight:600">£185,000</td>
                </tr>
                <tr>
                  <td>10-Year Total Cost of Ownership</td>
                  <td style="font-weight:600">£2,890,000</td>
                </tr>
                <tr>
                  <td>Estimated Payback Period</td>
                  <td style="font-weight:600">3.2 years</td>
                </tr>
              </table>

              <h2>ESG Impact</h2>
              <table>
                <tr>
                  <th>Metric</th>
                  <th>Value</th>
                  <th>Benchmark</th>
                </tr>
                <tr>
                  <td>Water Recovery</td>
                  <td>82%</td>
                  <td style="color:#16a34a">Above industry avg (75%)</td>
                </tr>
                <tr>
                  <td>Carbon Reduction</td>
                  <td>1,240 tCO₂e/yr</td>
                  <td style="color:#16a34a">75% vs baseline</td>
                </tr>
                <tr>
                  <td>Energy Efficiency</td>
                  <td>2.9 kWh/m³</td>
                  <td style="color:#16a34a">36% better than baseline</td>
                </tr>
                <tr style="background:#dbeafe">
                  <td><strong>Overall ESG Score</strong></td>
                  <td colspan="2"><strong style="font-size:18px;color:#1e40af">85/100</strong></td>
                </tr>
              </table>

              <div style="margin-top:32px;padding:16px;background:#f0fdf4;border-radius:8px;border:1px solid #86efac">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                  <span style="color:#16a34a;font-size:20px">&#10003;</span>
                  <strong style="color:#166534">AI Confidence: 89%</strong>
                </div>
                <p style="margin:0;font-size:13px;color:#166534">
                  This proposal was generated by the MembraCon WaterLogic AI system with high confidence.
                  All technical parameters have been validated against industry standards and historical performance data.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" onclick="goToStep(4)">
            <span class="material-icons-outlined">arrow_back</span>
            Back to ESG
          </button>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="saveDraft()">
              <span class="material-icons-outlined">save</span>
              Save to Projects
            </button>
            <button class="btn btn-success" onclick="finalizeProposal()">
              <span class="material-icons-outlined">send</span>
              Finalize & Send
            </button>
          </div>
        </div>
        </div><!-- End Step 5: Generate -->

      </div><!-- End view-proposal -->

      <!-- Projects View -->
      <div class="view" id="view-projects">
        <div class="workflow-header">
          <h1 class="workflow-title">All Projects</h1>
          <p class="workflow-subtitle">Manage and track your proposal projects</p>
        </div>

        <div class="content-grid">
          <div class="content-panel full-width">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">folder_open</span>
                Project List
              </div>
              <button class="btn btn-primary" onclick="document.querySelector('[data-view=proposal]').click()">
                <span class="material-icons-outlined">add</span>
                New Proposal
              </button>
            </div>

            <table class="solution-table">
              <thead>
                <tr>
                  <th>Project Name</th>
                  <th>Client</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Value</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Riverside Pharma - Purified Water</strong></td>
                  <td>Riverside Pharmaceuticals</td>
                  <td><span class="project-stage stage-design">In Design</span></td>
                  <td>18 Jan 2026</td>
                  <td>£1.49M</td>
                  <td><button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">Open</button></td>
                </tr>
                <tr>
                  <td><strong>Nordic Foods - Wastewater</strong></td>
                  <td>Nordic Foods Ltd</td>
                  <td><span class="project-stage stage-pricing">Pricing</span></td>
                  <td>15 Jan 2026</td>
                  <td>£2.1M</td>
                  <td><button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">Open</button></td>
                </tr>
                <tr>
                  <td><strong>GreenEnergy - Cooling Tower</strong></td>
                  <td>GreenEnergy plc</td>
                  <td><span class="project-stage stage-proposal">Proposal Ready</span></td>
                  <td>10 Jan 2026</td>
                  <td>£3.2M</td>
                  <td><button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">Open</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Documentation View -->
      <div class="view" id="view-docs">
        <div class="workflow-header">
          <h1 class="workflow-title">System Architecture</h1>
          <p class="workflow-subtitle">Interactive visualization and documentation for the AI Proposal System</p>
        </div>

        <div class="content-grid">
          <div class="content-panel" style="cursor:pointer" onclick="window.open('ai-proposal-d3.html', '_blank')">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">hub</span>
                Decision Intelligence Network
              </div>
              <span class="material-icons-outlined" style="color:var(--accent)">open_in_new</span>
            </div>
            <div style="padding:20px;background:linear-gradient(135deg, rgba(99,102,241,0.1), rgba(34,211,238,0.08));border-radius:12px;margin-bottom:16px">
              <div style="display:flex;align-items:center;justify-content:center;gap:16px;flex-wrap:wrap">
                <div style="text-align:center">
                  <div style="font-size:28px;font-weight:700;color:var(--accent)">18</div>
                  <div style="font-size:11px;color:var(--muted)">Decision Nodes</div>
                </div>
                <div style="text-align:center">
                  <div style="font-size:28px;font-weight:700;color:var(--accent2)">26</div>
                  <div style="font-size:11px;color:var(--muted)">Data Flows</div>
                </div>
                <div style="text-align:center">
                  <div style="font-size:28px;font-weight:700;color:var(--accent3)">6</div>
                  <div style="font-size:11px;color:var(--muted)">Perspectives</div>
                </div>
              </div>
            </div>
            <p style="font-size:12px;color:var(--muted);margin:0">
              Interactive D3.js visualization showing the complete system architecture including inputs, core processing, governance, and learning agents.
            </p>
          </div>

          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">description</span>
                Documentation
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <a href="AI-PROPOSAL-SYSTEM.md" target="_blank" style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,0.15);border-radius:10px;border:1px solid var(--line);text-decoration:none;color:var(--text);transition:all 0.15s ease">
                <span class="material-icons-outlined" style="color:var(--accent)">article</span>
                <div style="flex:1">
                  <div style="font-size:13px;font-weight:600">System Overview</div>
                  <div style="font-size:11px;color:var(--muted)">Complete architecture documentation</div>
                </div>
                <span class="material-icons-outlined" style="font-size:16px;color:var(--muted)">chevron_right</span>
              </a>
              <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,0.15);border-radius:10px;border:1px solid var(--line)">
                <span class="material-icons-outlined" style="color:var(--accent2)">calculate</span>
                <div style="flex:1">
                  <div style="font-size:13px;font-weight:600">Mathematical Framework</div>
                  <div style="font-size:11px;color:var(--muted)">Equations & optimization models</div>
                </div>
                <span class="material-icons-outlined" style="font-size:16px;color:var(--muted)">chevron_right</span>
              </div>
              <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,0.15);border-radius:10px;border:1px solid var(--line)">
                <span class="material-icons-outlined" style="color:var(--warning)">science</span>
                <div style="flex:1">
                  <div style="font-size:13px;font-weight:600">Technology Catalog</div>
                  <div style="font-size:11px;color:var(--muted)">UF, MBR, RO, UV, AOP specs</div>
                </div>
                <span class="material-icons-outlined" style="font-size:16px;color:var(--muted)">chevron_right</span>
              </div>
              <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,0.15);border-radius:10px;border:1px solid var(--line)">
                <span class="material-icons-outlined" style="color:var(--esg-green)">eco</span>
                <div style="flex:1">
                  <div style="font-size:13px;font-weight:600">ESG Framework</div>
                  <div style="font-size:11px;color:var(--muted)">Sustainability metrics & reporting</div>
                </div>
                <span class="material-icons-outlined" style="font-size:16px;color:var(--muted)">chevron_right</span>
              </div>
            </div>
          </div>

          <div class="content-panel full-width">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">layers</span>
                System Components
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px">
              <div style="padding:16px;background:rgba(99,102,241,0.1);border-radius:12px;border:1px solid rgba(99,102,241,0.3)">
                <div style="font-size:13px;font-weight:700;color:var(--accent);margin-bottom:8px">Inputs Layer</div>
                <ul style="font-size:11px;color:var(--muted);margin:0;padding-left:16px;line-height:1.8">
                  <li>Customer Case Inputs</li>
                  <li>Existing Artifacts</li>
                  <li>Technology Catalog</li>
                  <li>Historical Context</li>
                  <li>ESG Framework</li>
                </ul>
              </div>
              <div style="padding:16px;background:rgba(168,85,247,0.1);border-radius:12px;border:1px solid rgba(168,85,247,0.3)">
                <div style="font-size:13px;font-weight:700;color:var(--accent3);margin-bottom:8px">Core Processing</div>
                <ul style="font-size:11px;color:var(--muted);margin:0;padding-left:16px;line-height:1.8">
                  <li>Knowledge Graph</li>
                  <li>Decision Nodes</li>
                  <li>Simulators</li>
                  <li>AI Engine</li>
                  <li>Pricing & ESG</li>
                </ul>
              </div>
              <div style="padding:16px;background:rgba(245,158,11,0.1);border-radius:12px;border:1px solid rgba(245,158,11,0.3)">
                <div style="font-size:13px;font-weight:700;color:var(--warning);margin-bottom:8px">Governance</div>
                <ul style="font-size:11px;color:var(--muted);margin:0;padding-left:16px;line-height:1.8">
                  <li>Decision Ledger</li>
                  <li>Policy Enforcement</li>
                  <li>Approval Workflows</li>
                  <li>Audit Trail</li>
                  <li>Compliance Checks</li>
                </ul>
              </div>
              <div style="padding:16px;background:rgba(34,211,238,0.1);border-radius:12px;border:1px solid rgba(34,211,238,0.3)">
                <div style="font-size:13px;font-weight:700;color:var(--accent2);margin-bottom:8px">Learning Agents</div>
                <ul style="font-size:11px;color:var(--muted);margin:0;padding-left:16px;line-height:1.8">
                  <li>Win/Loss Agent</li>
                  <li>Pricing Agent</li>
                  <li>Tech Performance</li>
                  <li>ESG Tracking</li>
                  <li>Knowledge Ingestion</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Keyboard Mode Help Bar -->
  <div class="keyboard-mode-bar" id="keyboardModeBar">
    <span><kbd>Ctrl</kbd>+<kbd>K</kbd> Toggle Mode</span>
    <span class="separator"></span>
    <span><kbd>1</kbd>-<kbd>5</kbd> Steps</span>
    <span class="separator"></span>
    <span><kbd>←</kbd><kbd>→</kbd> Navigate</span>
    <span class="separator"></span>
    <span><kbd>Tab</kbd> Next Field</span>
    <span class="separator"></span>
    <span><kbd>Esc</kbd> Exit Mode</span>
    <span class="separator"></span>
    <span><kbd>N</kbd> Continue</span>
    <span class="separator"></span>
    <span><kbd>G</kbd> Save</span>
  </div>

  <script>
    // Theme Toggle
    function toggleTheme() {
      const html = document.documentElement;
      const themeIcon = document.getElementById('themeIcon');
      const currentTheme = html.getAttribute('data-theme');

      if (currentTheme === 'light') {
        html.removeAttribute('data-theme');
        themeIcon.textContent = 'light_mode';
        localStorage.setItem('theme', 'dark');
      } else {
        html.setAttribute('data-theme', 'light');
        themeIcon.textContent = 'dark_mode';
        localStorage.setItem('theme', 'light');
      }
    }

    // Load saved theme on page load
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const themeIcon = document.getElementById('themeIcon');
      if (savedTheme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        if (themeIcon) themeIcon.textContent = 'dark_mode';
      }
    })();

    // Keyboard Mode
    let keyboardModeActive = false;

    function toggleKeyboardMode() {
      keyboardModeActive = !keyboardModeActive;
      const html = document.documentElement;
      const keyboardIcon = document.getElementById('keyboardIcon');
      const keyboardToggle = document.getElementById('keyboardToggle');

      if (keyboardModeActive) {
        html.setAttribute('data-keyboard-mode', 'true');
        keyboardIcon.textContent = 'keyboard_hide';
        keyboardToggle.classList.add('keyboard-toggle');
        localStorage.setItem('keyboardMode', 'true');
        showNotification('keyboard', 'Keyboard mode ON - Press letter keys to focus fields', 'info');
      } else {
        html.removeAttribute('data-keyboard-mode');
        keyboardIcon.textContent = 'keyboard';
        keyboardToggle.classList.remove('keyboard-toggle');
        localStorage.setItem('keyboardMode', 'false');
      }
    }

    // Global keyboard event listener
    document.addEventListener('keydown', (e) => {
      // Don't trigger shortcuts when typing in inputs (unless Escape or Ctrl+K)
      const isTyping = document.activeElement.tagName === 'INPUT' ||
                       document.activeElement.tagName === 'TEXTAREA' ||
                       document.activeElement.tagName === 'SELECT';

      // Ctrl+K toggles keyboard mode
      if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        toggleKeyboardMode();
        return;
      }

      // Escape exits keyboard mode or blurs current input
      if (e.key === 'Escape') {
        if (isTyping) {
          document.activeElement.blur();
        } else if (keyboardModeActive) {
          toggleKeyboardMode();
        }
        return;
      }

      // If typing, only handle Tab normally
      if (isTyping) return;

      // Only process shortcuts in keyboard mode
      if (!keyboardModeActive) return;

      // Step navigation with number keys 1-5
      if (['1', '2', '3', '4', '5'].includes(e.key)) {
        e.preventDefault();
        goToStep(parseInt(e.key));
        return;
      }

      // Arrow keys for step navigation
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault();
        if (currentStep < totalSteps) goToStep(currentStep + 1);
        return;
      }

      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        if (currentStep > 1) goToStep(currentStep - 1);
        return;
      }

      // N = Next step (Continue)
      if (e.key === 'n' || e.key === 'N') {
        e.preventDefault();
        if (currentStep < totalSteps) goToStep(currentStep + 1);
        return;
      }

      // G = Save draft
      if (e.key === 'g' || e.key === 'G') {
        e.preventDefault();
        saveDraft();
        return;
      }

      // Focus input fields by shortcut key
      const shortcutInput = document.querySelector(`input[data-shortcut="${e.key.toLowerCase()}"]`);
      if (shortcutInput) {
        e.preventDefault();
        shortcutInput.focus();
        shortcutInput.select();
        return;
      }
    });

    // Load saved keyboard mode preference
    (function() {
      const savedKeyboardMode = localStorage.getItem('keyboardMode');
      if (savedKeyboardMode === 'true') {
        toggleKeyboardMode();
      }
    })();

    // Navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Update tabs
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update views
        const viewId = 'view-' + tab.dataset.view;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
      });
    });

    // Current step state
    let currentStep = 1;
    const totalSteps = 5;

    // Workflow steps - click to navigate
    document.querySelectorAll('.workflow-step').forEach(step => {
      step.addEventListener('click', () => {
        const stepNum = parseInt(step.dataset.step);
        goToStep(stepNum);
      });
    });

    // Go to specific step
    function goToStep(stepNum) {
      if (stepNum < 1 || stepNum > totalSteps) return;

      // Update current step
      currentStep = stepNum;

      // Update workflow step indicators
      document.querySelectorAll('.workflow-step').forEach(s => {
        const sNum = parseInt(s.dataset.step);
        s.classList.remove('active');
        if (sNum < stepNum) {
          s.classList.add('completed');
          s.querySelector('.step-icon').innerHTML = '<span class="material-icons-outlined">check</span>';
        } else if (sNum === stepNum) {
          s.classList.add('active');
          s.classList.remove('completed');
          // Restore original icon for active step
          const icons = {1:'input', 2:'architecture', 3:'calculate', 4:'eco', 5:'auto_awesome'};
          s.querySelector('.step-icon').innerHTML = `<span class="material-icons-outlined">${icons[sNum]}</span>`;
        } else {
          s.classList.remove('completed');
          // Restore original icon for future steps
          const icons = {1:'input', 2:'architecture', 3:'calculate', 4:'eco', 5:'auto_awesome'};
          s.querySelector('.step-icon').innerHTML = `<span class="material-icons-outlined">${icons[sNum]}</span>`;
        }
      });

      // Update step content visibility
      document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
      });

      const stepIds = ['step-intake', 'step-design', 'step-pricing', 'step-esg', 'step-generate'];
      const targetContent = document.getElementById(stepIds[stepNum - 1]);
      if (targetContent) {
        targetContent.classList.add('active');
      }

      // Update progress bar
      updateProgress(stepNum);

      // Scroll to top of content
      document.querySelector('.main-content').scrollTop = 0;
    }

    // Update progress indicators
    function updateProgress(stepNum) {
      const percent = (stepNum / totalSteps) * 100;
      const progressFill = document.getElementById('progressFill');
      const progressPercent = document.getElementById('progressPercent');
      const currentStepNum = document.getElementById('currentStepNum');

      if (progressFill) progressFill.style.width = percent + '%';
      if (progressPercent) progressPercent.textContent = Math.round(percent) + '%';
      if (currentStepNum) currentStepNum.textContent = stepNum;
    }

    // Previous step
    function prevStep() {
      if (currentStep > 1) {
        goToStep(currentStep - 1);
      }
    }

    // Save draft notification
    function saveDraft() {
      showNotification('save', 'Draft saved successfully!', 'success');
    }

    // Show notification
    function showNotification(icon, message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 16px 24px;
        background: ${type === 'success' ? 'var(--success)' : 'linear-gradient(135deg, var(--accent), var(--accent2))'};
        border-radius: 12px;
        color: #fff;
        font-size: 14px;
        font-weight: 500;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
      `;
      notification.innerHTML = `
        <span class="material-icons-outlined">${icon}</span>
        ${message}
      `;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 2500);
    }

    // Technology cards
    document.querySelectorAll('.tech-card').forEach(card => {
      card.addEventListener('click', () => {
        card.classList.toggle('selected');
        updateSolutionValidation();
      });
    });

    // Chips
    document.querySelectorAll('.chip').forEach(chip => {
      if (!chip.closest('.sidebar-section')) { // Don't toggle sidebar chips
        chip.addEventListener('click', () => {
          chip.classList.toggle('active');
        });
      }
    });

    // Range sliders
    document.querySelectorAll('input[type="range"]').forEach(slider => {
      slider.addEventListener('input', (e) => {
        const value = e.target.value;
        const label = e.target.parentElement.querySelector('.range-value');
        if (label) label.textContent = value + '%';
      });
    });

    function updateSolutionValidation() {
      const selected = document.querySelectorAll('.tech-card.selected').length;
      // Update validation message based on selection
    }

    // Initialize OpEx chart
    function initOpexChart() {
      const container = document.getElementById('opex-chart');
      if (!container) return;

      const years = [185, 191, 197, 203, 209, 215, 222, 229, 236, 243];
      const maxVal = Math.max(...years);

      container.innerHTML = '';
      years.forEach((val, i) => {
        const bar = document.createElement('div');
        bar.style.cssText = `
          flex: 1;
          background: linear-gradient(180deg, var(--accent), var(--accent2));
          border-radius: 4px 4px 0 0;
          height: ${(val / maxVal) * 100}%;
          position: relative;
          transition: all 0.3s ease;
        `;
        bar.title = `Year ${i + 1}: £${val}K`;

        // Add year label
        const label = document.createElement('div');
        label.style.cssText = `
          position: absolute;
          bottom: -20px;
          left: 50%;
          transform: translateX(-50%);
          font-size: 10px;
          color: var(--muted);
        `;
        label.textContent = `Y${i + 1}`;
        bar.appendChild(label);

        container.appendChild(bar);
      });
    }

    // Export proposal
    function exportProposal(format) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 16px 24px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        border-radius: 12px;
        color: #fff;
        font-size: 14px;
        font-weight: 500;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
      `;

      const icons = {
        pdf: 'picture_as_pdf',
        word: 'description',
        json: 'data_object',
        email: 'email'
      };

      const labels = {
        pdf: 'Generating PDF...',
        word: 'Creating Word document...',
        json: 'Exporting JSON data...',
        email: 'Opening email client...'
      };

      notification.innerHTML = `
        <span class="material-icons-outlined">${icons[format]}</span>
        ${labels[format]}
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.innerHTML = `
          <span class="material-icons-outlined">check_circle</span>
          Export complete!
        `;
        notification.style.background = 'var(--success)';

        setTimeout(() => {
          notification.remove();
        }, 2000);
      }, 1500);
    }

    // Finalize proposal
    function finalizeProposal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      `;

      modal.innerHTML = `
        <div style="
          background: var(--card);
          border: 1px solid var(--line);
          border-radius: 20px;
          padding: 32px;
          max-width: 480px;
          text-align: center;
          animation: slideIn 0.3s ease;
        ">
          <div style="
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--success), #16a34a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
          ">
            <span class="material-icons-outlined" style="font-size:32px;color:#fff">check</span>
          </div>
          <h2 style="font-size:20px;margin-bottom:12px">Proposal Finalized!</h2>
          <p style="font-size:14px;color:var(--muted);margin-bottom:24px">
            Your proposal has been saved and logged to the decision ledger.
            Reference: PROP-2026-00142
          </p>
          <div style="display:flex;gap:12px;justify-content:center">
            <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">
              Close
            </button>
            <button class="btn btn-primary" onclick="window.print()">
              <span class="material-icons-outlined">print</span>
              Print
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    // Step icons mapping
    const stepIcons = {
      1: 'input',
      2: 'architecture',
      3: 'calculate',
      4: 'eco',
      5: 'auto_awesome'
    };

    // Restore step icon
    function restoreStepIcon(stepNum) {
      const step = document.querySelector(`.workflow-step[data-step="${stepNum}"]`);
      if (step) {
        step.querySelector('.step-icon').innerHTML =
          `<span class="material-icons-outlined">${stepIcons[stepNum]}</span>`;
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      initOpexChart();

      // Initialize step 1 as active
      goToStep(1);

      // Simulate AI processing on step 2
      setTimeout(() => {
        const processing = document.querySelector('.ai-processing');
        if (processing) {
          processing.innerHTML = `
            <span class="material-icons-outlined" style="color:var(--success);font-size:24px">check_circle</span>
            <span class="ai-text" style="color:var(--success)">Optimization complete - 3 solutions ranked</span>
          `;
        }
      }, 3000);
    });
  </script>
</body>
</html>
