<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MembraCon WaterLogic - Intelligent Proposal System</title>

  <!-- D3 for visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

  <!-- Google Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet">

  <style>
    /* Dark Theme (Default) */
    :root {
      --bg: #0a0f1a;
      --panel: #0d1424;
      --card: #111b2e;
      --card-hover: #162035;
      --muted: #8fa3c0;
      --text: #e8f0ff;
      --line: #1e2d4a;
      --accent: #6366f1;
      --accent2: #22d3ee;
      --accent3: #a855f7;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --esg-green: #10b981;
      --esg-blue: #3b82f6;
      --esg-purple: #8b5cf6;
      --input-bg: rgba(0,0,0,0.2);
      --shadow: rgba(0,0,0,0.3);
    }

    /* Light Theme */
    [data-theme="light"] {
      --bg: #f5f7fa;
      --panel: #ffffff;
      --card: #ffffff;
      --card-hover: #f8fafc;
      --muted: #64748b;
      --text: #1e293b;
      --line: #e2e8f0;
      --accent: #4f46e5;
      --accent2: #0891b2;
      --accent3: #9333ea;
      --success: #16a34a;
      --warning: #d97706;
      --danger: #dc2626;
      --esg-green: #059669;
      --esg-blue: #2563eb;
      --esg-purple: #7c3aed;
      --input-bg: #f1f5f9;
      --shadow: rgba(0,0,0,0.08);
    }

    /* Light theme specific overrides */
    [data-theme="light"] .app-header {
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
      border-bottom-color: var(--line);
    }

    [data-theme="light"] .sidebar {
      background: var(--panel);
      box-shadow: 2px 0 8px var(--shadow);
    }

    [data-theme="light"] .content-panel {
      box-shadow: 0 1px 3px var(--shadow);
    }

    [data-theme="light"] .form-input {
      background: var(--input-bg);
      border-color: var(--line);
    }

    [data-theme="light"] .chip {
      background: var(--input-bg);
      border-color: var(--line);
    }

    [data-theme="light"] .tech-card {
      background: var(--input-bg);
    }

    [data-theme="light"] .workflow-step {
      background: var(--card);
      box-shadow: 0 1px 3px var(--shadow);
    }

    [data-theme="light"] .metric-card {
      box-shadow: 0 1px 3px var(--shadow);
    }

    [data-theme="light"] .solution-table th {
      background: var(--input-bg);
    }

    [data-theme="light"] .btn-secondary {
      background: var(--input-bg);
      border-color: var(--line);
    }

    [data-theme="light"] .btn-secondary:hover {
      background: #e2e8f0;
    }

    [data-theme="light"] .proposal-preview {
      box-shadow: 0 4px 12px var(--shadow);
    }

    [data-theme="light"] .override-panel {
      background: linear-gradient(135deg, rgba(245,158,11,0.05), rgba(239,68,68,0.03));
    }

    [data-theme="light"] .ai-processing {
      background: linear-gradient(135deg, rgba(79,70,229,0.08), rgba(147,51,234,0.05));
    }

    [data-theme="light"] .esg-gauge {
      background: var(--input-bg);
    }

    [data-theme="light"] .decision-item {
      background: var(--input-bg);
    }

    [data-theme="light"] .project-item {
      background: var(--input-bg);
    }

    [data-theme="light"] .nav-tab.active {
      background: linear-gradient(135deg, rgba(79,70,229,0.1), rgba(8,145,178,0.08));
    }

    [data-theme="light"] input[type="range"] {
      background: #cbd5e1;
    }

    [data-theme="light"] .gauge-bg {
      stroke: #e2e8f0;
    }

    [data-theme="light"] .sidebar-section {
      box-shadow: 0 1px 3px var(--shadow);
    }

    [data-theme="light"] .progress-bar-bg {
      background: #e2e8f0 !important;
    }

    [data-theme="light"] .logo-icon {
      box-shadow: 0 2px 8px rgba(79,70,229,0.25);
    }

    [data-theme="light"] .cost-segment {
      color: #fff;
    }

    [data-theme="light"] .confidence-bar {
      background: #e2e8f0;
    }

    /* Light theme reactive elements */
    [data-theme="light"] .reactive-alarm.critical {
      background: rgba(239,68,68,0.08);
      border-color: rgba(239,68,68,0.25);
    }

    [data-theme="light"] .reactive-alarm.warning {
      background: rgba(245,158,11,0.08);
      border-color: rgba(245,158,11,0.25);
    }

    [data-theme="light"] .suggestion-card.critical-card {
      background: rgba(239,68,68,0.05);
      border-color: rgba(239,68,68,0.25);
    }

    /* Smooth theme transition */
    * {
      transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }

    /* ==================== PERSONA SYSTEM ==================== */
    .persona-selector {
      display: flex;
      gap: 4px;
      margin-right: 16px;
      padding: 4px;
      background: var(--card);
      border-radius: 10px;
      border: 1px solid var(--line);
      transition: all 0.3s ease;
    }

    .persona-selector.hidden {
      display: none;
    }

    #personaToggle.has-filter {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
      border-color: transparent;
    }

    .persona-chip {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .persona-chip:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text);
    }

    .persona-chip.active {
      background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(34,211,238,0.15));
      color: var(--text);
      border: 1px solid rgba(99,102,241,0.3);
    }

    .persona-chip .material-icons-outlined {
      font-size: 14px;
    }

    [data-theme="light"] .persona-selector {
      background: var(--input-bg);
    }

    [data-theme="light"] .persona-chip:hover {
      background: rgba(0,0,0,0.05);
    }

    [data-theme="light"] .persona-chip.active {
      background: linear-gradient(135deg, rgba(79,70,229,0.15), rgba(8,145,178,0.1));
      border-color: rgba(79,70,229,0.3);
    }

    /* Persona visibility rules - exclude persona selector chips */
    [data-persona="technician"] [data-persona]:not([data-persona*="technician"]):not(.persona-chip) {
      display: none !important;
    }
    [data-persona="business"] [data-persona]:not([data-persona*="business"]):not(.persona-chip) {
      display: none !important;
    }
    [data-persona="sales"] [data-persona]:not([data-persona*="sales"]):not(.persona-chip) {
      display: none !important;
    }
    [data-persona="customer"] [data-persona]:not([data-persona*="customer"]):not(.persona-chip) {
      display: none !important;
    }

    /* Highlight key info for each persona */
    [data-persona="business"] [data-persona-key="business"],
    [data-persona="technician"] [data-persona-key="technician"],
    [data-persona="sales"] [data-persona-key="sales"],
    [data-persona="customer"] [data-persona-key="customer"] {
      border-color: var(--accent) !important;
      box-shadow: 0 0 0 2px rgba(99,102,241,0.2);
    }

    /* Persona indicator badge on panels */
    .persona-badge {
      display: none;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 3px 8px;
      border-radius: 4px;
      margin-left: auto;
    }

    [data-persona="technician"] .persona-badge.technician,
    [data-persona="business"] .persona-badge.business,
    [data-persona="sales"] .persona-badge.sales,
    [data-persona="customer"] .persona-badge.customer {
      display: inline-block;
    }

    .persona-badge.technician { background: rgba(34,211,238,0.2); color: var(--accent2); }
    .persona-badge.business { background: rgba(168,85,247,0.2); color: var(--accent3); }
    .persona-badge.sales { background: rgba(34,197,94,0.2); color: var(--success); }
    .persona-badge.customer { background: rgba(99,102,241,0.2); color: var(--accent); }

    /* Responsive persona selector */
    @media (max-width: 1200px) {
      .persona-chip span:not(.material-icons-outlined) {
        display: none;
      }
      .persona-chip {
        padding: 6px 8px;
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header */
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(180deg, rgba(13,20,36,0.98), rgba(13,20,36,0.95));
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      padding: 0 24px;
      z-index: 1000;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo-text {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.3px;
    }

    .logo-text span {
      color: var(--accent2);
    }

    .nav-tabs {
      display: flex;
      gap: 4px;
      margin-left: 40px;
    }

    .nav-tab {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--muted);
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid transparent;
    }

    .nav-tab:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text);
    }

    .nav-tab.active {
      background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(34,211,238,0.1));
      border-color: rgba(99,102,241,0.3);
      color: var(--text);
    }

    .nav-tab .material-icons-outlined {
      font-size: 18px;
    }

    .header-spacer { flex: 1; }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent3), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    /* Theme Toggle */
    .theme-toggle {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--card);
      border: 1px solid var(--line);
      color: var(--muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .theme-toggle:hover {
      background: var(--card-hover);
      color: var(--text);
      border-color: var(--accent);
    }

    .theme-toggle .material-icons-outlined {
      font-size: 20px;
    }

    [data-theme="light"] .theme-toggle {
      background: var(--input-bg);
    }

    /* Keyboard Mode */
    [data-keyboard-mode="true"] .keyboard-toggle {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }

    .shortcut-badge {
      display: none;
      position: absolute;
      top: -8px;
      right: -8px;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      border-radius: 4px;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      z-index: 10;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    [data-keyboard-mode="true"] .shortcut-badge {
      display: flex;
    }

    .has-shortcut {
      position: relative;
    }

    /* Keyboard mode indicator */
    .keyboard-mode-bar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
      background: var(--accent);
      color: #fff;
      font-size: 12px;
      font-weight: 500;
      align-items: center;
      justify-content: center;
      gap: 24px;
      z-index: 9999;
    }

    [data-keyboard-mode="true"] .keyboard-mode-bar {
      display: flex;
    }

    .keyboard-mode-bar kbd {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 22px;
      padding: 0 6px;
      background: rgba(255,255,255,0.2);
      border-radius: 4px;
      font-family: inherit;
      font-size: 11px;
      font-weight: 600;
    }

    .keyboard-mode-bar .separator {
      width: 1px;
      height: 20px;
      background: rgba(255,255,255,0.3);
    }

    /* Highlight focused element in keyboard mode */
    [data-keyboard-mode="true"] .form-input:focus,
    [data-keyboard-mode="true"] select:focus {
      box-shadow: 0 0 0 3px var(--accent), 0 0 20px rgba(99,102,241,0.4);
    }

    [data-keyboard-mode="true"] .chip:focus,
    [data-keyboard-mode="true"] .workflow-step:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    /* Input label shortcut indicator */
    .input-label .shortcut-key {
      display: none;
      margin-left: 4px;
      padding: 1px 4px;
      background: var(--accent);
      color: #fff;
      font-size: 9px;
      font-weight: 700;
      border-radius: 3px;
    }

    [data-keyboard-mode="true"] .input-label .shortcut-key {
      display: inline;
    }

    /* Workflow step shortcuts */
    [data-keyboard-mode="true"] .workflow-step::before {
      content: attr(data-shortcut);
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%);
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: var(--accent);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .workflow-step {
      position: relative;
    }

    /* Hide step shortcut when not in keyboard mode */
    .workflow-step::before {
      display: none;
    }

    [data-keyboard-mode="true"] .workflow-step::before {
      display: flex;
    }

    /* Main Layout */
    .app-container {
      margin-top: 60px;
      display: flex;
      min-height: calc(100vh - 60px);
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--panel);
      border-right: 1px solid var(--line);
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .sidebar-section {
      background: var(--card);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--line);
    }

    .sidebar-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--muted);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-title .material-icons-outlined {
      font-size: 16px;
    }

    /* Project Status */
    .project-item {
      padding: 12px;
      border-radius: 10px;
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--line);
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .project-item:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(99,102,241,0.3);
    }

    .project-item.active {
      border-color: var(--accent);
      background: rgba(99,102,241,0.08);
    }

    .project-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .project-meta {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      gap: 10px;
    }

    .project-stage {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      margin-top: 8px;
    }

    .stage-intake { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .stage-design { background: rgba(168,85,247,0.2); color: #c084fc; }
    .stage-pricing { background: rgba(245,158,11,0.2); color: #fbbf24; }
    .stage-proposal { background: rgba(34,197,94,0.2); color: #4ade80; }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    /* View Container */
    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    /* Step Content */
    .step-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .step-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Workflow Steps */
    .workflow-header {
      margin-bottom: 24px;
    }

    .workflow-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .workflow-subtitle {
      font-size: 14px;
      color: var(--muted);
    }

    .workflow-steps {
      display: flex;
      gap: 8px;
      margin-bottom: 32px;
    }

    .workflow-step {
      flex: 1;
      padding: 14px 16px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }

    .workflow-step::after {
      content: '';
      position: absolute;
      right: -14px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      border-right: 2px solid var(--line);
      border-top: 2px solid var(--line);
      transform: translateY(-50%) rotate(45deg);
    }

    .workflow-step:last-child::after {
      display: none;
    }

    .workflow-step:hover {
      border-color: rgba(99,102,241,0.4);
    }

    .workflow-step.active {
      background: linear-gradient(135deg, rgba(99,102,241,0.12), rgba(34,211,238,0.08));
      border-color: var(--accent);
    }

    .workflow-step.completed {
      border-color: var(--success);
    }

    .workflow-step.completed .step-icon {
      background: var(--success);
    }

    .step-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }

    .step-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--line);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .workflow-step.active .step-icon {
      background: var(--accent);
    }

    .step-name {
      font-size: 13px;
      font-weight: 600;
    }

    .step-desc {
      font-size: 11px;
      color: var(--muted);
      padding-left: 38px;
    }

    /* Content Panels */
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .content-grid.three-cols {
      grid-template-columns: 1fr 1fr 1fr;
    }

    .content-panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
    }

    .content-panel.full-width {
      grid-column: 1 / -1;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .panel-title {
      font-size: 14px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-title .material-icons-outlined {
      font-size: 20px;
      color: var(--accent);
    }

    .panel-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(99,102,241,0.15);
      color: var(--accent);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      padding: 10px 14px;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--line);
      border-radius: 10px;
      color: var(--text);
      font-size: 13px;
      transition: all 0.15s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(99,102,241,0.15);
    }

    .form-input::placeholder {
      color: rgba(143,163,192,0.5);
    }

    select.form-input {
      cursor: pointer;
    }

    /* Input Field with Label */
    .input-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .input-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    [data-theme="light"] .input-label {
      color: #475569;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .form-row.three-cols {
      grid-template-columns: 1fr 1fr 1fr;
    }

    /* Range Slider */
    .range-group {
      margin-bottom: 16px;
    }

    .range-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .range-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
    }

    .range-value {
      font-size: 12px;
      font-weight: 600;
      color: var(--accent2);
    }

    input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: var(--line);
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(99,102,241,0.4);
    }

    /* Toggle Chips */
    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      padding: 8px 14px;
      border-radius: 8px;
      background: rgba(0,0,0,0.2);
      border: 1px solid var(--line);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chip:hover {
      border-color: rgba(99,102,241,0.4);
      background: rgba(99,102,241,0.08);
    }

    .chip.active {
      background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(34,211,238,0.15));
      border-color: var(--accent);
      color: var(--text);
    }

    .chip .material-icons-outlined {
      font-size: 16px;
    }

    /* Technology Cards */
    .tech-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .tech-card {
      padding: 16px;
      background: rgba(0,0,0,0.15);
      border: 1px solid var(--line);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }

    .tech-card:hover {
      border-color: rgba(99,102,241,0.4);
      background: rgba(99,102,241,0.05);
    }

    .tech-card.selected {
      border-color: var(--accent);
      background: linear-gradient(135deg, rgba(99,102,241,0.12), rgba(34,211,238,0.08));
    }

    .tech-card.recommended::before {
      content: 'Recommended';
      position: absolute;
      top: -8px;
      right: 12px;
      padding: 3px 8px;
      background: var(--success);
      color: #000;
      font-size: 9px;
      font-weight: 700;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .tech-name {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .tech-full {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .tech-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .tech-stat {
      font-size: 10px;
      color: var(--muted);
    }

    .tech-stat-value {
      font-weight: 600;
      color: var(--accent2);
    }

    /* Solution View Toggle */
    .solution-view-toggle {
      display: flex;
      gap: 4px;
      margin-left: auto;
      padding: 3px;
      background: var(--card);
      border-radius: 8px;
      border: 1px solid var(--line);
    }

    .view-toggle-btn {
      width: 32px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--muted);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .view-toggle-btn:hover {
      background: rgba(99,102,241,0.1);
      color: var(--text);
    }

    .view-toggle-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: white;
    }

    .view-toggle-btn .material-icons-outlined {
      font-size: 16px;
    }

    .solution-view {
      display: none;
    }

    .solution-view.active {
      display: block;
    }

    /* Decision Tree Styles */
    .decision-tree-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--accent2);
      margin-bottom: 8px;
    }

    .decision-tree-header .material-icons-outlined {
      font-size: 18px;
    }

    .tree-scenarios {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .scenario-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--line);
      border-radius: 6px;
      color: var(--muted);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .scenario-btn:hover {
      background: rgba(0,212,170,0.1);
      border-color: rgba(0,212,170,0.3);
      color: var(--text);
    }

    .scenario-btn.active {
      background: rgba(0,212,170,0.15);
      border-color: #00d4aa;
      color: #00d4aa;
    }

    .decision-tree-svg {
      width: 100%;
      height: 340px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      border: 1px solid var(--line);
      overflow: hidden;
    }

    .decision-tree-svg svg {
      width: 100%;
      height: 100%;
    }

    .tree-legend {
      display: flex;
      gap: 20px;
      margin-top: 12px;
      padding: 10px;
      background: rgba(0,0,0,0.15);
      border-radius: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-dot.recommended { background: #00d4aa; }
    .legend-dot.decision { background: #7c5cff; }
    .legend-dot.technology { background: #ffa500; }

    /* Decision Tree Node Styles */
    .decision-node { cursor: pointer; }
    .decision-node:hover .node-circle { filter: brightness(1.2); }
    .tree-link { fill: none; stroke-width: 2; }

    [data-theme="light"] .decision-tree-svg {
      background: rgba(0,0,0,0.03);
    }

    [data-theme="light"] .tree-legend {
      background: rgba(0,0,0,0.05);
    }

    [data-theme="light"] .scenario-btn {
      background: rgba(0,0,0,0.03);
    }

    /* Metrics Cards */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 16px;
    }

    .metric-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .metric-value.accent { color: var(--accent); }
    .metric-value.success { color: var(--success); }
    .metric-value.warning { color: var(--warning); }
    .metric-value.accent2 { color: var(--accent2); }

    .metric-change {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .metric-change.positive { color: var(--success); }
    .metric-change.negative { color: var(--danger); }

    /* Solution Comparison */
    .solution-table {
      width: 100%;
      border-collapse: collapse;
    }

    .solution-table th,
    .solution-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--line);
    }

    .solution-table th {
      font-size: 11px;
      font-weight: 700;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: rgba(0,0,0,0.2);
    }

    .solution-table td {
      font-size: 13px;
    }

    .solution-table tr:hover td {
      background: rgba(99,102,241,0.05);
    }

    .solution-rank {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
    }

    .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
    .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: #000; }
    .rank-3 { background: linear-gradient(135deg, #c2855a, #a16941); color: #fff; }

    .confidence-bar {
      width: 100px;
      height: 6px;
      background: var(--line);
      border-radius: 3px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .confidence-high { background: var(--success); }
    .confidence-medium { background: var(--warning); }
    .confidence-low { background: var(--danger); }

    /* ESG Gauge */
    .esg-gauges {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .esg-gauge {
      text-align: center;
      padding: 20px;
      background: rgba(0,0,0,0.15);
      border-radius: 12px;
      border: 1px solid var(--line);
    }

    .gauge-ring {
      width: 80px;
      height: 80px;
      margin: 0 auto 12px;
      position: relative;
    }

    .gauge-ring svg {
      transform: rotate(-90deg);
    }

    .gauge-ring circle {
      fill: none;
      stroke-width: 8;
    }

    .gauge-bg { stroke: var(--line); }
    .gauge-fill { stroke-linecap: round; transition: stroke-dashoffset 0.5s ease; }

    .gauge-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      font-weight: 700;
    }

    .esg-gauge.water .gauge-fill { stroke: var(--esg-blue); }
    .esg-gauge.carbon .gauge-fill { stroke: var(--esg-green); }
    .esg-gauge.energy .gauge-fill { stroke: var(--esg-purple); }

    .esg-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
    }

    /* Cost Breakdown */
    .cost-bar {
      display: flex;
      height: 32px;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .cost-segment {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .cost-segment:hover {
      filter: brightness(1.15);
    }

    .cost-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 4px;
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #818cf8);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(99,102,241,0.4);
    }

    .btn-secondary {
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--line);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(255,255,255,0.2);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #16a34a);
      color: #fff;
    }

    .btn .material-icons-outlined {
      font-size: 18px;
    }

    .action-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid var(--line);
    }

    /* Override Panel */
    .override-panel {
      background: linear-gradient(135deg, rgba(245,158,11,0.08), rgba(239,68,68,0.05));
      border: 1px solid rgba(245,158,11,0.3);
      border-radius: 12px;
      padding: 16px;
      margin-top: 16px;
    }

    .override-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .override-header .material-icons-outlined {
      color: var(--warning);
    }

    .override-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--warning);
    }

    .override-note {
      width: 100%;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(245,158,11,0.3);
      border-radius: 8px;
      color: var(--text);
      font-size: 12px;
      resize: vertical;
      min-height: 60px;
    }

    /* Proposal Preview */
    .proposal-preview {
      background: #fff;
      color: #1a1a1a;
      border-radius: 12px;
      padding: 32px;
      max-height: 500px;
      overflow-y: auto;
    }

    .proposal-preview h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .proposal-preview h2 {
      font-size: 18px;
      color: #4f46e5;
      margin-top: 24px;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }

    .proposal-preview p {
      font-size: 14px;
      line-height: 1.6;
      color: #4b5563;
      margin-bottom: 12px;
    }

    .proposal-preview table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
    }

    .proposal-preview table th,
    .proposal-preview table td {
      padding: 10px;
      text-align: left;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .proposal-preview table th {
      background: #f9fafb;
      font-weight: 600;
    }

    /* Documentation View */
    .docs-embed {
      width: 100%;
      height: calc(100vh - 200px);
      border: none;
      border-radius: 12px;
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .slide-in {
      animation: slideIn 0.3s ease;
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .content-grid { grid-template-columns: 1fr; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
      .tech-grid { grid-template-columns: repeat(2, 1fr); }
    }

    /* AI Processing Animation */
    .ai-processing {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(168,85,247,0.08));
      border: 1px solid rgba(99,102,241,0.3);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .ai-spinner {
      width: 24px;
      height: 24px;
      border: 3px solid var(--line);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .ai-text {
      font-size: 13px;
      color: var(--accent);
      font-weight: 500;
    }

    /* Decision Trail */
    .decision-trail {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .decision-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: rgba(0,0,0,0.15);
      border-radius: 10px;
      border-left: 3px solid var(--accent);
    }

    .decision-time {
      font-size: 11px;
      color: var(--muted);
      min-width: 60px;
    }

    .decision-content {
      flex: 1;
    }

    .decision-action {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .decision-reason {
      font-size: 11px;
      color: var(--muted);
    }

    /* ==================== AI SIDEBAR ==================== */
    .ai-sidebar {
      position: fixed;
      top: 60px;
      right: -380px;
      width: 380px;
      height: calc(100vh - 60px);
      background: var(--panel);
      border-left: 1px solid var(--line);
      box-shadow: -4px 0 24px rgba(0,0,0,0.15);
      z-index: 200;
      transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
    }

    .ai-sidebar.open { right: 0; }

    .ai-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      gap: 10px;
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(34,211,238,0.08));
    }

    .ai-header-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 18px;
    }

    .ai-header-text h3 {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
    }

    .ai-header-text p {
      font-size: 10px;
      color: var(--muted);
    }

    .ai-header-close {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
    }

    .ai-header-close:hover { background: var(--card); color: var(--text); }

    .ai-tabs {
      display: flex;
      border-bottom: 1px solid var(--line);
    }

    .ai-tab {
      flex: 1;
      padding: 8px 4px;
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      color: var(--muted);
      border-bottom: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .ai-tab:hover { color: var(--text); }
    .ai-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .ai-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }

    .ai-tab-panel { display: none; }
    .ai-tab-panel.active { display: block; }

    /* Quick Actions Bar */
    .quick-actions-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
      padding: 8px;
      background: var(--card);
      border-radius: 8px;
      border: 1px solid var(--line);
    }

    .quick-actions-bar input {
      flex: 1;
      padding: 8px 10px;
      border: none;
      background: transparent;
      color: var(--text);
      font-size: 11px;
    }

    .quick-actions-bar input:focus { outline: none; }
    .quick-actions-bar input::placeholder { color: var(--muted); }

    .quick-actions-bar button {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
    }

    .quick-actions-bar button:hover { filter: brightness(1.1); }

    .quick-actions-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .quick-chip {
      padding: 4px 10px;
      font-size: 10px;
      border-radius: 12px;
      background: var(--card);
      border: 1px solid var(--line);
      color: var(--muted);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quick-chip:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(99,102,241,0.1);
    }

    /* Smart Suggestions */
    .suggestion-card {
      padding: 10px 12px;
      background: var(--card);
      border-radius: 8px;
      border: 1px solid var(--line);
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .suggestion-card:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(99,102,241,0.1);
    }

    .suggestion-card.highlight {
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(34,211,238,0.05));
      border-color: rgba(99,102,241,0.3);
    }

    .suggestion-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .suggestion-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .suggestion-icon.optimize { background: rgba(34,197,94,0.15); color: var(--success); }
    .suggestion-icon.warning { background: rgba(245,158,11,0.15); color: var(--warning); }
    .suggestion-icon.opportunity { background: rgba(59,130,246,0.15); color: #3b82f6; }
    .suggestion-icon.save { background: rgba(99,102,241,0.15); color: var(--accent); }
    .suggestion-icon.critical { background: rgba(239,68,68,0.15); color: var(--danger); }
    .suggestion-icon.success { background: rgba(34,197,94,0.15); color: var(--success); }

    .suggestion-card.critical-card {
      border: 1px solid rgba(239,68,68,0.4);
      background: rgba(239,68,68,0.08);
    }

    .suggestion-impact.critical {
      background: rgba(239,68,68,0.15);
      color: var(--danger);
    }

    .suggestion-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      flex: 1;
    }

    .suggestion-impact {
      font-size: 9px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(34,197,94,0.15);
      color: var(--success);
    }

    .suggestion-impact.negative { background: rgba(239,68,68,0.15); color: var(--danger); }

    .suggestion-body {
      font-size: 10px;
      color: var(--muted);
      line-height: 1.4;
    }

    .suggestion-action {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      font-size: 10px;
      font-weight: 600;
      color: var(--accent);
      cursor: pointer;
    }

    .suggestion-action:hover { text-decoration: underline; }
    .suggestion-action .material-icons-outlined { font-size: 14px; }

    /* Scenario Builder */
    .scenario-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .scenario-card {
      padding: 12px;
      background: var(--card);
      border-radius: 8px;
      border: 2px solid var(--line);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
    }

    .scenario-card:hover { border-color: var(--accent); }

    .scenario-card.recommended {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(34,197,94,0.1), transparent);
    }

    .scenario-card.recommended::before {
      content: 'RECOMMENDED';
      position: absolute;
      top: -8px;
      right: 12px;
      padding: 2px 8px;
      font-size: 8px;
      font-weight: 700;
      background: var(--success);
      color: #fff;
      border-radius: 4px;
    }

    .scenario-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .scenario-name {
      font-size: 12px;
      font-weight: 700;
      color: var(--text);
    }

    .scenario-price {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent);
    }

    .scenario-specs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .scenario-spec {
      font-size: 9px;
      padding: 2px 6px;
      background: var(--bg);
      border-radius: 4px;
      color: var(--muted);
    }

    .scenario-desc {
      font-size: 10px;
      color: var(--muted);
      line-height: 1.4;
    }

    .scenario-apply {
      margin-top: 8px;
      padding: 6px 12px;
      font-size: 10px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      width: 100%;
    }

    .scenario-apply:hover { filter: brightness(1.1); }
    .scenario-card.recommended .scenario-apply { background: var(--success); }

    /* Guided Wizard */
    .wizard-progress {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
    }

    .wizard-step {
      flex: 1;
      height: 4px;
      background: var(--line);
      border-radius: 2px;
    }

    .wizard-step.complete { background: var(--success); }
    .wizard-step.current { background: var(--accent); }

    .wizard-question {
      padding: 16px;
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(34,211,238,0.05));
      border-radius: 10px;
      border: 1px solid rgba(99,102,241,0.2);
      margin-bottom: 12px;
    }

    .wizard-q-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .wizard-q-num {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      font-size: 11px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wizard-q-text {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }

    .wizard-options {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .wizard-option {
      padding: 10px 12px;
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .wizard-option:hover {
      border-color: var(--accent);
      background: var(--card);
    }

    .wizard-option.selected {
      border-color: var(--accent);
      background: rgba(99,102,241,0.1);
    }

    .wizard-option-main {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
    }

    .wizard-option-sub {
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    .wizard-nav {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .wizard-nav button {
      flex: 1;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .wizard-nav .wizard-back {
      background: var(--card);
      border: 1px solid var(--line);
      color: var(--muted);
    }

    .wizard-nav .wizard-back:hover { border-color: var(--text); }

    .wizard-nav .wizard-next {
      background: var(--accent);
      border: none;
      color: #fff;
    }

    .wizard-nav .wizard-next:hover { filter: brightness(1.1); }

    .wizard-complete {
      text-align: center;
      padding: 20px;
    }

    .wizard-complete-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: rgba(34,197,94,0.15);
      color: var(--success);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 12px;
    }

    .wizard-complete h4 {
      font-size: 14px;
      color: var(--text);
      margin-bottom: 8px;
    }

    .wizard-complete p {
      font-size: 11px;
      color: var(--muted);
    }

    /* Decision Trail */
    .decision-item {
      padding: 10px 12px;
      background: var(--card);
      border-radius: 8px;
      border-left: 3px solid var(--accent);
      margin-bottom: 8px;
    }

    .decision-item.warning { border-left-color: var(--warning); }
    .decision-item.success { border-left-color: var(--success); }
    .decision-item.info { border-left-color: #3b82f6; }

    .decision-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .decision-time {
      font-size: 9px;
      color: var(--muted);
      font-family: monospace;
    }

    .decision-type {
      font-size: 9px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .decision-type.auto { background: rgba(99,102,241,0.15); color: var(--accent); }
    .decision-type.rule { background: rgba(245,158,11,0.15); color: var(--warning); }
    .decision-type.user { background: rgba(34,197,94,0.15); color: var(--success); }

    .decision-action {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }

    .ai-decision-reason {
      font-size: 10px;
      color: var(--muted);
      line-height: 1.4;
    }

    /* Confidence Indicator */
    .confidence-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }

    .confidence-badge.high { background: rgba(34,197,94,0.15); color: var(--success); }
    .confidence-badge.medium { background: rgba(245,158,11,0.15); color: var(--warning); }
    .confidence-badge.low { background: rgba(239,68,68,0.15); color: var(--danger); }

    .confidence-bar {
      height: 4px;
      background: var(--line);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 6px;
    }

    .confidence-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.5s ease;
    }

    .confidence-fill.high { background: var(--success); }
    .confidence-fill.medium { background: var(--warning); }
    .confidence-fill.low { background: var(--danger); }

    /* AI Recommendation Card */
    .ai-recommendation {
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(34,211,238,0.08));
      border: 1px solid rgba(99,102,241,0.2);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .ai-rec-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .ai-rec-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: var(--accent);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .ai-rec-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text);
    }

    /* AI Button in Header */
    .ai-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid rgba(99,102,241,0.3);
      background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(34,211,238,0.08));
      color: var(--accent);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .ai-btn:hover {
      background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(34,211,238,0.12));
      border-color: var(--accent);
    }

    .ai-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .ai-btn .material-icons-outlined { font-size: 16px; }

    .ai-pulse {
      width: 6px;
      height: 6px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* Similar Projects */
    .similar-project {
      padding: 10px;
      background: var(--card);
      border-radius: 8px;
      border: 1px solid var(--line);
      margin-bottom: 8px;
    }

    .similar-project-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .similar-project-name {
      font-size: 11px;
      font-weight: 600;
      color: var(--text);
    }

    .similar-project-match {
      font-size: 10px;
      font-weight: 600;
      color: var(--success);
    }

    .similar-project-details {
      font-size: 10px;
      color: var(--muted);
    }

    /* Light theme AI overrides */
    [data-theme="light"] .ai-sidebar {
      box-shadow: -4px 0 24px rgba(0,0,0,0.08);
    }

    [data-theme="light"] .ai-header {
      background: linear-gradient(135deg, rgba(79,70,229,0.08), rgba(8,145,178,0.05));
    }

    [data-theme="light"] .suggestion-card {
      background: var(--input-bg);
    }

    [data-theme="light"] .scenario-card {
      background: var(--input-bg);
    }

    [data-theme="light"] .wizard-option {
      background: var(--card);
    }

    [data-theme="light"] .decision-item {
      background: var(--input-bg);
    }

    [data-theme="light"] .similar-project {
      background: var(--input-bg);
    }
  </style>
</head>
<body data-persona="all">
  <!-- Header -->
  <header class="app-header">
    <div class="logo">
      <div class="logo-icon">
        <span class="material-icons-round">water_drop</span>
      </div>
      <div class="logo-text">MembraCon <span>WaterLogic</span></div>
    </div>

    <nav class="nav-tabs">
      <div class="nav-tab active" data-view="proposal">
        <span class="material-icons-outlined">add_circle</span>
        New Proposal
      </div>
      <div class="nav-tab" data-view="projects">
        <span class="material-icons-outlined">folder_open</span>
        All Projects
      </div>
      <div class="nav-tab" data-view="docs">
        <span class="material-icons-outlined">hub</span>
        Documentation
      </div>
    </nav>

    <div class="header-spacer"></div>

    <div class="user-menu">
      <!-- AI Assistant Toggle -->
      <button class="ai-btn" id="aiToggleBtn" onclick="toggleAI()">
        <span class="material-icons-outlined">auto_awesome</span>
        AI Assistant
        <span class="ai-pulse"></span>
      </button>
      <!-- Admin Settings -->
      <a href="admin-ai-settings.html" class="theme-toggle" title="AI Admin Settings" style="text-decoration:none">
        <span class="material-icons-outlined">admin_panel_settings</span>
      </a>
      <!-- Keyboard Mode Toggle -->
      <button class="theme-toggle" id="keyboardToggle" onclick="toggleKeyboardMode()" title="Toggle keyboard mode (Ctrl+K)">
        <span class="material-icons-outlined" id="keyboardIcon">keyboard</span>
      </button>
      <!-- Theme Toggle -->
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">
        <span class="material-icons-outlined" id="themeIcon">light_mode</span>
      </button>
      <span style="font-size:12px;color:var(--muted)">Internal System v1.0</span>

      <!-- Persona Toggle & Selector -->
      <button class="theme-toggle" id="personaToggle" onclick="togglePersonaSelector()" title="Toggle persona views">
        <span class="material-icons-outlined" id="personaToggleIcon">groups</span>
      </button>
      <div class="persona-selector" id="personaSelector">
        <div class="persona-chip active" data-persona="all" onclick="setPersona('all')" title="View all content">
          <span class="material-icons-outlined">groups</span>
          <span>All</span>
        </div>
        <div class="persona-chip" data-persona="business" onclick="setPersona('business')" title="Business focus: Margins, ROI, ESG, governance">
          <span class="material-icons-outlined">analytics</span>
          <span>Business</span>
        </div>
        <div class="persona-chip" data-persona="technician" onclick="setPersona('technician')" title="Technician focus: Water quality, sizing, pre-treatment">
          <span class="material-icons-outlined">engineering</span>
          <span>Technician</span>
        </div>
        <div class="persona-chip" data-persona="sales" onclick="setPersona('sales')" title="Sales focus: Pricing, discounts, customer value">
          <span class="material-icons-outlined">storefront</span>
          <span>Sales</span>
        </div>
        <div class="persona-chip" data-persona="customer" onclick="setPersona('customer')" title="Customer focus: Final price, benefits, warranty">
          <span class="material-icons-outlined">person</span>
          <span>Customer</span>
        </div>
      </div>

      <div class="user-avatar">TE</div>
    </div>
  </header>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">
          <span class="material-icons-outlined">folder_open</span>
          Active Projects
        </div>

        <div class="project-item active">
          <div class="project-name">Riverside Pharma - Purified Water</div>
          <div class="project-meta">
            <span>200 m/h</span>
            <span>RO System</span>
          </div>
          <div class="project-stage stage-design">In Design</div>
        </div>

        <div class="project-item">
          <div class="project-name">Nordic Foods - Wastewater</div>
          <div class="project-meta">
            <span>500 m/h</span>
            <span>MBR + UV</span>
          </div>
          <div class="project-stage stage-pricing">Pricing</div>
        </div>

        <div class="project-item">
          <div class="project-name">GreenEnergy - Cooling Tower</div>
          <div class="project-meta">
            <span>1000 m/h</span>
            <span>UF + RO</span>
          </div>
          <div class="project-stage stage-proposal">Proposal Ready</div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">
          <span class="material-icons-outlined">insights</span>
          Quick Stats
        </div>
        <div style="font-size:12px;color:var(--muted);line-height:1.8">
          <div style="display:flex;justify-content:space-between">
            <span>Active Proposals</span>
            <span style="color:var(--accent);font-weight:600">12</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>Avg. Win Rate</span>
            <span style="color:var(--success);font-weight:600">67%</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>Avg. Turnaround</span>
            <span style="color:var(--accent2);font-weight:600">2.3 days</span>
          </div>
          <div style="display:flex;justify-content:space-between">
            <span>ESG Score Avg</span>
            <span style="color:var(--esg-green);font-weight:600">82</span>
          </div>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">
          <span class="material-icons-outlined">memory</span>
          System Control
        </div>
        <div class="chip-group">
          <div class="chip" onclick="this.classList.toggle('active')">
            <span class="material-icons-outlined">tune</span>
            Override Mode
          </div>
          <div class="chip active">
            <span class="material-icons-outlined">smart_toy</span>
            AI Assist
          </div>
          <div class="chip">
            <span class="material-icons-outlined">history</span>
            Audit Trail
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Proposal Builder View -->
      <div class="view active" id="view-proposal">
        <div class="workflow-header">
          <h1 class="workflow-title">Proposal Builder</h1>
          <p class="workflow-subtitle">End-to-end intelligent proposal generation workflow</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-bar-container" style="margin-bottom:24px">
          <div class="progress-bar-bg" style="height:4px;background:var(--line);border-radius:2px;overflow:hidden">
            <div class="progress-bar-fill" id="progressFill" style="width:20%;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 0.3s ease"></div>
          </div>
          <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;color:var(--muted)">
            <span>Step <span id="currentStepNum">1</span> of 6</span>
            <span id="progressPercent">17%</span>
          </div>
        </div>

        <!-- Workflow Steps - 6-Phase Execution Methodology -->
        <div class="workflow-steps">
          <div class="workflow-step active" data-step="1" data-content="step-assessment" data-shortcut="1" tabindex="0">
            <div class="step-header">
              <div class="step-icon">
                <span class="material-icons-outlined">science</span>
              </div>
              <span class="step-name">1. Assessment</span>
            </div>
            <div class="step-desc">Technical modelling</div>
          </div>
          <div class="workflow-step" data-step="2" data-content="step-lab" data-shortcut="2" tabindex="0">
            <div class="step-header">
              <div class="step-icon">
                <span class="material-icons-outlined">biotech</span>
              </div>
              <span class="step-name">2. Lab Testing</span>
            </div>
            <div class="step-desc">Verification & data</div>
          </div>
          <div class="workflow-step" data-step="3" data-content="step-pilot" data-shortcut="3" tabindex="0">
            <div class="step-header">
              <div class="step-icon">
                <span class="material-icons-outlined">precision_manufacturing</span>
              </div>
              <span class="step-name">3. Pilot</span>
            </div>
            <div class="step-desc">Onsite validation</div>
          </div>
          <div class="workflow-step" data-step="4" data-content="step-design" data-shortcut="4" tabindex="0">
            <div class="step-header">
              <div class="step-icon">
                <span class="material-icons-outlined">architecture</span>
              </div>
              <span class="step-name">4. Design</span>
            </div>
            <div class="step-desc">Detailed engineering</div>
          </div>
          <div class="workflow-step" data-step="5" data-content="step-commercial" data-shortcut="5" tabindex="0">
            <div class="step-header">
              <div class="step-icon">
                <span class="material-icons-outlined">calculate</span>
              </div>
              <span class="step-name">5. Commercial</span>
            </div>
            <div class="step-desc">Pricing & ROI</div>
          </div>
          <div class="workflow-step" data-step="6" data-content="step-generate" data-shortcut="6" tabindex="0">
            <div class="step-header">
              <div class="step-icon">
                <span class="material-icons-outlined">auto_awesome</span>
              </div>
              <span class="step-name">6. Proposal</span>
            </div>
            <div class="step-desc">Export & delivery</div>
          </div>
        </div>

        <!-- Phase 1: Technical Assessment -->
        <div class="step-content active" id="step-assessment">
        <div class="content-grid">
          <!-- Input Specifications Panel -->
          <div class="content-panel" data-persona="technician sales" data-persona-key="technician">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">input</span>
                Input Specifications
              </div>
              <span class="panel-badge">Step 1</span>
              <span class="persona-badge technician">Technical</span>
            </div>

            <div class="form-group">
              <label class="form-label">Target Market</label>
              <select class="form-input" id="sector">
                <option value="waterUtilities">Water Utilities</option>
                <option value="industrial">Industrial Manufacturing</option>
                <option value="automotive">Automotive</option>
                <option value="foodBeverage">Food & Beverage</option>
                <option value="adPlants">Anaerobic Digestate (AD) Plants</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <div class="input-field">
                  <label class="input-label" for="flowRate">Flow Rate (m/h) <span class="shortcut-key">F</span></label>
                  <input type="number" class="form-input" id="flowRate" value="200" data-shortcut="f">
                </div>
              </div>
              <div class="form-group">
                <div class="input-field">
                  <label class="input-label" for="opHours">Operating Hours (hrs/year) <span class="shortcut-key">H</span></label>
                  <input type="number" class="form-input" id="opHours" value="8000" data-shortcut="h">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Feed Water Quality - Primary</label>
              <div class="form-row three-cols">
                <div class="input-field">
                  <label class="input-label" for="feedTDS">TDS (ppm) <span class="shortcut-key">T</span></label>
                  <input type="number" class="form-input" id="feedTDS" value="500" data-shortcut="t" data-reactive="feedTDS">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedTSS">TSS (ppm) <span class="shortcut-key">S</span></label>
                  <input type="number" class="form-input" id="feedTSS" value="5" data-shortcut="s" data-reactive="feedTSS">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedBOD">BOD (mg/L) <span class="shortcut-key">B</span></label>
                  <input type="number" class="form-input" id="feedBOD" value="120" data-shortcut="b">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Feed Water Quality - Extended</label>
              <div class="form-row three-cols">
                <div class="input-field">
                  <label class="input-label" for="feedConductivity">Conductivity (S/cm) <span class="shortcut-key">C</span></label>
                  <input type="number" class="form-input" id="feedConductivity" value="500" data-shortcut="c" data-reactive="feedConductivity">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedPH">pH <span class="shortcut-key">P</span></label>
                  <input type="number" class="form-input" id="feedPH" value="7" step="0.1" min="0" max="14" data-shortcut="p" data-reactive="ph">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedChlorine">Chlorine (ppm) <span class="shortcut-key">L</span></label>
                  <input type="number" class="form-input" id="feedChlorine" value="0" step="0.01" data-shortcut="l" data-reactive="chlorine">
                </div>
              </div>
              <div class="form-row three-cols" style="margin-top:12px">
                <div class="input-field">
                  <label class="input-label" for="feedTurbidity">Turbidity (NTU) <span class="shortcut-key">U</span></label>
                  <input type="number" class="form-input" id="feedTurbidity" value="1" step="0.1" data-shortcut="u" data-reactive="turbidity">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedSDI">SDI <span class="shortcut-key">D</span></label>
                  <input type="number" class="form-input" id="feedSDI" value="3" step="0.1" data-shortcut="d" data-reactive="sdi">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedIron">Iron (mg/L) <span class="shortcut-key">I</span></label>
                  <input type="number" class="form-input" id="feedIron" value="0.02" step="0.01" data-shortcut="i" data-reactive="iron">
                </div>
              </div>
              <div class="form-row three-cols" style="margin-top:12px">
                <div class="input-field">
                  <label class="input-label" for="feedHardness">Hardness (mg/L CaCO) <span class="shortcut-key">A</span></label>
                  <input type="number" class="form-input" id="feedHardness" value="150" data-shortcut="a" data-reactive="hardness">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedTemp">Temperature (C) <span class="shortcut-key">E</span></label>
                  <input type="number" class="form-input" id="feedTemp" value="20" data-shortcut="e" data-reactive="temperature">
                </div>
                <div class="input-field">
                  <label class="input-label" for="feedPressure">Feed Pressure (BAR) <span class="shortcut-key">R</span></label>
                  <input type="number" class="form-input" id="feedPressure" value="4" step="0.1" data-shortcut="r" data-reactive="feedPressure">
                </div>
              </div>
            </div>

            <!-- Reactive AI Alarms Panel -->
            <div class="form-group">
              <label class="form-label">
                <span class="material-icons-outlined" style="font-size:16px;vertical-align:middle;margin-right:4px">smart_toy</span>
                AI Water Quality Analysis
              </label>
              <div id="reactiveAlarms">
                <!-- Reactive alarms and warnings will be rendered here -->
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Required Output Quality</label>
              <div class="form-row three-cols">
                <div class="input-field">
                  <label class="input-label" for="outTDS">TDS (ppm) <span class="shortcut-key">O</span></label>
                  <input type="number" class="form-input" id="outTDS" value="10" data-shortcut="o">
                </div>
                <div class="input-field">
                  <label class="input-label" for="outTSS">TSS (ppm) <span class="shortcut-key">W</span></label>
                  <input type="number" class="form-input" id="outTSS" value="0.1" step="0.01" data-shortcut="w">
                </div>
                <div class="input-field">
                  <label class="input-label" for="outConductivity">Permeate Quality (S/cm) <span class="shortcut-key">Q</span></label>
                  <input type="number" class="form-input" id="outConductivity" value="12" data-shortcut="q" data-reactive="permeateQuality">
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">System Design Parameters</label>
              <div class="form-row three-cols">
                <div class="input-field">
                  <label class="input-label" for="recovery">Recovery (%) <span class="shortcut-key">Y</span></label>
                  <input type="number" class="form-input" id="recovery" value="75" min="50" max="95" data-shortcut="y" data-reactive="recoveryTarget">
                </div>
                <div class="input-field">
                  <label class="input-label" for="componentMarkup">Component Markup (%) <span class="shortcut-key">M</span></label>
                  <input type="number" class="form-input" id="componentMarkup" value="30" min="0" max="100" data-shortcut="m" data-reactive="componentMarkup">
                </div>
                <div class="input-field">
                  <label class="input-label" for="permeateFlow">Permeate Flow (m/hr) <span class="shortcut-key">X</span></label>
                  <input type="number" class="form-input" id="permeateFlow" value="9" data-shortcut="x" data-reactive="permeateFlow">
                </div>
              </div>
            </div>

            <!-- Reactive Auto-Components Panel -->
            <div class="form-group">
              <label class="form-label">
                <span class="material-icons-outlined" style="font-size:16px;vertical-align:middle;margin-right:4px">auto_fix_high</span>
                AI Auto-Selected Pre-Treatment
              </label>
              <div id="reactiveComponents">
                <!-- Reactive auto-components will be rendered here -->
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">System Configuration</label>
              <div class="chip-group">
                <div class="chip" id="chipContainer" data-reactive-toggle="containerRequired" onclick="toggleReactiveChip(this)">
                  <span class="material-icons-outlined">view_in_ar</span>
                  Container Required
                </div>
                <div class="chip" id="chipUV" data-reactive-toggle="uvRequired" onclick="toggleReactiveChip(this)">
                  <span class="material-icons-outlined">light_mode</span>
                  UV Required
                </div>
                <div class="chip active" id="chipCIP" data-reactive-toggle="cipRequired" onclick="toggleReactiveChip(this)">
                  <span class="material-icons-outlined">cleaning_services</span>
                  CIP System
                </div>
                <div class="chip" id="chipRemote" data-reactive-toggle="remoteMonitoring" onclick="toggleReactiveChip(this)">
                  <span class="material-icons-outlined">wifi</span>
                  Remote Monitoring
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Installation Type</label>
              <div class="chip-group">
                <div class="chip active">
                  <span class="material-icons-outlined">domain</span>
                  Fixed Installation
                </div>
                <div class="chip">
                  <span class="material-icons-outlined">view_in_ar</span>
                  Containerized
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Optional Modules</label>
              <div class="chip-group">
                <div class="chip">Pre-filtration</div>
                <div class="chip active">Chemical Dosing</div>
                <div class="chip">pH Adjustment - Dosing</div>
                <div class="chip">Hardness - Anti Scale Dosing</div>
                <div class="chip">Carbon (Chlorine Removal)</div>
                <div class="chip">Iron Removal</div>
                <div class="chip">Second Stage RO</div>
                <div class="chip">Polish DI</div>
                <div class="chip">Buffer Tank</div>
                <div class="chip">CIP System</div>
                <div class="chip">Remote Monitoring</div>
              </div>
            </div>
          </div>

          <!-- AI Solution Design Panel -->
          <div class="content-panel" data-persona="technician business sales" data-persona-key="technician">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">smart_toy</span>
                AI Solution Design
              </div>
              <span class="panel-badge">Optimizing</span>
              <span class="persona-badge technician">Technical</span>
              <!-- View Toggle -->
              <div class="solution-view-toggle">
                <button class="view-toggle-btn active" data-view="grid" onclick="setSolutionView('grid')" title="Technology Grid">
                  <span class="material-icons-outlined">grid_view</span>
                </button>
                <button class="view-toggle-btn" data-view="tree" onclick="setSolutionView('tree')" title="AI Decision Tree">
                  <span class="material-icons-outlined">account_tree</span>
                </button>
              </div>
            </div>

            <div class="ai-processing">
              <div class="ai-spinner"></div>
              <span class="ai-text">Analyzing 847 possible configurations...</span>
            </div>

            <!-- Grid View -->
            <div id="solutionGridView" class="solution-view active">
              <p style="font-size:12px;color:var(--muted);margin-bottom:16px;">
                Recommended technology train based on your specifications:
              </p>

              <div class="tech-grid">
              <div class="tech-card recommended selected">
                <div class="tech-name">UF</div>
                <div class="tech-full">Ultrafiltration</div>
                <div class="tech-stats">
                  <div class="tech-stat">TSS: <span class="tech-stat-value">99%</span></div>
                  <div class="tech-stat">Energy: <span class="tech-stat-value">0.3 kWh/m</span></div>
                </div>
              </div>
              <div class="tech-card selected">
                <div class="tech-name">RO</div>
                <div class="tech-full">Reverse Osmosis</div>
                <div class="tech-stats">
                  <div class="tech-stat">TDS: <span class="tech-stat-value">97%</span></div>
                  <div class="tech-stat">Energy: <span class="tech-stat-value">2.5 kWh/m</span></div>
                </div>
              </div>
              <div class="tech-card selected">
                <div class="tech-name">UV</div>
                <div class="tech-full">UV Disinfection</div>
                <div class="tech-stats">
                  <div class="tech-stat">Log: <span class="tech-stat-value">4-6</span></div>
                  <div class="tech-stat">Energy: <span class="tech-stat-value">0.1 kWh/m</span></div>
                </div>
              </div>
              </div>
            </div><!-- End Grid View -->

            <!-- Tree View (AI Decision Tree) -->
            <div id="solutionTreeView" class="solution-view">
              <div class="decision-tree-header">
                <span class="material-icons-outlined">account_tree</span>
                <span>AI Decision Tree  Technology Selection</span>
              </div>
              <p style="font-size:11px;color:var(--muted);margin-bottom:12px;">
                Interactive visualization of AI technology selection based on your water parameters. Click nodes for details.
              </p>
              <!-- Use Case Scenarios -->
              <div class="tree-scenarios">
                <span style="font-size:10px;color:var(--muted);margin-right:8px;">USE CASES:</span>
                <button class="scenario-btn" onclick="applyTreeScenario('food-bev')" title="High solids, moderate salinity">
                  <span></span> Food & Bev
                </button>
                <button class="scenario-btn" onclick="applyTreeScenario('semiconductor')" title="Ultra-pure water needed">
                  <span></span> Semiconductor
                </button>
                <button class="scenario-btn" onclick="applyTreeScenario('municipal')" title="Secondary effluent polishing">
                  <span></span> Municipal
                </button>
                <button class="scenario-btn" onclick="applyTreeScenario('pharma')" title="WFI-grade water">
                  <span></span> Pharma
                </button>
              </div>
              <!-- Decision Tree SVG Container -->
              <div id="decisionTreeContainer" class="decision-tree-svg">
                <!-- D3 will render the tree here -->
              </div>
              <!-- Tree Legend -->
              <div class="tree-legend">
                <div class="legend-item"><span class="legend-dot recommended"></span> Recommended Path</div>
                <div class="legend-item"><span class="legend-dot decision"></span> Decision Node</div>
                <div class="legend-item"><span class="legend-dot technology"></span> Technology</div>
              </div>
            </div><!-- End Tree View -->

            <!-- Reactive System Info Display -->
            <div style="margin-top:16px;padding:12px;background:rgba(0,0,0,0.2);border-radius:10px;border:1px solid var(--line)">
              <div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">
                <span class="material-icons-outlined" style="font-size:14px;vertical-align:middle;margin-right:4px">auto_awesome</span>
                AI-Calculated System Design
              </div>
              <div id="reactiveSystemInfo">
                <!-- Reactive system calculations will be rendered here -->
              </div>
            </div>

            <!-- Reactive Pricing Summary -->
            <div style="margin-top:16px;padding:16px;background:linear-gradient(135deg,rgba(99,102,241,0.08),rgba(34,211,238,0.05));border-radius:12px;border:1px solid rgba(99,102,241,0.2)">
              <div style="font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px">
                <span class="material-icons-outlined" style="font-size:14px;vertical-align:middle;margin-right:4px">calculate</span>
                Real-Time Pricing
              </div>
              <div id="reactivePricing">
                <!-- Reactive pricing will be rendered here -->
              </div>
            </div>

            <div style="margin-top:16px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                <span class="material-icons-outlined" style="color:var(--success);font-size:18px">check_circle</span>
                <span style="font-size:13px;font-weight:600;color:var(--success)">Solution Validated</span>
              </div>
              <p style="font-size:12px;color:var(--muted);margin:0">
                Configuration meets all requirements. Real-time calculations update automatically as you change parameters.
              </p>
            </div>

            <!-- Engineer Override -->
            <div class="override-panel">
              <div class="override-header">
                <span class="material-icons-outlined">engineering</span>
                <span class="override-title">Engineer Override</span>
              </div>
              <textarea class="override-note" placeholder="Add manual adjustments or override AI recommendations..."></textarea>
            </div>
          </div>

          <!-- Decision Trail Panel -->
          <div class="content-panel full-width" data-persona="technician business" data-persona-key="business">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">account_tree</span>
                Decision Trail
              </div>
              <span class="persona-badge business">Governance</span>
              <button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">
                <span class="material-icons-outlined" style="font-size:14px">download</span>
                Export Audit
              </button>
            </div>

            <div class="decision-trail">
              <div class="decision-item">
                <div class="decision-time">14:32:01</div>
                <div class="decision-content">
                  <div class="decision-action">Selected UF as pre-treatment</div>
                  <div class="decision-reason">High TSS in feed water (50 mg/L) requires membrane protection. UF provides 99% TSS removal.</div>
                </div>
              </div>
              <div class="decision-item">
                <div class="decision-time">14:32:02</div>
                <div class="decision-content">
                  <div class="decision-action">Selected RO for desalination</div>
                  <div class="decision-reason">TDS reduction requirement (1500  10 mg/L) requires 99.3% rejection. RO achieves 97% per pass.</div>
                </div>
              </div>
              <div class="decision-item">
                <div class="decision-time">14:32:03</div>
                <div class="decision-content">
                  <div class="decision-action">Added UV disinfection</div>
                  <div class="decision-reason">Pharmaceutical sector requires validated disinfection. UV selected per customer module preference.</div>
                </div>
              </div>
              <div class="decision-item">
                <div class="decision-time">14:32:04</div>
                <div class="decision-content">
                  <div class="decision-action">Rejected MBR option</div>
                  <div class="decision-reason">BOD/COD removal not primary concern for this application. UF + RO more cost-effective.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" onclick="prevStep()" style="visibility:hidden">
            <span class="material-icons-outlined">arrow_back</span>
            Previous
          </button>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
            <button class="btn btn-primary" onclick="goToStep(2)">
              Continue to Lab Testing
              <span class="material-icons-outlined">arrow_forward</span>
            </button>
          </div>
        </div>
        </div><!-- End Phase 1: Technical Assessment -->

        <!-- Phase 2: Lab-Scale Testing & Verification -->
        <div class="step-content" id="step-lab">
        <div class="workflow-header">
          <h1 class="workflow-title">Lab-Scale Testing</h1>
          <p class="workflow-subtitle">Validate assessments and generate data for accurate system selection</p>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Sample Status</div>
            <div class="metric-value accent">Pending</div>
            <div class="metric-change">
              <span class="material-icons-outlined" style="font-size:14px">science</span>
              Awaiting customer samples
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Test Duration</div>
            <div class="metric-value">5-10 days</div>
            <div class="metric-change">
              <span class="material-icons-outlined" style="font-size:14px">schedule</span>
              Typical timeline
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Tests Planned</div>
            <div class="metric-value success">4</div>
            <div class="metric-change positive">
              <span class="material-icons-outlined" style="font-size:14px">checklist</span>
              Treatment pathways
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Data Points</div>
            <div class="metric-value">~120</div>
            <div class="metric-change">
              <span class="material-icons-outlined" style="font-size:14px">analytics</span>
              Per test cycle
            </div>
          </div>
        </div>

        <div class="content-grid">
          <div class="content-panel" data-persona="technician" data-persona-key="technician">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">biotech</span>
                Lab Test Requirements
              </div>
              <span class="panel-badge">Phase 2</span>
              <span class="persona-badge technician">Technical</span>
            </div>

            <div class="form-group">
              <label class="form-label">Sample Collection</label>
              <div style="padding:16px;background:rgba(99,102,241,0.1);border-radius:10px;border:1px solid rgba(99,102,241,0.3);margin-bottom:16px">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                  <span class="material-icons-outlined" style="color:var(--accent);font-size:18px">info</span>
                  <span style="font-size:13px;font-weight:600;color:var(--accent)">Sample Requirements</span>
                </div>
                <ul style="font-size:12px;color:var(--muted);margin:0;padding-left:20px">
                  <li>Minimum 20L representative feed water sample</li>
                  <li>Sample within 24hrs of collection</li>
                  <li>Include sample collection date and location</li>
                  <li>Note any seasonal variations expected</li>
                </ul>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Test Systems</label>
              <div class="chip-group">
                <div class="chip active">
                  <span class="material-icons-outlined">water_drop</span>
                  UF Bench Test
                </div>
                <div class="chip active">
                  <span class="material-icons-outlined">filter_alt</span>
                  RO Pilot Cell
                </div>
                <div class="chip">
                  <span class="material-icons-outlined">light_mode</span>
                  UV Validation
                </div>
                <div class="chip">
                  <span class="material-icons-outlined">layers</span>
                  NF Membrane Test
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Test Objectives</label>
              <div style="display:grid;gap:8px">
                <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:8px;border:1px solid var(--line)">
                  <span class="material-icons-outlined" style="color:var(--success);font-size:20px">check_circle</span>
                  <div>
                    <div style="font-size:13px;font-weight:600">Treatability Assessment</div>
                    <div style="font-size:11px;color:var(--muted)">Verify treatment pathways work for this specific water</div>
                  </div>
                </div>
                <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:8px;border:1px solid var(--line)">
                  <span class="material-icons-outlined" style="color:var(--success);font-size:20px">check_circle</span>
                  <div>
                    <div style="font-size:13px;font-weight:600">Recovery Rate Validation</div>
                    <div style="font-size:11px;color:var(--muted)">Optimize recovery without scaling or fouling</div>
                  </div>
                </div>
                <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:8px;border:1px solid var(--line)">
                  <span class="material-icons-outlined" style="color:var(--success);font-size:20px">check_circle</span>
                  <div>
                    <div style="font-size:13px;font-weight:600">Membrane Selection</div>
                    <div style="font-size:11px;color:var(--muted)">Select optimal membrane type and configuration</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="content-panel" data-persona="technician" data-persona-key="technician">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">assignment</span>
                Test Results
              </div>
              <span class="panel-badge">Awaiting Data</span>
              <span class="persona-badge technician">Technical</span>
            </div>

            <div style="text-align:center;padding:48px 24px;color:var(--muted)">
              <span class="material-icons-outlined" style="font-size:48px;opacity:0.5;margin-bottom:16px;display:block">science</span>
              <div style="font-size:14px;font-weight:600;margin-bottom:8px">No Test Results Yet</div>
              <div style="font-size:12px">Lab test results will appear here once samples are processed</div>
            </div>

            <div style="margin-top:16px;padding:12px;background:rgba(245,158,11,0.1);border-radius:10px;border:1px solid rgba(245,158,11,0.3)">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                <span class="material-icons-outlined" style="color:var(--warning);font-size:18px">schedule</span>
                <span style="font-size:12px;font-weight:600;color:var(--warning)">Skip for Budgetary Proposals</span>
              </div>
              <p style="font-size:11px;color:var(--muted);margin:0">
                Lab testing can be skipped for initial budgetary proposals. Results refine accuracy for detailed quotes.
              </p>
            </div>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" onclick="goToStep(1)">
            <span class="material-icons-outlined">arrow_back</span>
            Previous
          </button>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
            <button class="btn btn-primary" onclick="goToStep(3)">
              Continue to Pilot Validation
              <span class="material-icons-outlined">arrow_forward</span>
            </button>
          </div>
        </div>
        </div><!-- End Phase 2: Lab-Scale Testing -->

        <!-- Phase 3: Pilot-Scale Validation -->
        <div class="step-content" id="step-pilot">
        <div class="workflow-header">
          <h1 class="workflow-title">Pilot-Scale Validation</h1>
          <p class="workflow-subtitle">Prove performance under real operating conditions on-site</p>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Pilot Status</div>
            <div class="metric-value accent">Optional</div>
            <div class="metric-change">
              <span class="material-icons-outlined" style="font-size:14px">precision_manufacturing</span>
              High-confidence projects
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Typical Duration</div>
            <div class="metric-value">2-4 weeks</div>
            <div class="metric-change">
              <span class="material-icons-outlined" style="font-size:14px">date_range</span>
              On-site operation
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Pilot Capacity</div>
            <div class="metric-value success">1-5 m/hr</div>
            <div class="metric-change positive">
              <span class="material-icons-outlined" style="font-size:14px">speed</span>
              Scalable units
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Confidence Gain</div>
            <div class="metric-value">+15-25%</div>
            <div class="metric-change positive">
              <span class="material-icons-outlined" style="font-size:14px">trending_up</span>
              Risk reduction
            </div>
          </div>
        </div>

        <div class="content-grid">
          <div class="content-panel" data-persona="technician business" data-persona-key="technician">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">precision_manufacturing</span>
                Pilot Plant Options
              </div>
              <span class="panel-badge">Phase 3</span>
              <span class="persona-badge technician">Technical</span>
            </div>

            <div class="form-group">
              <label class="form-label">Pilot System Type</label>
              <div class="chip-group">
                <div class="chip active">
                  <span class="material-icons-outlined">view_in_ar</span>
                  Containerised 10ft
                </div>
                <div class="chip">
                  <span class="material-icons-outlined">view_in_ar</span>
                  Containerised 20ft
                </div>
                <div class="chip">
                  <span class="material-icons-outlined">foundation</span>
                  Skid-Mounted
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Pilot Objectives</label>
              <div style="display:grid;gap:8px">
                <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:8px;border:1px solid var(--line)">
                  <span class="material-icons-outlined" style="color:var(--accent);font-size:20px">verified</span>
                  <div>
                    <div style="font-size:13px;font-weight:600">Performance Verification</div>
                    <div style="font-size:11px;color:var(--muted)">Confirm output quality under actual site conditions</div>
                  </div>
                </div>
                <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:8px;border:1px solid var(--line)">
                  <span class="material-icons-outlined" style="color:var(--accent);font-size:20px">tune</span>
                  <div>
                    <div style="font-size:13px;font-weight:600">Design Refinement</div>
                    <div style="font-size:11px;color:var(--muted)">Optimize chemical dosing, recovery, and CIP cycles</div>
                  </div>
                </div>
                <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:8px;border:1px solid var(--line)">
                  <span class="material-icons-outlined" style="color:var(--accent);font-size:20px">psychology</span>
                  <div>
                    <div style="font-size:13px;font-weight:600">Operator Familiarisation</div>
                    <div style="font-size:11px;color:var(--muted)">Build operational confidence before full-scale deployment</div>
                  </div>
                </div>
              </div>
            </div>

            <div style="margin-top:16px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                <span class="material-icons-outlined" style="color:var(--success);font-size:18px">lightbulb</span>
                <span style="font-size:13px;font-weight:600;color:var(--success)">Case Study Reference</span>
              </div>
              <p style="font-size:12px;color:var(--muted);margin:0">
                <strong>Water Utilities:</strong> Two 20ft containerised pilot plants delivered 300,000 L/day each with remote monitoring for ceramic membrane technology trials.
              </p>
            </div>
          </div>

          <div class="content-panel" data-persona="technician business sales" data-persona-key="sales">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">handshake</span>
                Technology Partners
              </div>
              <span class="panel-badge">Innovation Ecosystem</span>
              <span class="persona-badge sales">Sales</span>
            </div>

            <p style="font-size:12px;color:var(--muted);margin-bottom:16px">
              Select advanced technologies from our innovation partners:
            </p>

            <div style="display:grid;gap:12px">
              <div style="padding:16px;background:linear-gradient(135deg,rgba(0,160,220,0.1),rgba(0,160,220,0.05));border-radius:12px;border:1px solid rgba(0,160,220,0.3);cursor:pointer" class="partner-card">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                  <div style="width:40px;height:40px;background:rgba(0,160,220,0.2);border-radius:8px;display:flex;align-items:center;justify-content:center">
                    <span class="material-icons-outlined" style="color:#00a0dc;font-size:20px">filter_alt</span>
                  </div>
                  <div>
                    <div style="font-size:14px;font-weight:600;color:#00a0dc">NX Filtration</div>
                    <div style="font-size:11px;color:var(--muted)">Advanced Membrane Separation</div>
                  </div>
                </div>
                <ul style="font-size:11px;color:var(--muted);margin:0;padding-left:16px">
                  <li>PFAS, micropollutants, pesticides removal</li>
                  <li>Lower pressure than RO, compact footprint</li>
                  <li>High recovery, minimal reject volumes</li>
                </ul>
              </div>

              <div style="padding:16px;background:linear-gradient(135deg,rgba(247,147,30,0.1),rgba(247,147,30,0.05));border-radius:12px;border:1px solid rgba(247,147,30,0.3);cursor:pointer" class="partner-card">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                  <div style="width:40px;height:40px;background:rgba(247,147,30,0.2);border-radius:8px;display:flex;align-items:center;justify-content:center">
                    <span class="material-icons-outlined" style="color:#f7931e;font-size:20px">light_mode</span>
                  </div>
                  <div>
                    <div style="font-size:14px;font-weight:600;color:#f7931e">Atlantium Technologies</div>
                    <div style="font-size:11px;color:var(--muted)">Hydro-Optic UV Disinfection</div>
                  </div>
                </div>
                <ul style="font-size:11px;color:var(--muted);margin:0;padding-left:16px">
                  <li>Dose-assured, chemical-free disinfection</li>
                  <li>Medium pressure, high intensity polychromatic UV</li>
                  <li>Log4+ bacterial elimination via Total Internal Reflection</li>
                </ul>
              </div>

              <div style="padding:16px;background:linear-gradient(135deg,rgba(0,178,122,0.1),rgba(0,178,122,0.05));border-radius:12px;border:1px solid rgba(0,178,122,0.3);cursor:pointer" class="partner-card">
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
                  <div style="width:40px;height:40px;background:rgba(0,178,122,0.2);border-radius:8px;display:flex;align-items:center;justify-content:center">
                    <span class="material-icons-outlined" style="color:#00b27a;font-size:20px">monitoring</span>
                  </div>
                  <div>
                    <div style="font-size:14px;font-weight:600;color:#00b27a">bNovate Technologies</div>
                    <div style="font-size:11px;color:var(--muted)">Real-Time Process Intelligence</div>
                  </div>
                </div>
                <ul style="font-size:11px;color:var(--muted);margin:0;padding-left:16px">
                  <li>&lt;30 minutes real-time microbial detection</li>
                  <li>Data-led decision making</li>
                  <li>Avoids unnecessary shutdowns, CIP, or chemical dosing</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" onclick="goToStep(2)">
            <span class="material-icons-outlined">arrow_back</span>
            Previous
          </button>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
            <button class="btn btn-primary" onclick="goToStep(4)">
              Continue to Design
              <span class="material-icons-outlined">arrow_forward</span>
            </button>
          </div>
        </div>
        </div><!-- End Phase 3: Pilot-Scale Validation -->

        <!-- Phase 4: Detailed Design & Engineering -->
        <div class="step-content" id="step-design">
        <div class="workflow-header">
          <h1 class="workflow-title">Solution Design & Comparison</h1>
          <p class="workflow-subtitle">Compare and rank optimized treatment solutions</p>
        </div>

        <div class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Solutions Analyzed</div>
            <div class="metric-value accent">847</div>
            <div class="metric-change positive">
              <span class="material-icons-outlined" style="font-size:14px">trending_up</span>
              Multi-objective optimization
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Top Confidence</div>
            <div class="metric-value success">89%</div>
            <div class="metric-change positive">
              <span class="material-icons-outlined" style="font-size:14px">verified</span>
              Auto-approve threshold
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Best Water Recovery</div>
            <div class="metric-value accent2">85%</div>
            <div class="metric-change">
              <span class="material-icons-outlined" style="font-size:14px">water_drop</span>
              Above industry avg
            </div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Min Energy</div>
            <div class="metric-value warning">2.8 kWh/m</div>
            <div class="metric-change">
              <span class="material-icons-outlined" style="font-size:14px">bolt</span>
              Optimized selection
            </div>
          </div>
        </div>

        <div class="content-panel full-width" data-persona="technician business sales" data-persona-key="technician">
          <div class="panel-header">
            <div class="panel-title">
              <span class="material-icons-outlined">compare</span>
              Ranked Solutions
            </div>
            <span class="persona-badge technician">Technical</span>
          </div>

          <table class="solution-table">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Technology Train</th>
                <th>CapEx Est.</th>
                <th>OpEx/yr</th>
                <th>Water Recovery</th>
                <th>Energy</th>
                <th>ESG Score</th>
                <th>Confidence</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="solution-rank rank-1">1</span></td>
                <td><strong>UF + RO + UV</strong></td>
                <td>1.2M</td>
                <td>185K</td>
                <td>82%</td>
                <td>2.9 kWh/m</td>
                <td style="color:var(--esg-green)">85</td>
                <td>
                  <div class="confidence-bar"><div class="confidence-fill confidence-high" style="width:89%"></div></div>
                  <span style="font-size:11px;color:var(--muted)">89%</span>
                </td>
              </tr>
              <tr>
                <td><span class="solution-rank rank-2">2</span></td>
                <td><strong>MBR + RO</strong></td>
                <td>1.45M</td>
                <td>210K</td>
                <td>78%</td>
                <td>3.3 kWh/m</td>
                <td style="color:var(--esg-green)">82</td>
                <td>
                  <div class="confidence-bar"><div class="confidence-fill confidence-high" style="width:82%"></div></div>
                  <span style="font-size:11px;color:var(--muted)">82%</span>
                </td>
              </tr>
              <tr>
                <td><span class="solution-rank rank-3">3</span></td>
                <td><strong>DAF + UF + RO</strong></td>
                <td>1.35M</td>
                <td>195K</td>
                <td>80%</td>
                <td>2.85 kWh/m</td>
                <td style="color:var(--esg-green)">79</td>
                <td>
                  <div class="confidence-bar"><div class="confidence-fill confidence-medium" style="width:76%"></div></div>
                  <span style="font-size:11px;color:var(--muted)">76%</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="content-grid" style="margin-top:20px">
          <div class="content-panel" data-persona="technician sales" data-persona-key="technician">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">tune</span>
                Vendor Selection
              </div>
              <span class="persona-badge technician">Technical</span>
            </div>
            <p style="font-size:12px;color:var(--muted);margin-bottom:16px">
              Include or exclude specific vendors in the solution:
            </p>
            <div class="chip-group">
              <div class="chip active">Pentair</div>
              <div class="chip active">Koch</div>
              <div class="chip active">Dow FilmTec</div>
              <div class="chip">Toray</div>
              <div class="chip active">Suez</div>
              <div class="chip">Xylem</div>
            </div>
          </div>

          <div class="content-panel" data-persona="business sales" data-persona-key="business">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">balance</span>
                Optimization Weights
              </div>
              <span class="persona-badge business">Strategy</span>
            </div>
            <div class="range-group">
              <div class="range-header">
                <span class="range-label">Cost Priority</span>
                <span class="range-value">40%</span>
              </div>
              <input type="range" value="40" min="0" max="100">
            </div>
            <div class="range-group">
              <div class="range-header">
                <span class="range-label">ESG Priority</span>
                <span class="range-value">35%</span>
              </div>
              <input type="range" value="35" min="0" max="100">
            </div>
            <div class="range-group">
              <div class="range-header">
                <span class="range-label">Technical Risk</span>
                <span class="range-value">25%</span>
              </div>
              <input type="range" value="25" min="0" max="100">
            </div>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" onclick="goToStep(3)">
            <span class="material-icons-outlined">arrow_back</span>
            Back to Pilot
          </button>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
            <button class="btn btn-primary" onclick="goToStep(5)">
              Continue to Commercial
              <span class="material-icons-outlined">arrow_forward</span>
            </button>
          </div>
        </div>
        </div><!-- End Phase 4: Detailed Design -->

        <!-- Phase 5: Commercial Analysis (Pricing & ESG) -->
        <div class="step-content" id="step-commercial">
        <div class="workflow-header">
          <h1 class="workflow-title">Commercial Analysis</h1>
          <p class="workflow-subtitle">Pricing intelligence with ESG impact assessment and ROI analysis</p>
        </div>

        <div class="metrics-grid" data-persona="business sales customer">
          <div class="metric-card" data-persona-key="business">
            <div class="metric-label">Total CapEx</div>
            <div class="metric-value accent">1.24M</div>
            <div class="metric-change">Base equipment + installation</div>
          </div>
          <div class="metric-card" data-persona-key="business">
            <div class="metric-label">Annual OpEx</div>
            <div class="metric-value warning">185K</div>
            <div class="metric-change">Energy + chemicals + labor</div>
          </div>
          <div class="metric-card" data-persona-key="business">
            <div class="metric-label">10yr NPV</div>
            <div class="metric-value accent2">2.89M</div>
            <div class="metric-change">At 8% discount rate</div>
          </div>
          <div class="metric-card" data-persona-key="customer">
            <div class="metric-label">Recommended Price</div>
            <div class="metric-value success">1.49M</div>
            <div class="metric-change positive">20% margin</div>
          </div>
        </div>

        <div class="content-grid">
          <div class="content-panel" data-persona="business sales" data-persona-key="business">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">pie_chart</span>
                CapEx Breakdown
              </div>
              <span class="persona-badge business">Financial</span>
            </div>

            <div class="cost-bar">
              <div class="cost-segment" style="width:45%;background:var(--accent)">Equipment</div>
              <div class="cost-segment" style="width:25%;background:var(--accent2)">Install</div>
              <div class="cost-segment" style="width:15%;background:var(--accent3)">Controls</div>
              <div class="cost-segment" style="width:15%;background:var(--warning)">Other</div>
            </div>

            <div class="cost-legend">
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--accent)"></div>
                <span>Equipment 558K</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--accent2)"></div>
                <span>Installation 310K</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--accent3)"></div>
                <span>Controls 186K</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--warning)"></div>
                <span>Other 186K</span>
              </div>
            </div>
          </div>

          <div class="content-panel" data-persona="business sales customer" data-persona-key="business">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">trending_up</span>
                OpEx Projection (10yr)
              </div>
              <span class="persona-badge business">ROI</span>
            </div>

            <div id="opex-chart" style="height:200px;display:flex;align-items:flex-end;gap:8px;padding:20px 0">
              <!-- Simple bar chart -->
            </div>

            <div class="cost-legend" style="margin-top:16px">
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--accent)"></div>
                <span>Energy (42%)</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--accent2)"></div>
                <span>Chemicals (28%)</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--warning)"></div>
                <span>Maintenance (18%)</span>
              </div>
              <div class="legend-item">
                <div class="legend-dot" style="background:var(--muted)"></div>
                <span>Labor (12%)</span>
              </div>
            </div>
          </div>

          <div class="content-panel" data-persona="business sales" data-persona-key="sales">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">sell</span>
                Pricing Strategy
              </div>
              <span class="persona-badge sales">Sales</span>
            </div>

            <div class="form-group">
              <label class="form-label">Contract Model</label>
              <div class="chip-group">
                <div class="chip active">CapEx Sale</div>
                <div class="chip">BOO</div>
                <div class="chip">BOT</div>
                <div class="chip">Service</div>
              </div>
            </div>

            <div class="range-group">
              <div class="range-header">
                <span class="range-label">Target Margin</span>
                <span class="range-value">20%</span>
              </div>
              <input type="range" value="20" min="10" max="40">
            </div>

            <div style="padding:12px;background:rgba(99,102,241,0.1);border-radius:10px;border:1px solid rgba(99,102,241,0.3)">
              <div style="font-size:12px;color:var(--muted);margin-bottom:4px">Win Probability Model</div>
              <div style="font-size:18px;font-weight:700;color:var(--accent)">72% @ 1.49M</div>
              <div style="font-size:11px;color:var(--muted)">Based on segment history + competitive positioning</div>
            </div>
          </div>

          <div class="content-panel" data-persona="business sales" data-persona-key="business">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">analytics</span>
                Component Pricing
              </div>
              <span class="persona-badge business">Financial</span>
            </div>

            <table class="solution-table" style="font-size:12px">
              <thead>
                <tr>
                  <th>Component</th>
                  <th>Base Cost ()</th>
                  <th>Marked Up ()</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>RO System with Pretreatment 5m Filter</td>
                  <td>15,954</td>
                  <td>20,740</td>
                </tr>
                <tr>
                  <td>Universal Unit for Flushing with Permeate</td>
                  <td>700</td>
                  <td>910</td>
                </tr>
                <tr>
                  <td>RO Membranes</td>
                  <td>4,140</td>
                  <td>5,382</td>
                </tr>
                <tr>
                  <td>Hardness - Anti Scale Dosing</td>
                  <td>1,400</td>
                  <td>1,820</td>
                </tr>
                <tr>
                  <td>CIP System</td>
                  <td>4,716</td>
                  <td>6,131</td>
                </tr>
                <tr>
                  <td>Container</td>
                  <td>5,500</td>
                  <td>7,150</td>
                </tr>
                <tr>
                  <td>Pipework</td>
                  <td>9,000</td>
                  <td>11,700</td>
                </tr>
                <tr>
                  <td>Labour</td>
                  <td>10,000</td>
                  <td>13,000</td>
                </tr>
                <tr>
                  <td>Shipping</td>
                  <td>1,500</td>
                  <td>1,950</td>
                </tr>
                <tr>
                  <td>pH Adjustment - Dosing</td>
                  <td>1,400</td>
                  <td>1,820</td>
                </tr>
                <tr style="background:rgba(99,102,241,0.08)">
                  <td><strong>Base Total</strong></td>
                  <td><strong>54,310</strong></td>
                  <td><strong>70,603</strong></td>
                </tr>
              </tbody>
            </table>

            <div style="margin-top:16px;padding:12px;background:rgba(34,211,238,0.1);border-radius:10px;border:1px solid rgba(34,211,238,0.3)">
              <div style="font-size:11px;color:var(--muted);margin-bottom:8px">Pricing Summary</div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:12px">
                <div>Base Manufacturing Cost:</div><div style="text-align:right;font-weight:600">70,603.00</div>
                <div>Workshop (5%):</div><div style="text-align:right">3,530.15</div>
                <div>Contingency (5%):</div><div style="text-align:right">3,530.15</div>
                <div>Social Impact (2%):</div><div style="text-align:right">1,412.06</div>
                <div style="border-top:1px solid var(--line);padding-top:8px"><strong>Subtotal:</strong></div>
                <div style="border-top:1px solid var(--line);padding-top:8px;text-align:right"><strong>79,075.36</strong></div>
                <div style="color:var(--success)">Estimated GM:</div><div style="text-align:right;color:var(--success);font-weight:600">31%</div>
                <div style="color:var(--accent)">Estimated GP:</div><div style="text-align:right;color:var(--accent);font-weight:600">24,765.36</div>
              </div>
            </div>
          </div>

          <!-- ESG & Carbon Metrics Panel -->
          <div class="content-panel" data-persona="technician business sales customer" data-persona-key="customer">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">eco</span>
                ESG & Carbon Impact
              </div>
              <span class="panel-badge">Sustainability</span>
              <span class="persona-badge customer">Customer</span>
            </div>

            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:16px">
              <div style="padding:16px;background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(34,197,94,0.05));border-radius:12px;border:1px solid rgba(34,197,94,0.3);text-align:center">
                <div style="font-size:24px;font-weight:700;color:var(--success)">1,240</div>
                <div style="font-size:11px;color:var(--muted)">tCOe/yr avoided</div>
                <div style="font-size:10px;color:var(--success);margin-top:4px">Carbon Savings</div>
              </div>
              <div style="padding:16px;background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(59,130,246,0.05));border-radius:12px;border:1px solid rgba(59,130,246,0.3);text-align:center">
                <div style="font-size:24px;font-weight:700;color:#3b82f6">82%</div>
                <div style="font-size:11px;color:var(--muted)">328K m/yr saved</div>
                <div style="font-size:10px;color:#3b82f6;margin-top:4px">Water Recovery</div>
              </div>
              <div style="padding:16px;background:linear-gradient(135deg,rgba(168,85,247,0.1),rgba(168,85,247,0.05));border-radius:12px;border:1px solid rgba(168,85,247,0.3);text-align:center">
                <div style="font-size:24px;font-weight:700;color:#a855f7">2.9</div>
                <div style="font-size:11px;color:var(--muted)">kWh/m (vs 4.5 baseline)</div>
                <div style="font-size:10px;color:#a855f7;margin-top:4px">Energy Efficiency</div>
              </div>
              <div style="padding:16px;background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(245,158,11,0.05));border-radius:12px;border:1px solid rgba(245,158,11,0.3);text-align:center">
                <div style="font-size:24px;font-weight:700;color:var(--warning)">85</div>
                <div style="font-size:11px;color:var(--muted)">out of 100</div>
                <div style="font-size:10px;color:var(--warning);margin-top:4px">ESG Score</div>
              </div>
            </div>

            <div style="display:flex;flex-wrap:wrap;gap:8px">
              <div style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(34,197,94,0.1);border-radius:20px;font-size:11px;color:var(--success)">
                <span class="material-icons-outlined" style="font-size:14px">check_circle</span>
                ISO 14001 Aligned
              </div>
              <div style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(34,197,94,0.1);border-radius:20px;font-size:11px;color:var(--success)">
                <span class="material-icons-outlined" style="font-size:14px">check_circle</span>
                CDP Water Security
              </div>
              <div style="display:flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(34,197,94,0.1);border-radius:20px;font-size:11px;color:var(--success)">
                <span class="material-icons-outlined" style="font-size:14px">check_circle</span>
                GRI Standards
              </div>
            </div>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" onclick="goToStep(4)">
            <span class="material-icons-outlined">arrow_back</span>
            Back to Design
          </button>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
            <button class="btn btn-primary" onclick="goToStep(6)">
              Generate Proposal
              <span class="material-icons-outlined">arrow_forward</span>
            </button>
          </div>
        </div>
        </div><!-- End Phase 5: Commercial Analysis -->

        <!-- Phase 6: Proposal Generation -->
        <div class="step-content" id="step-generate">
        <div class="workflow-header">
          <h1 class="workflow-title">Generate Proposal</h1>
          <p class="workflow-subtitle">Review and export your complete technical and commercial proposal</p>
        </div>

        <div class="content-grid">
          <div class="content-panel" data-persona="technician business sales" data-persona-key="business">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">checklist</span>
                Pre-flight Checklist
              </div>
              <span class="persona-badge business">Governance</span>
            </div>

            <div style="display:flex;flex-direction:column;gap:10px">
              <div style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
                <span class="material-icons-outlined" style="color:var(--success);font-size:20px">check_circle</span>
                <div>
                  <div style="font-size:13px;font-weight:600">Customer Requirements</div>
                  <div style="font-size:11px;color:var(--muted)">All specifications captured</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
                <span class="material-icons-outlined" style="color:var(--success);font-size:20px">check_circle</span>
                <div>
                  <div style="font-size:13px;font-weight:600">Technical Solution</div>
                  <div style="font-size:11px;color:var(--muted)">UF + RO + UV train validated (89% confidence)</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
                <span class="material-icons-outlined" style="color:var(--success);font-size:20px">check_circle</span>
                <div>
                  <div style="font-size:13px;font-weight:600">Pricing Complete</div>
                  <div style="font-size:11px;color:var(--muted)">CapEx: 1.49M | OpEx: 185K/yr</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(34,197,94,0.1);border-radius:10px;border:1px solid rgba(34,197,94,0.3)">
                <span class="material-icons-outlined" style="color:var(--success);font-size:20px">check_circle</span>
                <div>
                  <div style="font-size:13px;font-weight:600">ESG Analysis</div>
                  <div style="font-size:11px;color:var(--muted)">Score: 85/100 | Carbon: 1,240 tCOe avoided</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(99,102,241,0.1);border-radius:10px;border:1px solid rgba(99,102,241,0.3)">
                <span class="material-icons-outlined" style="color:var(--accent);font-size:20px">info</span>
                <div>
                  <div style="font-size:13px;font-weight:600">Engineer Override</div>
                  <div style="font-size:11px;color:var(--muted)">No manual overrides applied</div>
                </div>
              </div>
            </div>
          </div>

          <div class="content-panel" data-persona="technician business sales customer" data-persona-key="sales">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">download</span>
                Export Options
              </div>
              <span class="persona-badge sales">Sales</span>
            </div>

            <div style="display:flex;flex-direction:column;gap:12px">
              <button class="btn btn-primary" style="width:100%;justify-content:center;padding:14px" onclick="exportProposal('pdf')">
                <span class="material-icons-outlined">picture_as_pdf</span>
                Export as PDF
              </button>
              <button class="btn btn-secondary" style="width:100%;justify-content:center;padding:14px" onclick="exportProposal('word')">
                <span class="material-icons-outlined">description</span>
                Export as Word Document
              </button>
              <button class="btn btn-secondary" style="width:100%;justify-content:center;padding:14px" onclick="exportProposal('json')">
                <span class="material-icons-outlined">data_object</span>
                Export as JSON (API)
              </button>
              <button class="btn btn-secondary" style="width:100%;justify-content:center;padding:14px" onclick="exportProposal('email')">
                <span class="material-icons-outlined">email</span>
                Send via Email
              </button>
            </div>

            <div style="margin-top:20px;padding:16px;background:rgba(0,0,0,0.2);border-radius:12px">
              <div style="font-size:12px;color:var(--muted);margin-bottom:8px">Template Selection</div>
              <select class="form-input">
                <option>MembraCon Standard Template</option>
                <option>Technical Detail Template</option>
                <option>Executive Summary Only</option>
                <option>ESG-Focused Template</option>
              </select>
            </div>
          </div>

          <div class="content-panel full-width" data-persona="technician business sales customer" data-persona-key="customer">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">preview</span>
                Proposal Preview
              </div>
              <span class="persona-badge customer">Customer</span>
              <div style="display:flex;gap:8px">
                <button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">
                  <span class="material-icons-outlined" style="font-size:14px">edit</span>
                  Edit
                </button>
                <button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">
                  <span class="material-icons-outlined" style="font-size:14px">fullscreen</span>
                  Full Screen
                </button>
              </div>
            </div>

            <div class="proposal-preview">
              <div style="text-align:center;margin-bottom:24px">
                <div style="font-size:28px;font-weight:700;color:#1e40af">MembraCon</div>
                <div style="font-size:14px;color:#6b7280">Water Treatment Solutions</div>
              </div>

              <h1>Technical Proposal</h1>
              <p style="color:#6b7280">
                <strong>Client:</strong> Riverside Pharmaceuticals Ltd<br>
                <strong>Reference:</strong> PROP-2026-00142<br>
                <strong>Date:</strong> 21 January 2026
              </p>

              <h2>Executive Summary</h2>
              <p>
                Based on your requirements for <strong>200 m/h</strong> purified water production,
                we propose a comprehensive <strong>UF + RO + UV</strong> treatment system.
                This solution achieves pharmaceutical-grade water quality with 99.3% TDS rejection
                and validated disinfection, while maintaining excellent water recovery of 82%.
              </p>
              <p>
                The proposed system offers a compelling ESG profile with 1,240 tonnes COe annual
                carbon savings and industry-leading energy efficiency at 2.9 kWh/m.
              </p>

              <h2>Technical Solution</h2>
              <table>
                <tr>
                  <th>Stage</th>
                  <th>Technology</th>
                  <th>Function</th>
                  <th>Vendor</th>
                </tr>
                <tr>
                  <td>1</td>
                  <td>Ultrafiltration (UF)</td>
                  <td>Pre-treatment, particle removal</td>
                  <td>Pentair X-Flow</td>
                </tr>
                <tr>
                  <td>2</td>
                  <td>Reverse Osmosis (RO)</td>
                  <td>Desalination, demineralization</td>
                  <td>Dow FilmTec BW30</td>
                </tr>
                <tr>
                  <td>3</td>
                  <td>UV Disinfection</td>
                  <td>Validated pathogen inactivation</td>
                  <td>Trojan UV Swift</td>
                </tr>
              </table>

              <h2>Water Quality Performance</h2>
              <table>
                <tr>
                  <th>Parameter</th>
                  <th>Feed Water</th>
                  <th>Target</th>
                  <th>Guaranteed</th>
                </tr>
                <tr>
                  <td>TDS (mg/L)</td>
                  <td>1,500</td>
                  <td>&lt;10</td>
                  <td style="color:#16a34a;font-weight:600">&lt;10</td>
                </tr>
                <tr>
                  <td>TSS (mg/L)</td>
                  <td>50</td>
                  <td>&lt;0.1</td>
                  <td style="color:#16a34a;font-weight:600">&lt;0.1</td>
                </tr>
                <tr>
                  <td>BOD (mg/L)</td>
                  <td>120</td>
                  <td>&lt;1</td>
                  <td style="color:#16a34a;font-weight:600">&lt;1</td>
                </tr>
              </table>

              <h2>Commercial Summary</h2>
              <table>
                <tr>
                  <td style="width:70%">Capital Investment (CapEx)</td>
                  <td style="font-size:18px;font-weight:700;color:#1e40af">1,490,000</td>
                </tr>
                <tr>
                  <td>Annual Operating Cost (OpEx)</td>
                  <td style="font-weight:600">185,000</td>
                </tr>
                <tr>
                  <td>10-Year Total Cost of Ownership</td>
                  <td style="font-weight:600">2,890,000</td>
                </tr>
                <tr>
                  <td>Estimated Payback Period</td>
                  <td style="font-weight:600">3.2 years</td>
                </tr>
              </table>

              <h2>ESG Impact</h2>
              <table>
                <tr>
                  <th>Metric</th>
                  <th>Value</th>
                  <th>Benchmark</th>
                </tr>
                <tr>
                  <td>Water Recovery</td>
                  <td>82%</td>
                  <td style="color:#16a34a">Above industry avg (75%)</td>
                </tr>
                <tr>
                  <td>Carbon Reduction</td>
                  <td>1,240 tCOe/yr</td>
                  <td style="color:#16a34a">75% vs baseline</td>
                </tr>
                <tr>
                  <td>Energy Efficiency</td>
                  <td>2.9 kWh/m</td>
                  <td style="color:#16a34a">36% better than baseline</td>
                </tr>
                <tr style="background:#dbeafe">
                  <td><strong>Overall ESG Score</strong></td>
                  <td colspan="2"><strong style="font-size:18px;color:#1e40af">85/100</strong></td>
                </tr>
              </table>

              <div style="margin-top:32px;padding:16px;background:#f0fdf4;border-radius:8px;border:1px solid #86efac">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                  <span style="color:#16a34a;font-size:20px">&#10003;</span>
                  <strong style="color:#166534">AI Confidence: 89%</strong>
                </div>
                <p style="margin:0;font-size:13px;color:#166534">
                  This proposal was generated by the MembraCon WaterLogic AI system with high confidence.
                  All technical parameters have been validated against industry standards and historical performance data.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="action-bar">
          <button class="btn btn-secondary" onclick="goToStep(5)">
            <span class="material-icons-outlined">arrow_back</span>
            Back to Commercial
          </button>
          <div style="display:flex;gap:12px">
            <button class="btn btn-secondary" onclick="saveDraft()">
              <span class="material-icons-outlined">save</span>
              Save to Projects
            </button>
            <button class="btn btn-success" onclick="finalizeProposal()">
              <span class="material-icons-outlined">send</span>
              Finalize & Send
            </button>
          </div>
        </div>
        </div><!-- End Phase 6: Proposal Generation -->

      </div><!-- End view-proposal -->

      <!-- Projects View -->
      <div class="view" id="view-projects">
        <div class="workflow-header">
          <h1 class="workflow-title">All Projects</h1>
          <p class="workflow-subtitle">Manage and track your proposal projects</p>
        </div>

        <div class="content-grid">
          <div class="content-panel full-width">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">folder_open</span>
                Project List
              </div>
              <button class="btn btn-primary" onclick="document.querySelector('[data-view=proposal]').click()">
                <span class="material-icons-outlined">add</span>
                New Proposal
              </button>
            </div>

            <table class="solution-table">
              <thead>
                <tr>
                  <th>Project Name</th>
                  <th>Client</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Value</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Riverside Pharma - Purified Water</strong></td>
                  <td>Riverside Pharmaceuticals</td>
                  <td><span class="project-stage stage-design">In Design</span></td>
                  <td>18 Jan 2026</td>
                  <td>1.49M</td>
                  <td><button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">Open</button></td>
                </tr>
                <tr>
                  <td><strong>Nordic Foods - Wastewater</strong></td>
                  <td>Nordic Foods Ltd</td>
                  <td><span class="project-stage stage-pricing">Pricing</span></td>
                  <td>15 Jan 2026</td>
                  <td>2.1M</td>
                  <td><button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">Open</button></td>
                </tr>
                <tr>
                  <td><strong>GreenEnergy - Cooling Tower</strong></td>
                  <td>GreenEnergy plc</td>
                  <td><span class="project-stage stage-proposal">Proposal Ready</span></td>
                  <td>10 Jan 2026</td>
                  <td>3.2M</td>
                  <td><button class="btn btn-secondary" style="padding:6px 12px;font-size:11px">Open</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Documentation View -->
      <div class="view" id="view-docs">
        <div class="workflow-header">
          <h1 class="workflow-title">System Architecture</h1>
          <p class="workflow-subtitle">Interactive visualization and documentation for the AI Proposal System</p>
        </div>

        <div class="content-grid">
          <div class="content-panel" style="cursor:pointer" onclick="window.open('ai-proposal-d3.html', '_blank')">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">hub</span>
                Decision Intelligence Network
              </div>
              <span class="material-icons-outlined" style="color:var(--accent)">open_in_new</span>
            </div>
            <div style="padding:20px;background:linear-gradient(135deg, rgba(99,102,241,0.1), rgba(34,211,238,0.08));border-radius:12px;margin-bottom:16px">
              <div style="display:flex;align-items:center;justify-content:center;gap:16px;flex-wrap:wrap">
                <div style="text-align:center">
                  <div style="font-size:28px;font-weight:700;color:var(--accent)">18</div>
                  <div style="font-size:11px;color:var(--muted)">Decision Nodes</div>
                </div>
                <div style="text-align:center">
                  <div style="font-size:28px;font-weight:700;color:var(--accent2)">26</div>
                  <div style="font-size:11px;color:var(--muted)">Data Flows</div>
                </div>
                <div style="text-align:center">
                  <div style="font-size:28px;font-weight:700;color:var(--accent3)">6</div>
                  <div style="font-size:11px;color:var(--muted)">Perspectives</div>
                </div>
              </div>
            </div>
            <p style="font-size:12px;color:var(--muted);margin:0">
              Interactive D3.js visualization showing the complete system architecture including inputs, core processing, governance, and learning agents.
            </p>
          </div>

          <div class="content-panel">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">description</span>
                Documentation
              </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px">
              <a href="AI-PROPOSAL-SYSTEM.md" target="_blank" style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,0.15);border-radius:10px;border:1px solid var(--line);text-decoration:none;color:var(--text);transition:all 0.15s ease">
                <span class="material-icons-outlined" style="color:var(--accent)">article</span>
                <div style="flex:1">
                  <div style="font-size:13px;font-weight:600">System Overview</div>
                  <div style="font-size:11px;color:var(--muted)">Complete architecture documentation</div>
                </div>
                <span class="material-icons-outlined" style="font-size:16px;color:var(--muted)">chevron_right</span>
              </a>
              <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,0.15);border-radius:10px;border:1px solid var(--line)">
                <span class="material-icons-outlined" style="color:var(--accent2)">calculate</span>
                <div style="flex:1">
                  <div style="font-size:13px;font-weight:600">Mathematical Framework</div>
                  <div style="font-size:11px;color:var(--muted)">Equations & optimization models</div>
                </div>
                <span class="material-icons-outlined" style="font-size:16px;color:var(--muted)">chevron_right</span>
              </div>
              <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,0.15);border-radius:10px;border:1px solid var(--line)">
                <span class="material-icons-outlined" style="color:var(--warning)">science</span>
                <div style="flex:1">
                  <div style="font-size:13px;font-weight:600">Technology Catalog</div>
                  <div style="font-size:11px;color:var(--muted)">UF, MBR, RO, UV, AOP specs</div>
                </div>
                <span class="material-icons-outlined" style="font-size:16px;color:var(--muted)">chevron_right</span>
              </div>
              <div style="display:flex;align-items:center;gap:12px;padding:12px;background:rgba(0,0,0,0.15);border-radius:10px;border:1px solid var(--line)">
                <span class="material-icons-outlined" style="color:var(--esg-green)">eco</span>
                <div style="flex:1">
                  <div style="font-size:13px;font-weight:600">ESG Framework</div>
                  <div style="font-size:11px;color:var(--muted)">Sustainability metrics & reporting</div>
                </div>
                <span class="material-icons-outlined" style="font-size:16px;color:var(--muted)">chevron_right</span>
              </div>
            </div>
          </div>

          <div class="content-panel full-width">
            <div class="panel-header">
              <div class="panel-title">
                <span class="material-icons-outlined">layers</span>
                System Components
              </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px">
              <div style="padding:16px;background:rgba(99,102,241,0.1);border-radius:12px;border:1px solid rgba(99,102,241,0.3)">
                <div style="font-size:13px;font-weight:700;color:var(--accent);margin-bottom:8px">Inputs Layer</div>
                <ul style="font-size:11px;color:var(--muted);margin:0;padding-left:16px;line-height:1.8">
                  <li>Customer Case Inputs</li>
                  <li>Existing Artifacts</li>
                  <li>Technology Catalog</li>
                  <li>Historical Context</li>
                  <li>ESG Framework</li>
                </ul>
              </div>
              <div style="padding:16px;background:rgba(168,85,247,0.1);border-radius:12px;border:1px solid rgba(168,85,247,0.3)">
                <div style="font-size:13px;font-weight:700;color:var(--accent3);margin-bottom:8px">Core Processing</div>
                <ul style="font-size:11px;color:var(--muted);margin:0;padding-left:16px;line-height:1.8">
                  <li>Knowledge Graph</li>
                  <li>Decision Nodes</li>
                  <li>Simulators</li>
                  <li>AI Engine</li>
                  <li>Pricing & ESG</li>
                </ul>
              </div>
              <div style="padding:16px;background:rgba(245,158,11,0.1);border-radius:12px;border:1px solid rgba(245,158,11,0.3)">
                <div style="font-size:13px;font-weight:700;color:var(--warning);margin-bottom:8px">Governance</div>
                <ul style="font-size:11px;color:var(--muted);margin:0;padding-left:16px;line-height:1.8">
                  <li>Decision Ledger</li>
                  <li>Policy Enforcement</li>
                  <li>Approval Workflows</li>
                  <li>Audit Trail</li>
                  <li>Compliance Checks</li>
                </ul>
              </div>
              <div style="padding:16px;background:rgba(34,211,238,0.1);border-radius:12px;border:1px solid rgba(34,211,238,0.3)">
                <div style="font-size:13px;font-weight:700;color:var(--accent2);margin-bottom:8px">Learning Agents</div>
                <ul style="font-size:11px;color:var(--muted);margin:0;padding-left:16px;line-height:1.8">
                  <li>Win/Loss Agent</li>
                  <li>Pricing Agent</li>
                  <li>Tech Performance</li>
                  <li>ESG Tracking</li>
                  <li>Knowledge Ingestion</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Keyboard Mode Help Bar -->
  <div class="keyboard-mode-bar" id="keyboardModeBar">
    <span><kbd>Ctrl</kbd>+<kbd>K</kbd> Toggle Mode</span>
    <span class="separator"></span>
    <span><kbd>1</kbd>-<kbd>5</kbd> Steps</span>
    <span class="separator"></span>
    <span><kbd></kbd><kbd></kbd> Navigate</span>
    <span class="separator"></span>
    <span><kbd>Tab</kbd> Next Field</span>
    <span class="separator"></span>
    <span><kbd>Esc</kbd> Exit Mode</span>
    <span class="separator"></span>
    <span><kbd>N</kbd> Continue</span>
    <span class="separator"></span>
    <span><kbd>G</kbd> Save</span>
  </div>

  <!-- AI Sidebar -->
  <aside class="ai-sidebar" id="aiSidebar">
    <div class="ai-header">
      <div class="ai-header-icon">
        <span class="material-icons-outlined">auto_awesome</span>
      </div>
      <div class="ai-header-text">
        <h3>AI Assistant</h3>
        <p>Intelligent proposal support</p>
      </div>
      <button class="ai-header-close" onclick="toggleAI()">
        <span class="material-icons-outlined">close</span>
      </button>
    </div>

    <div class="ai-tabs">
      <div class="ai-tab active" data-tab="suggest" onclick="setAITab('suggest')">Suggest</div>
      <div class="ai-tab" data-tab="scenarios" onclick="setAITab('scenarios')">Scenarios</div>
      <div class="ai-tab" data-tab="wizard" onclick="setAITab('wizard')">Wizard</div>
      <div class="ai-tab" data-tab="decisions" onclick="setAITab('decisions')">Trail</div>
      <div class="ai-tab" data-tab="similar" onclick="setAITab('similar')">Similar</div>
    </div>

    <div class="ai-content">
      <!-- Smart Suggestions Panel -->
      <div class="ai-tab-panel active" id="ai-panel-suggest">
        <!-- Quick Actions Bar -->
        <div class="quick-actions-bar">
          <input type="text" id="quickActionInput" placeholder="Try: 'add UV' or 'pharma application'" onkeypress="if(event.key==='Enter')executeQuickAction()">
          <button onclick="executeQuickAction()">Go</button>
        </div>

        <div class="quick-actions-chips">
          <span class="quick-chip" onclick="quickAction('optimize')">Optimize cost</span>
          <span class="quick-chip" onclick="quickAction('premium')">Go premium</span>
          <span class="quick-chip" onclick="quickAction('esg')">Max ESG</span>
          <span class="quick-chip" onclick="quickAction('compare')">Compare options</span>
        </div>

        <!-- AI Confidence -->
        <div class="ai-recommendation">
          <div class="ai-rec-header">
            <div class="ai-rec-icon">
              <span class="material-icons-outlined">lightbulb</span>
            </div>
            <span class="ai-rec-title">Proposal Confidence</span>
            <span class="confidence-badge high" id="aiConfidenceBadge">92%</span>
          </div>
          <div class="confidence-bar">
            <div class="confidence-fill high" id="aiConfidenceBar" style="width: 92%"></div>
          </div>
        </div>

        <!-- Dynamic Suggestions -->
        <div id="aiSuggestions">
          <!-- Suggestions will be populated dynamically -->
        </div>
      </div>

      <!-- Scenario Builder Panel -->
      <div class="ai-tab-panel" id="ai-panel-scenarios">
        <div style="margin-bottom: 12px;">
          <span style="font-size: 11px; font-weight: 600; color: var(--text);">Solution Scenarios</span>
          <p style="font-size: 10px; color: var(--muted); margin-top: 4px;">AI-generated options based on your requirements</p>
        </div>
        <div class="scenario-grid" id="scenarioGrid">
          <!-- Scenarios will be populated dynamically -->
        </div>
      </div>

      <!-- Guided Wizard Panel -->
      <div class="ai-tab-panel" id="ai-panel-wizard">
        <div class="wizard-progress" id="wizardProgress">
          <div class="wizard-step current"></div>
          <div class="wizard-step"></div>
          <div class="wizard-step"></div>
          <div class="wizard-step"></div>
          <div class="wizard-step"></div>
        </div>
        <div id="wizardContent">
          <!-- Wizard questions will be populated dynamically -->
        </div>
      </div>

      <!-- Decisions Panel -->
      <div class="ai-tab-panel" id="ai-panel-decisions">
        <div style="margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="font-size: 11px; font-weight: 600; color: var(--text);">Decision Trail</span>
            <span style="font-size: 10px; color: var(--muted);" id="decisionCount">0 decisions</span>
          </div>
        </div>
        <div id="decisionTrail">
          <!-- Decisions will be populated here -->
        </div>
      </div>

      <!-- Similar Projects Panel -->
      <div class="ai-tab-panel" id="ai-panel-similar">
        <div style="margin-bottom: 12px;">
          <span style="font-size: 11px; font-weight: 600; color: var(--text);">Similar Past Projects</span>
        </div>
        <div id="similarProjects">
          <div class="similar-project">
            <div class="similar-project-header">
              <span class="similar-project-name">Pharma Co - Lab Water</span>
              <span class="similar-project-match">94% match</span>
            </div>
            <div class="similar-project-details">
              RO + UV + NX Filtration | 200 m/h | 285,000 | Won
            </div>
          </div>
          <div class="similar-project">
            <div class="similar-project-header">
              <span class="similar-project-name">BioTech Ltd - Process Water</span>
              <span class="similar-project-match">87% match</span>
            </div>
            <div class="similar-project-details">
              UF + RO | 150 m/h | 198,000 | Won
            </div>
          </div>
          <div class="similar-project">
            <div class="similar-project-header">
              <span class="similar-project-name">MediCare - Clean Water</span>
              <span class="similar-project-match">82% match</span>
            </div>
            <div class="similar-project-details">
              RO + Atlantium UV | 100 m/h | 142,000 | Lost (price)
            </div>
          </div>
        </div>
        <div style="margin-top: 16px; padding: 10px; background: rgba(59,130,246,0.1); border-radius: 8px; border: 1px solid rgba(59,130,246,0.2);">
          <div style="font-size: 11px; font-weight: 600; color: #3b82f6; margin-bottom: 4px;">
            <span class="material-icons-outlined" style="font-size: 14px; vertical-align: middle;">insights</span>
            Pricing Insight
          </div>
          <div style="font-size: 10px; color: var(--muted);">
            Similar projects closed at 142,000 - 285,000. Consider including technology partners for competitive edge.
          </div>
        </div>
      </div>
    </div>
  </aside>

  <script>
    // Theme Toggle
    function toggleTheme() {
      const html = document.documentElement;
      const themeIcon = document.getElementById('themeIcon');
      const currentTheme = html.getAttribute('data-theme');

      if (currentTheme === 'light') {
        html.removeAttribute('data-theme');
        themeIcon.textContent = 'light_mode';
        localStorage.setItem('theme', 'dark');
      } else {
        html.setAttribute('data-theme', 'light');
        themeIcon.textContent = 'dark_mode';
        localStorage.setItem('theme', 'light');
      }
    }

    // Toggle Persona Selector visibility
    function togglePersonaSelector() {
      const selector = document.getElementById('personaSelector');
      const toggle = document.getElementById('personaToggle');
      const icon = document.getElementById('personaToggleIcon');
      const isHidden = selector.classList.toggle('hidden');

      if (isHidden) {
        icon.textContent = 'person_search';
        toggle.title = 'Show persona views';
      } else {
        icon.textContent = 'groups';
        toggle.title = 'Hide persona views';
      }

      // Update toggle button state if a filter is active
      updatePersonaToggleState();
      localStorage.setItem('personaSelectorHidden', isHidden);
    }

    // Update toggle button to show if a non-default persona is active
    function updatePersonaToggleState() {
      const toggle = document.getElementById('personaToggle');
      const activePersona = document.querySelector('.persona-chip.active');
      const isFiltered = activePersona && activePersona.dataset.persona !== 'all';
      const isHidden = document.getElementById('personaSelector').classList.contains('hidden');

      if (isFiltered && isHidden) {
        toggle.classList.add('has-filter');
        toggle.title = `Viewing: ${activePersona.dataset.persona} (click to change)`;
      } else {
        toggle.classList.remove('has-filter');
      }
    }

    // Load saved persona selector state
    (function() {
      const hidden = localStorage.getItem('personaSelectorHidden') === 'true';
      if (hidden) {
        const selector = document.getElementById('personaSelector');
        const icon = document.getElementById('personaToggleIcon');
        if (selector) selector.classList.add('hidden');
        if (icon) icon.textContent = 'person_search';
      }
    })();

    // Load saved theme on page load
    (function() {
      const savedTheme = localStorage.getItem('theme');
      const themeIcon = document.getElementById('themeIcon');
      if (savedTheme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        if (themeIcon) themeIcon.textContent = 'dark_mode';
      }
    })();

    // Keyboard Mode
    let keyboardModeActive = false;

    function toggleKeyboardMode() {
      keyboardModeActive = !keyboardModeActive;
      const html = document.documentElement;
      const keyboardIcon = document.getElementById('keyboardIcon');
      const keyboardToggle = document.getElementById('keyboardToggle');

      if (keyboardModeActive) {
        html.setAttribute('data-keyboard-mode', 'true');
        keyboardIcon.textContent = 'keyboard_hide';
        keyboardToggle.classList.add('keyboard-toggle');
        localStorage.setItem('keyboardMode', 'true');
        showNotification('keyboard', 'Keyboard mode ON - Press letter keys to focus fields', 'info');
      } else {
        html.removeAttribute('data-keyboard-mode');
        keyboardIcon.textContent = 'keyboard';
        keyboardToggle.classList.remove('keyboard-toggle');
        localStorage.setItem('keyboardMode', 'false');
      }
    }

    // Global keyboard event listener
    document.addEventListener('keydown', (e) => {
      // Don't trigger shortcuts when typing in inputs (unless Escape or Ctrl+K)
      const isTyping = document.activeElement.tagName === 'INPUT' ||
                       document.activeElement.tagName === 'TEXTAREA' ||
                       document.activeElement.tagName === 'SELECT';

      // Ctrl+K toggles keyboard mode
      if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        toggleKeyboardMode();
        return;
      }

      // Escape exits keyboard mode or blurs current input
      if (e.key === 'Escape') {
        if (isTyping) {
          document.activeElement.blur();
        } else if (keyboardModeActive) {
          toggleKeyboardMode();
        }
        return;
      }

      // If typing, only handle Tab normally
      if (isTyping) return;

      // Only process shortcuts in keyboard mode
      if (!keyboardModeActive) return;

      // Step navigation with number keys 1-5
      if (['1', '2', '3', '4', '5'].includes(e.key)) {
        e.preventDefault();
        goToStep(parseInt(e.key));
        return;
      }

      // Arrow keys for step navigation
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault();
        if (currentStep < totalSteps) goToStep(currentStep + 1);
        return;
      }

      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        if (currentStep > 1) goToStep(currentStep - 1);
        return;
      }

      // N = Next step (Continue)
      if (e.key === 'n' || e.key === 'N') {
        e.preventDefault();
        if (currentStep < totalSteps) goToStep(currentStep + 1);
        return;
      }

      // G = Save draft
      if (e.key === 'g' || e.key === 'G') {
        e.preventDefault();
        saveDraft();
        return;
      }

      // Focus input fields by shortcut key
      const shortcutInput = document.querySelector(`input[data-shortcut="${e.key.toLowerCase()}"]`);
      if (shortcutInput) {
        e.preventDefault();
        shortcutInput.focus();
        shortcutInput.select();
        return;
      }
    });

    // Load saved keyboard mode preference
    (function() {
      const savedKeyboardMode = localStorage.getItem('keyboardMode');
      if (savedKeyboardMode === 'true') {
        toggleKeyboardMode();
      }
    })();

    // Navigation
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Update tabs
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Update views
        const viewId = 'view-' + tab.dataset.view;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
      });
    });

    // Current step state - 6-Phase Execution Methodology
    let currentStep = 1;
    const totalSteps = 6;

    // Workflow steps - click to navigate
    document.querySelectorAll('.workflow-step').forEach(step => {
      step.addEventListener('click', () => {
        const stepNum = parseInt(step.dataset.step);
        goToStep(stepNum);
      });
    });

    // Go to specific step
    function goToStep(stepNum) {
      if (stepNum < 1 || stepNum > totalSteps) return;

      // Update current step
      currentStep = stepNum;

      // Update workflow step indicators
      document.querySelectorAll('.workflow-step').forEach(s => {
        const sNum = parseInt(s.dataset.step);
        s.classList.remove('active');
        if (sNum < stepNum) {
          s.classList.add('completed');
          s.querySelector('.step-icon').innerHTML = '<span class="material-icons-outlined">check</span>';
        } else if (sNum === stepNum) {
          s.classList.add('active');
          s.classList.remove('completed');
          // Restore original icon for active step
          const icons = {1:'science', 2:'biotech', 3:'precision_manufacturing', 4:'architecture', 5:'calculate', 6:'auto_awesome'};
          s.querySelector('.step-icon').innerHTML = `<span class="material-icons-outlined">${icons[sNum]}</span>`;
        } else {
          s.classList.remove('completed');
          // Restore original icon for future steps
          const icons = {1:'science', 2:'biotech', 3:'precision_manufacturing', 4:'architecture', 5:'calculate', 6:'auto_awesome'};
          s.querySelector('.step-icon').innerHTML = `<span class="material-icons-outlined">${icons[sNum]}</span>`;
        }
      });

      // Update step content visibility
      document.querySelectorAll('.step-content').forEach(content => {
        content.classList.remove('active');
      });

      const stepIds = ['step-assessment', 'step-lab', 'step-pilot', 'step-design', 'step-commercial', 'step-generate'];
      const targetContent = document.getElementById(stepIds[stepNum - 1]);
      if (targetContent) {
        targetContent.classList.add('active');
      }

      // Update progress bar
      updateProgress(stepNum);

      // Scroll to top of content
      document.querySelector('.main-content').scrollTop = 0;
    }

    // Update progress indicators
    function updateProgress(stepNum) {
      const percent = (stepNum / totalSteps) * 100;
      const progressFill = document.getElementById('progressFill');
      const progressPercent = document.getElementById('progressPercent');
      const currentStepNum = document.getElementById('currentStepNum');

      if (progressFill) progressFill.style.width = percent + '%';
      if (progressPercent) progressPercent.textContent = Math.round(percent) + '%';
      if (currentStepNum) currentStepNum.textContent = stepNum;
    }

    // Previous step
    function prevStep() {
      if (currentStep > 1) {
        goToStep(currentStep - 1);
      }
    }

    // Save draft notification
    function saveDraft() {
      showNotification('save', 'Draft saved successfully!', 'success');
    }

    // Show notification
    function showNotification(icon, message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 16px 24px;
        background: ${type === 'success' ? 'var(--success)' : 'linear-gradient(135deg, var(--accent), var(--accent2))'};
        border-radius: 12px;
        color: #fff;
        font-size: 14px;
        font-weight: 500;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
      `;
      notification.innerHTML = `
        <span class="material-icons-outlined">${icon}</span>
        ${message}
      `;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 2500);
    }

    // Technology cards
    document.querySelectorAll('.tech-card').forEach(card => {
      card.addEventListener('click', () => {
        card.classList.toggle('selected');
        updateSolutionValidation();
      });
    });

    // Chips
    document.querySelectorAll('.chip').forEach(chip => {
      if (!chip.closest('.sidebar-section')) { // Don't toggle sidebar chips
        chip.addEventListener('click', () => {
          chip.classList.toggle('active');
        });
      }
    });

    // Range sliders
    document.querySelectorAll('input[type="range"]').forEach(slider => {
      slider.addEventListener('input', (e) => {
        const value = e.target.value;
        const label = e.target.parentElement.querySelector('.range-value');
        if (label) label.textContent = value + '%';
      });
    });

    function updateSolutionValidation() {
      const selected = document.querySelectorAll('.tech-card.selected').length;
      // Update validation message based on selection
    }

    // Initialize OpEx chart
    function initOpexChart() {
      const container = document.getElementById('opex-chart');
      if (!container) return;

      const years = [185, 191, 197, 203, 209, 215, 222, 229, 236, 243];
      const maxVal = Math.max(...years);

      container.innerHTML = '';
      years.forEach((val, i) => {
        const bar = document.createElement('div');
        bar.style.cssText = `
          flex: 1;
          background: linear-gradient(180deg, var(--accent), var(--accent2));
          border-radius: 4px 4px 0 0;
          height: ${(val / maxVal) * 100}%;
          position: relative;
          transition: all 0.3s ease;
        `;
        bar.title = `Year ${i + 1}: ${val}K`;

        // Add year label
        const label = document.createElement('div');
        label.style.cssText = `
          position: absolute;
          bottom: -20px;
          left: 50%;
          transform: translateX(-50%);
          font-size: 10px;
          color: var(--muted);
        `;
        label.textContent = `Y${i + 1}`;
        bar.appendChild(label);

        container.appendChild(bar);
      });
    }

    // Export proposal
    function exportProposal(format) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 16px 24px;
        background: linear-gradient(135deg, var(--accent), var(--accent2));
        border-radius: 12px;
        color: #fff;
        font-size: 14px;
        font-weight: 500;
        z-index: 9999;
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
      `;

      const icons = {
        pdf: 'picture_as_pdf',
        word: 'description',
        json: 'data_object',
        email: 'email'
      };

      const labels = {
        pdf: 'Generating PDF...',
        word: 'Creating Word document...',
        json: 'Exporting JSON data...',
        email: 'Opening email client...'
      };

      notification.innerHTML = `
        <span class="material-icons-outlined">${icons[format]}</span>
        ${labels[format]}
      `;

      document.body.appendChild(notification);

      setTimeout(() => {
        notification.innerHTML = `
          <span class="material-icons-outlined">check_circle</span>
          Export complete!
        `;
        notification.style.background = 'var(--success)';

        setTimeout(() => {
          notification.remove();
        }, 2000);
      }, 1500);
    }

    // Finalize proposal
    function finalizeProposal() {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      `;

      modal.innerHTML = `
        <div style="
          background: var(--card);
          border: 1px solid var(--line);
          border-radius: 20px;
          padding: 32px;
          max-width: 480px;
          text-align: center;
          animation: slideIn 0.3s ease;
        ">
          <div style="
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, var(--success), #16a34a);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
          ">
            <span class="material-icons-outlined" style="font-size:32px;color:#fff">check</span>
          </div>
          <h2 style="font-size:20px;margin-bottom:12px">Proposal Finalized!</h2>
          <p style="font-size:14px;color:var(--muted);margin-bottom:24px">
            Your proposal has been saved and logged to the decision ledger.
            Reference: PROP-2026-00142
          </p>
          <div style="display:flex;gap:12px;justify-content:center">
            <button class="btn btn-secondary" onclick="this.closest('div').parentElement.remove()">
              Close
            </button>
            <button class="btn btn-primary" onclick="window.print()">
              <span class="material-icons-outlined">print</span>
              Print
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    }

    // ==================== AI FEATURES ====================
    let aiOpen = false;
    let decisions = [];
    let wizardStep = 0;
    let wizardAnswers = {};

    const WIZARD_QUESTIONS = [
      {
        q: "What's the primary application?",
        options: [
          { value: 'industrial', label: 'Industrial Process', sub: 'Manufacturing, cooling, boiler feed' },
          { value: 'pharma', label: 'Pharmaceutical/Lab', sub: 'Ultra-pure water required' },
          { value: 'food', label: 'Food & Beverage', sub: 'Potable water quality' },
          { value: 'utilities', label: 'Water Utilities', sub: 'Municipal treatment & CSO' }
        ]
      },
      {
        q: "What target market sector?",
        options: [
          { value: 'water_utilities', label: 'Water Utilities', sub: 'Municipal and CSO applications' },
          { value: 'manufacturing', label: 'Industrial Manufacturing', sub: 'Process water and wastewater' },
          { value: 'automotive', label: 'Automotive', sub: 'Pure water for manufacturing' },
          { value: 'fnb', label: 'Food & Beverage', sub: 'Sterile water production' }
        ]
      },
      {
        q: "Technology preference?",
        options: [
          { value: 'ro', label: 'Reverse Osmosis', sub: 'High-purity water separation' },
          { value: 'uf', label: 'Ultra Filtration', sub: 'Membrane-based particle removal' },
          { value: 'uv', label: 'UV Disinfection', sub: 'Chemical-free sterilization' },
          { value: 'combo', label: 'Integrated Solution', sub: 'Multi-technology approach' }
        ]
      },
      {
        q: "Include technology partners?",
        options: [
          { value: 'nx', label: 'NX Filtration', sub: 'PFAS & micropollutant removal' },
          { value: 'atlantium', label: 'Atlantium UV', sub: 'Hydro-Optic disinfection' },
          { value: 'bnovate', label: 'bNovate Monitoring', sub: 'Real-time microbial detection' },
          { value: 'multiple', label: 'Multiple Partners', sub: 'Integrated best-in-class' }
        ]
      },
      {
        q: "Installation type preference?",
        options: [
          { value: 'skid', label: 'Skid-Mounted', sub: 'Compact, relocatable' },
          { value: 'container10', label: 'Containerised 10ft', sub: 'Small mobile deployment' },
          { value: 'container20', label: 'Containerised 20ft', sub: 'Standard plug & play' },
          { value: 'bespoke', label: 'Bespoke Build', sub: 'Custom site-specific' }
        ]
      }
    ];

    function toggleAI() {
      aiOpen = !aiOpen;
      document.getElementById('aiSidebar').classList.toggle('open', aiOpen);
      document.getElementById('aiToggleBtn').classList.toggle('active', aiOpen);
      if (aiOpen) {
        updateAISuggestions();
        updateScenarios();
        renderWizard();
      }
    }

    function setAITab(tab) {
      document.querySelectorAll('.ai-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
      document.querySelectorAll('.ai-tab-panel').forEach(p => p.classList.toggle('active', p.id === 'ai-panel-' + tab));
      if (tab === 'scenarios') updateScenarios();
      if (tab === 'wizard') renderWizard();
      if (tab === 'suggest') updateAISuggestions();
    }

    // ==================== QUICK ACTIONS ====================
    function executeQuickAction() {
      const input = document.getElementById('quickActionInput');
      const cmd = input.value.trim().toLowerCase();
      if (!cmd) return;

      if (cmd.includes('uv') || cmd.includes('disinfection')) {
        logDecision('Added UV disinfection to solution', 'User requested UV technology', 'user');
      } else if (cmd.includes('pharma') || cmd.includes('pharmaceutical')) {
        logDecision('Set application to Pharmaceutical', 'User specified pharma application', 'user');
      } else if (cmd.includes('nx') || cmd.includes('pfas')) {
        logDecision('Added NX Filtration partner', 'User requested PFAS removal capability', 'user');
      } else if (cmd.includes('container')) {
        logDecision('Selected containerised deployment', 'User requested plug & play solution', 'user');
      } else if (cmd.includes('premium') || cmd.includes('best')) {
        logDecision('Applied premium configuration', 'User requested best-in-class solution', 'user');
      }

      input.value = '';
      updateAISuggestions();
    }

    function quickAction(action) {
      switch(action) {
        case 'optimize':
          logDecision('Applied cost optimization', 'Reduced non-essential options, focused on core functionality', 'user');
          break;
        case 'premium':
          logDecision('Applied premium configuration', 'Added all technology partners, full monitoring suite', 'user');
          break;
        case 'esg':
          logDecision('Maximized ESG impact', 'Prioritized carbon reduction, water recovery, energy efficiency', 'user');
          break;
        case 'compare':
          setAITab('scenarios');
          break;
      }
      updateAISuggestions();
    }

    // ==================== SMART SUGGESTIONS ====================
    function updateAISuggestions() {
      const currentStep = getCurrentStep();
      const suggestions = [];

      // Calculate confidence based on current step and completeness
      let confidence = 70 + (currentStep * 5);
      const confLevel = confidence >= 85 ? 'high' : confidence >= 70 ? 'medium' : 'low';

      document.getElementById('aiConfidenceBadge').textContent = confidence + '%';
      document.getElementById('aiConfidenceBadge').className = 'confidence-badge ' + confLevel;
      document.getElementById('aiConfidenceBar').style.width = confidence + '%';
      document.getElementById('aiConfidenceBar').className = 'confidence-fill ' + confLevel;

      // Generate contextual suggestions based on current step
      if (currentStep === 1) {
        suggestions.push({
          icon: 'opportunity', type: 'opportunity',
          title: 'Complete water quality analysis',
          body: 'Detailed feed water data improves solution accuracy by 25%. Consider lab testing phase.',
          impact: '+25% accuracy',
          action: 'Start lab testing'
        });
      }

      if (currentStep === 2) {
        suggestions.push({
          icon: 'save', type: 'optimize',
          title: 'Consider NX Filtration',
          body: 'For PFAS and micropollutant removal, NX Filtration offers lower pressure than RO with high recovery.',
          impact: '+8,500',
          action: 'Add NX Filtration'
        });
      }

      if (currentStep <= 3) {
        suggestions.push({
          icon: 'opportunity', type: 'opportunity',
          title: 'Add Atlantium UV',
          body: 'Hydro-Optic UV provides dose-assured, chemical-free disinfection with Log4+ bacterial elimination.',
          impact: '+6,500',
          action: 'Add Atlantium UV'
        });
      }

      if (currentStep >= 3) {
        suggestions.push({
          icon: 'save', type: 'optimize',
          title: 'Include bNovate monitoring',
          body: 'Real-time microbial detection (<30 min) enables data-led decisions and avoids unnecessary shutdowns.',
          impact: '+4,500',
          action: 'Add bNovate'
        });
      }

      suggestions.push({
        icon: 'opportunity', type: 'opportunity',
        title: 'Pilot validation available',
        body: 'Deploy pilot system onsite to prove performance and build customer confidence before full-scale.',
        impact: 'Reduced risk',
        action: 'Propose pilot phase'
      });

      // Render suggestions
      const container = document.getElementById('aiSuggestions');
      if (suggestions.length === 0) {
        container.innerHTML = `
          <div class="suggestion-card highlight">
            <div class="suggestion-header">
              <div class="suggestion-icon optimize"><span class="material-icons-outlined">check_circle</span></div>
              <span class="suggestion-title">Configuration looks good!</span>
            </div>
            <div class="suggestion-body">All recommended options are in place. Ready to generate proposal.</div>
          </div>
        `;
      } else {
        container.innerHTML = suggestions.map((s, i) => `
          <div class="suggestion-card ${i === 0 ? 'highlight' : ''}">
            <div class="suggestion-header">
              <div class="suggestion-icon ${s.type}"><span class="material-icons-outlined">${s.icon === 'warning' ? 'warning' : s.icon === 'opportunity' ? 'lightbulb' : 'savings'}</span></div>
              <span class="suggestion-title">${s.title}</span>
              <span class="suggestion-impact">${s.impact}</span>
            </div>
            <div class="suggestion-body">${s.body}</div>
            <div class="suggestion-action">
              <span class="material-icons-outlined">add_circle</span>
              ${s.action}
            </div>
          </div>
        `).join('');
      }
    }

    function getCurrentStep() {
      const activeStep = document.querySelector('.workflow-step.active');
      return activeStep ? parseInt(activeStep.dataset.step) || 1 : 1;
    }

    // ==================== SCENARIO BUILDER ====================
    function updateScenarios() {
      document.getElementById('scenarioGrid').innerHTML = `
        <div class="scenario-card">
          <div class="scenario-header">
            <span class="scenario-name">Budget Solution</span>
            <span class="scenario-price">85,000</span>
          </div>
          <div class="scenario-specs">
            <span class="scenario-spec">RO System</span>
            <span class="scenario-spec">Skid-mounted</span>
            <span class="scenario-spec">Essential only</span>
          </div>
          <div class="scenario-desc">Core RO system with standard pre-treatment. Meets basic requirements at lowest cost.</div>
          <button class="scenario-apply" onclick="applyScenario('budget')">Apply This Scenario</button>
        </div>

        <div class="scenario-card recommended">
          <div class="scenario-header">
            <span class="scenario-name">Recommended Solution</span>
            <span class="scenario-price">142,000</span>
          </div>
          <div class="scenario-specs">
            <span class="scenario-spec">RO + UV</span>
            <span class="scenario-spec">Atlantium UV</span>
            <span class="scenario-spec">bNovate</span>
          </div>
          <div class="scenario-desc">Optimal balance of performance and cost. Includes partner technologies for reliability.</div>
          <button class="scenario-apply" onclick="applyScenario('recommended')">Apply This Scenario</button>
        </div>

        <div class="scenario-card">
          <div class="scenario-header">
            <span class="scenario-name">Premium Solution</span>
            <span class="scenario-price">285,000</span>
          </div>
          <div class="scenario-specs">
            <span class="scenario-spec">Full Integration</span>
            <span class="scenario-spec">All Partners</span>
            <span class="scenario-spec">Containerised</span>
          </div>
          <div class="scenario-desc">Complete solution with NX Filtration, Atlantium UV, bNovate, containerised plug & play deployment.</div>
          <button class="scenario-apply" onclick="applyScenario('premium')">Apply This Scenario</button>
        </div>
      `;
    }

    function applyScenario(type) {
      const scenarios = {
        budget: 'Budget scenario applied - Core RO system with essential pre-treatment',
        recommended: 'Recommended scenario applied - RO + Atlantium UV + bNovate monitoring',
        premium: 'Premium scenario applied - Full integration with all technology partners'
      };
      logDecision(`Applied ${type} scenario`, scenarios[type], 'user');
      setAITab('suggest');
      updateAISuggestions();
    }

    // ==================== GUIDED WIZARD ====================
    function renderWizard() {
      const progress = document.getElementById('wizardProgress');
      progress.innerHTML = WIZARD_QUESTIONS.map((_, i) =>
        `<div class="wizard-step ${i < wizardStep ? 'complete' : i === wizardStep ? 'current' : ''}"></div>`
      ).join('');

      const content = document.getElementById('wizardContent');

      if (wizardStep >= WIZARD_QUESTIONS.length) {
        content.innerHTML = `
          <div class="wizard-complete">
            <div class="wizard-complete-icon">
              <span class="material-icons-outlined">check</span>
            </div>
            <h4>Configuration Ready!</h4>
            <p>Based on your answers, we've configured the optimal solution.</p>
            <button class="scenario-apply" style="margin-top: 16px" onclick="applyWizardConfig()">Apply Configuration</button>
            <button class="wizard-back" style="margin-top: 8px; width: 100%" onclick="wizardStep=0; renderWizard();">Start Over</button>
          </div>
        `;
        return;
      }

      const q = WIZARD_QUESTIONS[wizardStep];
      content.innerHTML = `
        <div class="wizard-question">
          <div class="wizard-q-header">
            <div class="wizard-q-num">${wizardStep + 1}</div>
            <div class="wizard-q-text">${q.q}</div>
          </div>
          <div class="wizard-options">
            ${q.options.map(o => `
              <div class="wizard-option ${wizardAnswers[wizardStep] === o.value ? 'selected' : ''}" onclick="selectWizardOption('${o.value}')">
                <div class="wizard-option-main">${o.label}</div>
                <div class="wizard-option-sub">${o.sub}</div>
              </div>
            `).join('')}
          </div>
        </div>
        <div class="wizard-nav">
          ${wizardStep > 0 ? '<button class="wizard-back" onclick="wizardStep--; renderWizard();">Back</button>' : ''}
          <button class="wizard-next" onclick="nextWizardStep()" ${!wizardAnswers[wizardStep] ? 'disabled style="opacity:0.5"' : ''}>
            ${wizardStep === WIZARD_QUESTIONS.length - 1 ? 'Complete' : 'Next'}
          </button>
        </div>
      `;
    }

    function selectWizardOption(value) {
      wizardAnswers[wizardStep] = value;
      renderWizard();
    }

    function nextWizardStep() {
      if (wizardAnswers[wizardStep]) {
        wizardStep++;
        renderWizard();
      }
    }

    function applyWizardConfig() {
      const app = wizardAnswers[0];
      const market = wizardAnswers[1];
      const tech = wizardAnswers[2];
      const partner = wizardAnswers[3];
      const install = wizardAnswers[4];

      logDecision(
        'Applied wizard configuration',
        `${app} application, ${market} market, ${tech} technology, ${partner} partners, ${install} installation`,
        'user'
      );

      setAITab('suggest');
      updateAISuggestions();
    }

    // ==================== DECISION TRAIL ====================
    function logDecision(action, reason, type = 'auto') {
      const now = new Date();
      const time = now.toTimeString().slice(0, 8);
      decisions.unshift({ time, action, reason, type });
      renderDecisions();
    }

    function renderDecisions() {
      const trail = document.getElementById('decisionTrail');
      document.getElementById('decisionCount').textContent = decisions.length + ' decisions';
      trail.innerHTML = decisions.map(d => `
        <div class="decision-item ${d.type === 'rule' ? 'warning' : d.type === 'user' ? 'success' : ''}">
          <div class="decision-header">
            <span class="decision-time">${d.time}</span>
            <span class="decision-type ${d.type}">${d.type}</span>
          </div>
          <div class="decision-action">${d.action}</div>
          <div class="ai-decision-reason">${d.reason}</div>
        </div>
      `).join('');
    }

    // Step icons mapping (6-phase methodology)
    const stepIcons = {
      1: 'science',
      2: 'biotech',
      3: 'precision_manufacturing',
      4: 'architecture',
      5: 'calculate',
      6: 'auto_awesome'
    };

    // Restore step icon
    function restoreStepIcon(stepNum) {
      const step = document.querySelector(`.workflow-step[data-step="${stepNum}"]`);
      if (step) {
        step.querySelector('.step-icon').innerHTML =
          `<span class="material-icons-outlined">${stepIcons[stepNum]}</span>`;
      }
    }

    // ==================== REACTIVE AI SYSTEM ====================
    // Reactive State Management - Proxy-based observable store
    const ReactiveStore = {
      _state: {},
      _watchers: new Map(),
      _debounceTimers: {},

      // Initialize state with defaults from PRD
      init(initialState) {
        this._state = initialState;
        return new Proxy(this._state, {
          set: (target, property, value) => {
            const oldValue = target[property];
            target[property] = value;
            if (oldValue !== value) {
              this._notify(property, value, oldValue);
            }
            return true;
          },
          get: (target, property) => target[property]
        });
      },

      // Watch for changes to specific properties
      watch(property, callback, debounceMs = 100) {
        if (!this._watchers.has(property)) {
          this._watchers.set(property, []);
        }
        this._watchers.get(property).push({ callback, debounceMs });
      },

      // Notify watchers of changes with debouncing
      _notify(property, newValue, oldValue) {
        const watchers = this._watchers.get(property) || [];
        const globalWatchers = this._watchers.get('*') || [];

        [...watchers, ...globalWatchers].forEach(({ callback, debounceMs }) => {
          const timerId = `${property}_${callback.name || 'anon'}`;
          clearTimeout(this._debounceTimers[timerId]);
          this._debounceTimers[timerId] = setTimeout(() => {
            callback(newValue, oldValue, property);
          }, debounceMs);
        });
      },

      // Get current state
      getState() {
        return { ...this._state };
      }
    };

    // ==================== WATER QUALITY THRESHOLDS (from PRD) ====================
    const THRESHOLDS = {
      // Critical Alarms (Red) - Block proposal
      critical: {
        sdi: { max: 6, message: 'SDI HIGH - Pre-treatment required; RO at risk of rapid fouling' },
        ph: { min: 5, max: 9, message: 'pH out of range - Risk of irreversible membrane damage' },
        chlorine: { max: 0.05, message: 'Chlorine HIGH - Carbon filter + SMBS mandatory' },
        iron: { max: 0.3, message: 'Iron Levels HIGH - Dedicated iron removal system required' }
      },
      // Warnings (Yellow) - Display but allow continuation
      warnings: {
        temperature: { min: 15, message: 'Temperature is low - flux reduction expected' },
        hardness: { max: 300, message: 'Hard water detected - Softener or antiscalant required' },
        tds: { max: 1000, message: 'TDS HIGH - High-rejection membranes recommended' },
        tss: { max: 5, message: 'TSS HIGH - Full pre-treatment required' },
        turbidity: { max: 5, message: 'Turbidity HIGH - Sand/multimedia filter needed' },
        pressure: { min: 3, message: 'Pressure LOW - Boost pump required' },
        conductivityTarget: { max: 10, message: 'Ultra-pure target - Second stage RO required' }
      },
      // Pre-treatment triggers
      pretreatment: {
        chlorine: { threshold: 0.05, component: 'Carbon Filter', cost: 1062 },
        iron_low: { threshold: 0.1, component: 'Iron Removal', cost: 3500 },
        iron_high: { threshold: 0.3, component: 'Dedicated Iron System', cost: 5500 },
        hardness_moderate: { threshold: 100, component: 'Antiscalant Dosing', cost: 1400 },
        hardness_high: { threshold: 300, component: 'Water Softener', cost: 4500 },
        turbidity: { threshold: 5, component: 'Sand Filter', cost: 2500 },
        tss: { threshold: 5, component: 'Multimedia Filter', cost: 3000 },
        sdi: { threshold: 6, component: 'Pre-treatment Package', cost: 8500 },
        pressure: { threshold: 3, component: 'Boost Pump', cost: 2500, condition: 'below' },
        ph_low: { threshold: 6, component: 'pH Adjustment Dosing', cost: 1400, condition: 'below' },
        ph_high: { threshold: 8.5, component: 'pH Adjustment Dosing', cost: 1400, condition: 'above' }
      }
    };

    // ==================== RO SYSTEM SIZING DATA (from PRD) ====================
    const MEMR_SYSTEMS = [
      { model: 'MEMR0025', flow: 0.25, baseCost: 1700, membranes: 1, power: 0, cip: 3500 },
      { model: 'MEMR005', flow: 0.5, baseCost: 2200, membranes: 2, power: 0, cip: 3500 },
      { model: 'MEMR01', flow: 1, baseCost: 3500, membranes: 4, power: 0, cip: 3500 },
      { model: 'MEMR02', flow: 2, baseCost: 4500, membranes: 2, power: 3, cip: 3500 },
      { model: 'MEMR04', flow: 4, baseCost: 5500, membranes: 4, power: 4, cip: 3500 },
      { model: 'MEMR06', flow: 6, baseCost: 12100, membranes: 6, power: 7.5, cip: 3500 },
      { model: 'MEMR09', flow: 9, baseCost: 15954, membranes: 9, power: 7.5, cip: 4716 },
      { model: 'MEMR012', flow: 12, baseCost: 23250, membranes: 12, power: 11, cip: 4716 },
      { model: 'MEMR016', flow: 16, baseCost: 27500, membranes: 16, power: 11, cip: 4716 }
    ];

    const TEMP_CORRECTION = {
      5: 0.45, 10: 0.58, 15: 0.75, 20: 0.88, 25: 1.00, 30: 1.15, 35: 1.30
    };

    // ==================== INITIALIZE REACTIVE STATE ====================
    const state = ReactiveStore.init({
      // Customer & Project
      customerName: '',
      projectName: '',
      industrySector: 'General Industrial',
      location: '',

      // Water Quality Parameters
      permeateFlow: 9,
      permeateQuality: 12,
      feedConductivity: 500,
      feedPressure: 4,
      feedTDS: 500,
      feedTSS: 5,
      chlorine: 0,
      turbidity: 1,
      sdi: 3,
      ph: 7,
      iron: 0.02,
      hardness: 150,
      temperature: 20,

      // System Configuration
      containerRequired: false,
      containerSize: '20ft',
      uvRequired: false,
      cipRequired: true,
      remoteMonitoring: false,
      recoveryTarget: 75,
      componentMarkup: 30,

      // Calculated Results
      selectedModel: null,
      feedFlow: 0,
      rejectFlow: 0,
      membraneCount: 0,
      estimatedConductivity: 0,

      // AI Analysis Results
      alarms: [],
      warnings: [],
      recommendations: [],
      autoComponents: [],

      // Pricing
      baseCost: 0,
      pretreatmentCost: 0,
      optionsCost: 0,
      totalCost: 0,
      sellingPrice: 0,
      grossMargin: 0,

      // Confidence
      aiConfidence: 70,
      dataCompleteness: 0
    });

    // ==================== REACTIVE CALCULATION ENGINE ====================
    const CalculationEngine = {
      // Calculate RO system sizing
      calculateSizing() {
        const { permeateFlow, recoveryTarget, feedConductivity, temperature } = state;

        // Temperature correction factor
        const tempKey = Object.keys(TEMP_CORRECTION).reduce((a, b) =>
          Math.abs(b - temperature) < Math.abs(a - temperature) ? b : a
        );
        const tempFactor = TEMP_CORRECTION[tempKey];

        // Adjusted flow for temperature
        const adjustedFlow = permeateFlow / tempFactor;

        // Select appropriate system
        const system = MEMR_SYSTEMS.find(s => s.flow >= adjustedFlow) || MEMR_SYSTEMS[MEMR_SYSTEMS.length - 1];

        // Calculate flows
        const feedFlow = permeateFlow / (recoveryTarget / 100);
        const rejectFlow = feedFlow - permeateFlow;

        // Estimate permeate conductivity (98% rejection rate)
        const estimatedConductivity = feedConductivity * 0.02;

        // Update state
        state.selectedModel = system;
        state.feedFlow = feedFlow.toFixed(2);
        state.rejectFlow = rejectFlow.toFixed(2);
        state.membraneCount = system.membranes;
        state.estimatedConductivity = estimatedConductivity.toFixed(1);

        return system;
      },

      // Analyze water quality and generate alarms/warnings
      analyzeWaterQuality() {
        const alarms = [];
        const warnings = [];
        const recommendations = [];
        const autoComponents = [];

        // Check critical alarms
        if (state.sdi > THRESHOLDS.critical.sdi.max) {
          alarms.push({ type: 'critical', param: 'SDI', value: state.sdi, message: THRESHOLDS.critical.sdi.message });
        }
        if (state.ph < THRESHOLDS.critical.ph.min || state.ph > THRESHOLDS.critical.ph.max) {
          alarms.push({ type: 'critical', param: 'pH', value: state.ph, message: THRESHOLDS.critical.ph.message });
        }
        if (state.chlorine > THRESHOLDS.critical.chlorine.max) {
          alarms.push({ type: 'critical', param: 'Chlorine', value: state.chlorine, message: THRESHOLDS.critical.chlorine.message });
        }
        if (state.iron > THRESHOLDS.critical.iron.max) {
          alarms.push({ type: 'critical', param: 'Iron', value: state.iron, message: THRESHOLDS.critical.iron.message });
        }

        // Check warnings
        if (state.temperature < THRESHOLDS.warnings.temperature.min) {
          warnings.push({ type: 'warning', param: 'Temperature', value: state.temperature, message: THRESHOLDS.warnings.temperature.message });
        }
        if (state.hardness > THRESHOLDS.warnings.hardness.max) {
          warnings.push({ type: 'warning', param: 'Hardness', value: state.hardness, message: THRESHOLDS.warnings.hardness.message });
        }
        if (state.feedTDS > THRESHOLDS.warnings.tds.max) {
          warnings.push({ type: 'warning', param: 'TDS', value: state.feedTDS, message: THRESHOLDS.warnings.tds.message });
        }
        if (state.feedTSS > THRESHOLDS.warnings.tss.max) {
          warnings.push({ type: 'warning', param: 'TSS', value: state.feedTSS, message: THRESHOLDS.warnings.tss.message });
        }
        if (state.turbidity > THRESHOLDS.warnings.turbidity.max) {
          warnings.push({ type: 'warning', param: 'Turbidity', value: state.turbidity, message: THRESHOLDS.warnings.turbidity.message });
        }
        if (state.feedPressure < THRESHOLDS.warnings.pressure.min) {
          warnings.push({ type: 'warning', param: 'Pressure', value: state.feedPressure, message: THRESHOLDS.warnings.pressure.message });
        }
        if (state.permeateQuality < THRESHOLDS.warnings.conductivityTarget.max) {
          warnings.push({ type: 'warning', param: 'Target Quality', value: state.permeateQuality, message: THRESHOLDS.warnings.conductivityTarget.message });
        }

        // Auto-select pre-treatment components
        if (state.chlorine > THRESHOLDS.pretreatment.chlorine.threshold) {
          autoComponents.push({ name: 'Carbon Filter', cost: THRESHOLDS.pretreatment.chlorine.cost, reason: `Chlorine > ${THRESHOLDS.pretreatment.chlorine.threshold} ppm` });
        }
        if (state.iron > THRESHOLDS.pretreatment.iron_high.threshold) {
          autoComponents.push({ name: 'Dedicated Iron System', cost: THRESHOLDS.pretreatment.iron_high.cost, reason: `Iron > ${THRESHOLDS.pretreatment.iron_high.threshold} mg/L` });
        } else if (state.iron > THRESHOLDS.pretreatment.iron_low.threshold) {
          autoComponents.push({ name: 'Iron Removal', cost: THRESHOLDS.pretreatment.iron_low.cost, reason: `Iron > ${THRESHOLDS.pretreatment.iron_low.threshold} mg/L` });
        }
        if (state.hardness > THRESHOLDS.pretreatment.hardness_high.threshold) {
          autoComponents.push({ name: 'Water Softener', cost: THRESHOLDS.pretreatment.hardness_high.cost, reason: `Hardness > ${THRESHOLDS.pretreatment.hardness_high.threshold} mg/L` });
        } else if (state.hardness > THRESHOLDS.pretreatment.hardness_moderate.threshold) {
          autoComponents.push({ name: 'Antiscalant Dosing', cost: THRESHOLDS.pretreatment.hardness_moderate.cost, reason: `Hardness > ${THRESHOLDS.pretreatment.hardness_moderate.threshold} mg/L` });
        }
        if (state.turbidity > THRESHOLDS.pretreatment.turbidity.threshold) {
          autoComponents.push({ name: 'Sand Filter', cost: THRESHOLDS.pretreatment.turbidity.cost, reason: `Turbidity > ${THRESHOLDS.pretreatment.turbidity.threshold} NTU` });
        }
        if (state.feedTSS > THRESHOLDS.pretreatment.tss.threshold) {
          autoComponents.push({ name: 'Multimedia Filter', cost: THRESHOLDS.pretreatment.tss.cost, reason: `TSS > ${THRESHOLDS.pretreatment.tss.threshold} ppm` });
        }
        if (state.sdi > THRESHOLDS.pretreatment.sdi.threshold) {
          autoComponents.push({ name: 'Pre-treatment Package', cost: THRESHOLDS.pretreatment.sdi.cost, reason: `SDI > ${THRESHOLDS.pretreatment.sdi.threshold}` });
        }
        if (state.feedPressure < THRESHOLDS.pretreatment.pressure.threshold) {
          autoComponents.push({ name: 'Boost Pump', cost: THRESHOLDS.pretreatment.pressure.cost, reason: `Pressure < ${THRESHOLDS.pretreatment.pressure.threshold} BAR` });
        }
        if (state.ph < THRESHOLDS.pretreatment.ph_low.threshold || state.ph > THRESHOLDS.pretreatment.ph_high.threshold) {
          autoComponents.push({ name: 'pH Adjustment Dosing', cost: THRESHOLDS.pretreatment.ph_low.cost, reason: `pH outside 6-8.5 range` });
        }
        if (state.permeateQuality < 10) {
          autoComponents.push({ name: 'Second Stage RO', cost: 15000, reason: `Target conductivity < 10 S/cm` });
        }

        // Update state
        state.alarms = alarms;
        state.warnings = warnings;
        state.recommendations = recommendations;
        state.autoComponents = autoComponents;

        return { alarms, warnings, autoComponents };
      },

      // Calculate pricing
      calculatePricing() {
        const system = state.selectedModel;
        if (!system) return;

        const markup = state.componentMarkup / 100;

        // Base system cost
        let baseCost = system.baseCost;

        // Add CIP if flow > 4 or explicitly required
        if (state.cipRequired || state.permeateFlow >= 4) {
          baseCost += system.cip;
        }

        // Pre-treatment costs
        const pretreatmentCost = state.autoComponents.reduce((sum, c) => sum + c.cost, 0);

        // Options costs
        let optionsCost = 0;
        if (state.containerRequired) {
          const containerPrices = { '10ft': 3000, '20ft': 5500, '40ft': 10500 };
          optionsCost += containerPrices[state.containerSize] || 5500;
        }
        if (state.uvRequired) {
          optionsCost += 2500;
        }
        if (state.remoteMonitoring) {
          optionsCost += 3500;
        }

        // Calculate totals
        const totalCost = baseCost + pretreatmentCost + optionsCost;

        // Workshop overhead (5%) + Contingency (5%) + Social Impact (2%)
        const overheads = totalCost * 0.12;

        // Selling price with markup
        const sellingPrice = (totalCost + overheads) * (1 + markup);

        // Gross margin
        const grossMargin = ((sellingPrice - totalCost) / sellingPrice * 100).toFixed(1);

        // Update state
        state.baseCost = baseCost;
        state.pretreatmentCost = pretreatmentCost;
        state.optionsCost = optionsCost;
        state.totalCost = totalCost;
        state.sellingPrice = Math.round(sellingPrice);
        state.grossMargin = grossMargin;
      },

      // Calculate AI confidence score
      calculateConfidence() {
        let score = 50; // Base score
        let completeness = 0;
        const requiredFields = ['customerName', 'projectName', 'permeateFlow', 'feedConductivity', 'ph', 'temperature'];
        const optionalFields = ['feedTDS', 'feedTSS', 'sdi', 'hardness', 'iron', 'chlorine', 'turbidity'];

        // Check required fields
        requiredFields.forEach(field => {
          if (state[field] && state[field] !== '' && state[field] !== 0) {
            score += 5;
            completeness += 100 / (requiredFields.length + optionalFields.length);
          }
        });

        // Check optional fields for bonus
        optionalFields.forEach(field => {
          if (state[field] !== undefined && state[field] !== null) {
            score += 3;
            completeness += 100 / (requiredFields.length + optionalFields.length);
          }
        });

        // Deduct for alarms
        score -= state.alarms.length * 10;

        // Deduct for warnings
        score -= state.warnings.length * 3;

        // Bonus for reasonable values
        if (state.recoveryTarget >= 70 && state.recoveryTarget <= 85) score += 5;
        if (state.componentMarkup >= 25 && state.componentMarkup <= 40) score += 5;

        // Clamp score
        state.aiConfidence = Math.max(20, Math.min(98, score));
        state.dataCompleteness = Math.min(100, completeness);

        return state.aiConfidence;
      },

      // Run all calculations
      runAll() {
        this.calculateSizing();
        this.analyzeWaterQuality();
        this.calculatePricing();
        this.calculateConfidence();
        this.updateUI();
      },

      // Update UI elements
      updateUI() {
        // Update confidence display
        const confidence = state.aiConfidence;
        const confLevel = confidence >= 85 ? 'high' : confidence >= 70 ? 'medium' : 'low';

        const confBadge = document.getElementById('aiConfidenceBadge');
        const confBar = document.getElementById('aiConfidenceBar');
        if (confBadge) {
          confBadge.textContent = confidence + '%';
          confBadge.className = 'confidence-badge ' + confLevel;
        }
        if (confBar) {
          confBar.style.width = confidence + '%';
          confBar.className = 'confidence-fill ' + confLevel;
        }

        // Update alarms display
        this.renderAlarms();

        // Update auto-components panel
        this.renderAutoComponents();

        // Update pricing display
        this.renderPricing();

        // Update suggestions
        updateAISuggestions();
      },

      // Render alarms and warnings
      renderAlarms() {
        const container = document.getElementById('reactiveAlarms');
        if (!container) return;

        let html = '';

        state.alarms.forEach(alarm => {
          html += `
            <div class="reactive-alarm critical" style="padding:12px;margin-bottom:8px;background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.4);border-radius:10px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                <span class="material-icons-outlined" style="color:var(--danger);font-size:18px">error</span>
                <span style="font-size:13px;font-weight:600;color:var(--danger)">${alarm.param}: ${alarm.value}</span>
              </div>
              <div style="font-size:11px;color:var(--muted)">${alarm.message}</div>
            </div>
          `;
        });

        state.warnings.forEach(warning => {
          html += `
            <div class="reactive-alarm warning" style="padding:12px;margin-bottom:8px;background:rgba(245,158,11,0.15);border:1px solid rgba(245,158,11,0.4);border-radius:10px">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
                <span class="material-icons-outlined" style="color:var(--warning);font-size:18px">warning</span>
                <span style="font-size:13px;font-weight:600;color:var(--warning)">${warning.param}: ${warning.value}</span>
              </div>
              <div style="font-size:11px;color:var(--muted)">${warning.message}</div>
            </div>
          `;
        });

        if (state.alarms.length === 0 && state.warnings.length === 0) {
          html = `
            <div style="padding:12px;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:10px">
              <div style="display:flex;align-items:center;gap:8px">
                <span class="material-icons-outlined" style="color:var(--success);font-size:18px">check_circle</span>
                <span style="font-size:12px;color:var(--success)">Water quality within acceptable ranges</span>
              </div>
            </div>
          `;
        }

        container.innerHTML = html;
      },

      // Render auto-selected components
      renderAutoComponents() {
        const container = document.getElementById('reactiveComponents');
        if (!container) return;

        if (state.autoComponents.length === 0) {
          container.innerHTML = `
            <div style="padding:12px;background:var(--card);border:1px solid var(--line);border-radius:10px">
              <div style="font-size:12px;color:var(--muted)">No additional pre-treatment required based on current water quality parameters.</div>
            </div>
          `;
          return;
        }

        let html = `<div style="display:flex;flex-direction:column;gap:8px">`;
        state.autoComponents.forEach(comp => {
          html += `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--card);border:1px solid var(--line);border-radius:8px">
              <div>
                <div style="font-size:12px;font-weight:600;color:var(--text)">${comp.name}</div>
                <div style="font-size:10px;color:var(--muted)">${comp.reason}</div>
              </div>
              <div style="font-size:13px;font-weight:600;color:var(--accent)">${comp.cost.toLocaleString()}</div>
            </div>
          `;
        });
        html += `</div>`;

        container.innerHTML = html;
      },

      // Render pricing summary
      renderPricing() {
        const container = document.getElementById('reactivePricing');
        if (!container) return;

        container.innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
            <div style="padding:12px;background:var(--card);border-radius:10px;border:1px solid var(--line)">
              <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Base System</div>
              <div style="font-size:18px;font-weight:700;color:var(--text)">${state.baseCost.toLocaleString()}</div>
              <div style="font-size:10px;color:var(--muted)">${state.selectedModel?.model || '-'}</div>
            </div>
            <div style="padding:12px;background:var(--card);border-radius:10px;border:1px solid var(--line)">
              <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Pre-treatment</div>
              <div style="font-size:18px;font-weight:700;color:var(--accent2)">${state.pretreatmentCost.toLocaleString()}</div>
              <div style="font-size:10px;color:var(--muted)">${state.autoComponents.length} components</div>
            </div>
            <div style="padding:12px;background:var(--card);border-radius:10px;border:1px solid var(--line)">
              <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Options</div>
              <div style="font-size:18px;font-weight:700;color:var(--accent3)">${state.optionsCost.toLocaleString()}</div>
              <div style="font-size:10px;color:var(--muted)">Container, UV, etc.</div>
            </div>
            <div style="padding:12px;background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(34,211,238,0.1));border-radius:10px;border:1px solid rgba(99,102,241,0.3)">
              <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px">Selling Price</div>
              <div style="font-size:18px;font-weight:700;color:var(--accent)">${state.sellingPrice.toLocaleString()}</div>
              <div style="font-size:10px;color:var(--success)">${state.grossMargin}% margin</div>
            </div>
          </div>
        `;

        // Update system info display
        const sysInfo = document.getElementById('reactiveSystemInfo');
        if (sysInfo && state.selectedModel) {
          sysInfo.innerHTML = `
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:16px">
              <div style="text-align:center;padding:12px;background:var(--card);border-radius:10px;border:1px solid var(--line)">
                <div style="font-size:20px;font-weight:700;color:var(--accent)">${state.feedFlow}</div>
                <div style="font-size:10px;color:var(--muted)">Feed Flow m/hr</div>
              </div>
              <div style="text-align:center;padding:12px;background:var(--card);border-radius:10px;border:1px solid var(--line)">
                <div style="font-size:20px;font-weight:700;color:var(--accent2)">${state.rejectFlow}</div>
                <div style="font-size:10px;color:var(--muted)">Reject Flow m/hr</div>
              </div>
              <div style="text-align:center;padding:12px;background:var(--card);border-radius:10px;border:1px solid var(--line)">
                <div style="font-size:20px;font-weight:700;color:var(--accent3)">${state.membraneCount}</div>
                <div style="font-size:10px;color:var(--muted)">Membranes</div>
              </div>
              <div style="text-align:center;padding:12px;background:var(--card);border-radius:10px;border:1px solid var(--line)">
                <div style="font-size:20px;font-weight:700;color:var(--success)">${state.estimatedConductivity}</div>
                <div style="font-size:10px;color:var(--muted)">Est. S/cm</div>
              </div>
            </div>
          `;
        }
      }
    };

    // ==================== REACTIVE INPUT BINDINGS ====================
    function bindReactiveInputs() {
      // Bind all inputs with data-reactive attribute
      document.querySelectorAll('[data-reactive]').forEach(input => {
        const stateKey = input.dataset.reactive;

        // Set initial value from state
        if (input.type === 'checkbox') {
          input.checked = state[stateKey] || false;
        } else if (input.type === 'range') {
          input.value = state[stateKey] || input.value;
        } else {
          input.value = state[stateKey] || '';
        }

        // Bind change event - use 'input' for immediate feedback on numbers and ranges
        const eventType = (input.type === 'range' || input.type === 'number') ? 'input' : 'change';
        input.addEventListener(eventType, (e) => {
          let value;
          if (input.type === 'checkbox') {
            value = e.target.checked;
          } else if (input.type === 'number' || input.type === 'range') {
            value = parseFloat(e.target.value) || 0;
          } else {
            value = e.target.value;
          }

          state[stateKey] = value;

          // Log the change as an AI decision
          logDecision(
            `${stateKey} updated to ${value}`,
            `User input change triggered recalculation`,
            'user'
          );

          // Trigger recalculation
          CalculationEngine.runAll();
        });
      });
    }

    // Toggle reactive chip (for system configuration options)
    function toggleReactiveChip(chip) {
      const stateKey = chip.dataset.reactiveToggle;
      if (!stateKey) return;

      chip.classList.toggle('active');
      const isActive = chip.classList.contains('active');
      state[stateKey] = isActive;

      logDecision(
        `${stateKey} ${isActive ? 'enabled' : 'disabled'}`,
        `User toggled system configuration option`,
        'user'
      );

      CalculationEngine.runAll();
    }

    // ==================== REACTIVE WATCHERS ====================
    // Watch for any state change and recalculate
    ReactiveStore.watch('*', (newVal, oldVal, prop) => {
      // Skip calculated fields to prevent infinite loops
      const calculatedFields = ['selectedModel', 'feedFlow', 'rejectFlow', 'membraneCount',
        'estimatedConductivity', 'alarms', 'warnings', 'recommendations', 'autoComponents',
        'baseCost', 'pretreatmentCost', 'optionsCost', 'totalCost', 'sellingPrice',
        'grossMargin', 'aiConfidence', 'dataCompleteness'];

      if (!calculatedFields.includes(prop)) {
        console.log(`[Reactive] ${prop}: ${oldVal}  ${newVal}`);
      }
    }, 50);

    // ==================== ENHANCED AI SUGGESTIONS WITH REACTIVITY ====================
    function getReactiveSuggestions() {
      const suggestions = [];
      const currentStepNum = getCurrentStep();

      // Priority suggestions based on alarms
      state.alarms.forEach(alarm => {
        suggestions.push({
          icon: 'error',
          type: 'critical',
          title: `Critical: ${alarm.param}`,
          body: alarm.message,
          impact: 'Blocks proposal',
          action: 'Resolve issue',
          priority: 100
        });
      });

      // Warning-based suggestions
      state.warnings.forEach(warning => {
        suggestions.push({
          icon: 'warning',
          type: 'warning',
          title: `Warning: ${warning.param}`,
          body: warning.message,
          impact: 'Review recommended',
          action: 'View options',
          priority: 50
        });
      });

      // Data completeness suggestions
      if (state.dataCompleteness < 50) {
        suggestions.push({
          icon: 'assignment',
          type: 'opportunity',
          title: 'Complete water quality data',
          body: `Only ${Math.round(state.dataCompleteness)}% of parameters entered. More data improves AI accuracy.`,
          impact: `+${Math.round((100 - state.dataCompleteness) / 4)}% confidence`,
          action: 'Add parameters',
          priority: 40
        });
      }

      // Industry-specific recommendations
      if (state.industrySector === 'Pharmaceutical' && !state.uvRequired) {
        suggestions.push({
          icon: 'lightbulb',
          type: 'opportunity',
          title: 'UV recommended for Pharma',
          body: 'Pharmaceutical applications typically require UV disinfection for compliance.',
          impact: '+2,500',
          action: 'Add UV system',
          priority: 30
        });
      }

      // ESG optimization suggestion
      if (state.recoveryTarget < 80) {
        suggestions.push({
          icon: 'eco',
          type: 'optimize',
          title: 'Increase water recovery',
          body: `Current ${state.recoveryTarget}% recovery. Higher recovery improves ESG score.`,
          impact: '+ESG points',
          action: 'Optimize recovery',
          priority: 20
        });
      }

      // Technology partner suggestions based on conditions
      if (state.feedTDS > 500 || state.sdi > 4) {
        suggestions.push({
          icon: 'handshake',
          type: 'opportunity',
          title: 'Consider NX Filtration',
          body: 'For challenging feed water, NX hollow fiber nanofiltration offers superior pre-treatment.',
          impact: '+8,500',
          action: 'Add NX Filtration',
          priority: 25
        });
      }

      // Sort by priority (highest first)
      return suggestions.sort((a, b) => b.priority - a.priority).slice(0, 5);
    }

    // Override the original updateAISuggestions with reactive version
    const originalUpdateAISuggestions = updateAISuggestions;
    updateAISuggestions = function() {
      const suggestions = getReactiveSuggestions();
      const container = document.getElementById('aiSuggestions');
      if (!container) return;

      if (suggestions.length === 0) {
        container.innerHTML = `
          <div class="suggestion-card highlight">
            <div class="suggestion-header">
              <div class="suggestion-icon success"><span class="material-icons-outlined">check_circle</span></div>
              <span class="suggestion-title">Configuration optimal!</span>
            </div>
            <div class="suggestion-body">All parameters within range. Ready to proceed with proposal generation.</div>
          </div>
        `;
      } else {
        container.innerHTML = suggestions.map((s, i) => `
          <div class="suggestion-card ${i === 0 ? 'highlight' : ''} ${s.type === 'critical' ? 'critical-card' : ''}">
            <div class="suggestion-header">
              <div class="suggestion-icon ${s.type}">
                <span class="material-icons-outlined">${s.icon}</span>
              </div>
              <span class="suggestion-title">${s.title}</span>
              <span class="suggestion-impact ${s.type === 'critical' ? 'critical' : ''}">${s.impact}</span>
            </div>
            <div class="suggestion-body">${s.body}</div>
            <div class="suggestion-action" onclick="handleSuggestionAction('${s.action}')">
              <span class="material-icons-outlined">add_circle</span>
              ${s.action}
            </div>
          </div>
        `).join('');
      }
    };

    // Handle suggestion actions
    function handleSuggestionAction(action) {
      switch(action.toLowerCase()) {
        case 'add uv system':
          state.uvRequired = true;
          document.querySelector('[data-reactive="uvRequired"]')?.click();
          logDecision('Added UV system', 'AI suggestion accepted', 'user');
          break;
        case 'optimize recovery':
          state.recoveryTarget = 82;
          const recoverySlider = document.querySelector('[data-reactive="recoveryTarget"]');
          if (recoverySlider) recoverySlider.value = 82;
          logDecision('Optimized recovery to 82%', 'AI suggestion accepted', 'user');
          break;
        case 'add nx filtration':
          logDecision('Added NX Filtration partner', 'AI suggestion for challenging water accepted', 'user');
          break;
        case 'add parameters':
          // Open the AI sidebar to the wizard
          if (!aiOpen) toggleAI();
          setAITab('wizard');
          break;
        default:
          logDecision(`Action: ${action}`, 'Suggestion interaction', 'user');
      }
      CalculationEngine.runAll();
    }

    // ==================== PERSONA SYSTEM ====================
    let currentPersona = localStorage.getItem('userPersona') || 'all';
    let personaInitialized = false;

    function setPersona(persona) {
      currentPersona = persona;
      document.body.setAttribute('data-persona', persona);

      // Update selector UI
      document.querySelectorAll('.persona-chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.persona === persona);
      });

      // Update AI suggestions based on persona (if available)
      if (typeof updateAISuggestions === 'function') {
        try { updateAISuggestions(); } catch(e) { console.log('AI suggestions update skipped'); }
      }

      // Log persona change (skip on initial load)
      if (personaInitialized && typeof logDecision === 'function') {
        try { logDecision(`Switched to ${persona} view`, `User changed persona filter`, 'user'); } catch(e) {}
      }

      // Save preference
      localStorage.setItem('userPersona', persona);

      // Show notification (skip on initial load)
      if (personaInitialized) {
        const personaNames = {
          all: 'All Content',
          business: 'Business Focus',
          technician: 'Technician Focus',
          sales: 'Sales Focus',
          customer: 'Customer View'
        };
        showNotification('visibility', `Viewing: ${personaNames[persona]}`, 'success');
      }

      personaInitialized = true;

      // Update toggle button state if selector is hidden
      if (typeof updatePersonaToggleState === 'function') {
        updatePersonaToggleState();
      }

      console.log('[Persona] Set to:', persona);
    }

    // Get persona-specific suggestions
    function getPersonaSuggestions(persona) {
      const suggestions = {
        business: [
          { action: 'View margin analysis', icon: 'trending_up' },
          { action: 'Generate ESG report', icon: 'eco' },
          { action: 'Compare alternatives', icon: 'compare_arrows' },
          { action: 'Decision audit trail', icon: 'history' }
        ],
        technician: [
          { action: 'Check pre-treatment', icon: 'filter_alt' },
          { action: 'Verify sizing', icon: 'straighten' },
          { action: 'Review water quality', icon: 'water_drop' },
          { action: 'View alarms', icon: 'warning' }
        ],
        sales: [
          { action: 'Generate quote', icon: 'request_quote' },
          { action: 'Apply discount', icon: 'sell' },
          { action: 'Calculate ROI', icon: 'calculate' },
          { action: 'Win probability', icon: 'emoji_events' }
        ],
        customer: [
          { action: 'View summary', icon: 'summarize' },
          { action: 'See benefits', icon: 'stars' },
          { action: 'Environmental impact', icon: 'eco' },
          { action: 'Warranty info', icon: 'verified_user' }
        ]
      };
      return suggestions[persona] || [];
    }

    // Initialize persona on load
    function initPersona() {
      const savedPersona = localStorage.getItem('userPersona') || 'all';
      setPersona(savedPersona);
    }

    // ==================== SOLUTION VIEW TOGGLE ====================
    function setSolutionView(view) {
      // Update buttons
      document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });

      // Update views
      document.getElementById('solutionGridView').classList.toggle('active', view === 'grid');
      document.getElementById('solutionTreeView').classList.toggle('active', view === 'tree');

      // Render tree if switching to tree view
      if (view === 'tree') {
        renderDecisionTree();
      }

      localStorage.setItem('solutionView', view);
    }

    // ==================== DECISION TREE DATA ====================
    const DECISION_TREE_DATA = {
      id: 'root', name: 'Water Analysis', question: 'Analyze water quality',
      children: [
        {
          id: 'solids-branch', name: 'Solids Treatment', question: 'TSS treatment path',
          children: [
            { id: 'tss-high', name: 'High TSS', question: 'TSS > 100 mg/L',
              children: [
                { id: 'daf', name: 'DAF', tech: 'DAF', description: 'Dissolved Air Flotation', leaf: true },
                { id: 'clarifier', name: 'Clarifier', tech: 'CLAR', description: 'Primary Clarification', leaf: true }
              ]
            },
            { id: 'tss-med', name: 'Medium TSS', question: '50 < TSS  100',
              children: [
                { id: 'uf', name: 'UF', tech: 'UF', description: 'Ultrafiltration', leaf: true },
                { id: 'mf', name: 'MF', tech: 'MF', description: 'Microfiltration', leaf: true }
              ]
            },
            { id: 'tss-low', name: 'Low TSS', question: 'TSS  50 mg/L',
              children: [
                { id: 'direct', name: 'Direct', tech: 'DIRECT', description: 'Direct treatment', leaf: true }
              ]
            }
          ]
        },
        {
          id: 'dissolved-branch', name: 'Dissolved Solids', question: 'TDS treatment path',
          children: [
            { id: 'tds-high', name: 'High TDS', question: 'TDS > 2000 mg/L',
              children: [
                { id: 'ro', name: 'RO', tech: 'RO', description: 'Reverse Osmosis', leaf: true },
                { id: 'ed', name: 'ED', tech: 'ED', description: 'Electrodialysis', leaf: true }
              ]
            },
            { id: 'tds-med', name: 'Medium TDS', question: '500 < TDS  2000',
              children: [
                { id: 'nf', name: 'NF', tech: 'NF', description: 'Nanofiltration', leaf: true },
                { id: 'ix', name: 'IX', tech: 'IX', description: 'Ion Exchange', leaf: true }
              ]
            },
            { id: 'tds-low', name: 'Low TDS', question: 'TDS  500 mg/L',
              children: [
                { id: 'polish', name: 'Polish', tech: 'POLISH', description: 'Final polishing', leaf: true }
              ]
            }
          ]
        },
        {
          id: 'disinfection-branch', name: 'Disinfection', question: 'Final treatment',
          children: [
            { id: 'uv', name: 'UV', tech: 'UV', description: 'UV Disinfection', leaf: true },
            { id: 'aop', name: 'AOP', tech: 'AOP', description: 'Advanced Oxidation', leaf: true },
            { id: 'chlor', name: 'Cl', tech: 'CHLOR', description: 'Chlorination', leaf: true }
          ]
        }
      ]
    };

    const TECH_INFO = {
      RO: { name: 'Reverse Osmosis', recovery: 0.75, energy: 3.5, capex: 450, color: '#00d4aa' },
      NF: { name: 'Nanofiltration', recovery: 0.85, energy: 2.5, capex: 350, color: '#35d0ba' },
      UF: { name: 'Ultrafiltration', recovery: 0.95, energy: 0.5, capex: 200, color: '#7c5cff' },
      MF: { name: 'Microfiltration', recovery: 0.97, energy: 0.3, capex: 150, color: '#9370db' },
      DAF: { name: 'Dissolved Air Flotation', recovery: 0.98, energy: 0.3, capex: 150, color: '#ffa500' },
      UV: { name: 'UV Disinfection', recovery: 1.0, energy: 0.1, capex: 50, color: '#e066ff' },
      AOP: { name: 'Advanced Oxidation', recovery: 1.0, energy: 0.5, capex: 120, color: '#ff69b4' },
      CLAR: { name: 'Primary Clarifier', recovery: 0.99, energy: 0.1, capex: 100, color: '#cd853f' },
      ED: { name: 'Electrodialysis', recovery: 0.80, energy: 2.0, capex: 400, color: '#20b2aa' },
      IX: { name: 'Ion Exchange', recovery: 0.95, energy: 0.2, capex: 180, color: '#32cd32' },
      DIRECT: { name: 'Direct Feed', recovery: 1.0, energy: 0.0, capex: 0, color: '#87ceeb' },
      POLISH: { name: 'Final Polish', recovery: 0.99, energy: 0.1, capex: 30, color: '#98fb98' },
      CHLOR: { name: 'Chlorination', recovery: 1.0, energy: 0.05, capex: 20, color: '#f0e68c' }
    };

    const DECISION_SCENARIOS = [
      { id: 'food-bev', name: 'Food & Beverage', tss: 200, tds: 800, path: 'DAF  NF  UV' },
      { id: 'semiconductor', name: 'Semiconductor', tss: 30, tds: 3500, path: 'Direct  RO  UV' },
      { id: 'municipal', name: 'Municipal Reuse', tss: 80, tds: 1200, path: 'UF  NF  UV' },
      { id: 'pharma', name: 'Pharmaceutical', tss: 15, tds: 400, path: 'Direct  Polish  UV' }
    ];

    function applyTreeScenario(scenarioId) {
      const scenario = DECISION_SCENARIOS.find(s => s.id === scenarioId);
      if (!scenario) return;

      // Update scenario button states
      document.querySelectorAll('.tree-scenarios .scenario-btn').forEach(btn => {
        btn.classList.toggle('active', btn.onclick.toString().includes(scenarioId));
      });

      // Update state values (this would update the reactive system)
      state.feedTSS = scenario.tss;
      state.feedTDS = scenario.tds;

      // Re-render tree with new values
      renderDecisionTree();

      // Show notification
      showNotification('science', `Applied ${scenario.name} scenario: TSS=${scenario.tss}, TDS=${scenario.tds}`, 'success');

      // Log decision
      logDecision(`Applied ${scenario.name} use case`, `TSS=${scenario.tss} mg/L, TDS=${scenario.tds} mg/L`, 'user');
    }

    function renderDecisionTree() {
      const container = document.getElementById('decisionTreeContainer');
      if (!container) return;

      // Get current values from state
      const tss = state.feedTSS || 50;
      const tds = state.feedTDS || 500;

      const width = container.clientWidth || 500;
      const height = 320;
      const margin = { top: 30, right: 20, bottom: 20, left: 20 };
      const nodeRadius = 16;

      container.innerHTML = '';

      // Check if D3 is available
      if (typeof d3 === 'undefined') {
        container.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--muted)">
            <span class="material-icons-outlined" style="font-size:48px;margin-bottom:12px;opacity:0.5">account_tree</span>
            <p style="font-size:13px;margin-bottom:8px">D3.js library required for interactive tree</p>
            <p style="font-size:11px">Current path: TSS=${tss}  TDS=${tds}</p>
          </div>
        `;
        return;
      }

      const svg = d3.select(container).append('svg')
        .attr('width', '100%').attr('height', '100%')
        .attr('viewBox', `0 0 ${width} ${height}`);

      // Defs for glow effect
      const defs = svg.append('defs');
      const glow = defs.append('filter').attr('id', 'tree-glow')
        .attr('x', '-50%').attr('y', '-50%').attr('width', '200%').attr('height', '200%');
      glow.append('feGaussianBlur').attr('stdDeviation', '3').attr('result', 'blur');
      const feMerge = glow.append('feMerge');
      feMerge.append('feMergeNode').attr('in', 'blur');
      feMerge.append('feMergeNode').attr('in', 'SourceGraphic');

      const mainGroup = svg.append('g').attr('transform', `translate(${margin.left}, ${margin.top})`);
      const innerWidth = width - margin.left - margin.right;
      const innerHeight = height - margin.top - margin.bottom;

      // Create hierarchy
      const root = d3.hierarchy(DECISION_TREE_DATA);
      const treeLayout = d3.tree()
        .size([innerWidth, innerHeight - 20])
        .separation((a, b) => a.parent === b.parent ? 1 : 1.3);
      treeLayout(root);

      // Determine recommended path based on current values
      function getRecommendedPath() {
        const path = ['root'];
        path.push('solids-branch');
        if (tss > 100) { path.push('tss-high'); path.push('daf'); }
        else if (tss > 50) { path.push('tss-med'); path.push('uf'); }
        else { path.push('tss-low'); path.push('direct'); }
        path.push('dissolved-branch');
        if (tds > 2000) { path.push('tds-high'); path.push('ro'); }
        else if (tds > 500) { path.push('tds-med'); path.push('nf'); }
        else { path.push('tds-low'); path.push('polish'); }
        path.push('disinfection-branch');
        path.push('uv');
        return path;
      }
      const recommendedPath = getRecommendedPath();

      // Draw links
      function diagonal(s, d) {
        const midY = (s.y + d.y) / 2;
        return `M${s.x},${s.y} C${s.x},${midY} ${d.x},${midY} ${d.x},${d.y}`;
      }

      root.links().forEach((link, i) => {
        const isActive = recommendedPath.includes(link.source.data.id) &&
                        recommendedPath.includes(link.target.data.id);
        mainGroup.append('path')
          .attr('d', diagonal(link.source, link.target))
          .attr('fill', 'none')
          .attr('stroke', isActive ? '#00d4aa' : 'rgba(159,176,208,.25)')
          .attr('stroke-width', isActive ? 2.5 : 1.5)
          .attr('opacity', isActive ? 1 : 0.6);
      });

      // Draw nodes
      root.descendants().forEach((node) => {
        const isActive = recommendedPath.includes(node.data.id);
        const isLeaf = node.data.leaf;
        const tech = TECH_INFO[node.data.tech];

        const g = mainGroup.append('g')
          .attr('transform', `translate(${node.x}, ${node.y})`)
          .style('cursor', isLeaf ? 'pointer' : 'default');

        // Glow for active nodes
        if (isActive) {
          g.append('circle').attr('r', nodeRadius + 4)
            .attr('fill', 'none').attr('stroke', '#00d4aa')
            .attr('stroke-width', 2).attr('opacity', 0.5)
            .attr('filter', 'url(#tree-glow)');
        }

        // Node circle
        const nodeColor = isActive
          ? (tech ? tech.color : '#00d4aa')
          : (isLeaf ? '#ffa500' : '#7c5cff');

        g.append('circle')
          .attr('r', isLeaf ? nodeRadius - 2 : nodeRadius)
          .attr('fill', nodeColor)
          .attr('stroke', isActive ? '#fff' : 'rgba(255,255,255,.3)')
          .attr('stroke-width', isActive ? 2 : 1)
          .attr('opacity', isActive ? 1 : 0.7);

        // Node label
        const label = isLeaf ? node.data.name : (node.depth === 0 ? '?' : '');
        g.append('text').attr('text-anchor', 'middle').attr('dy', '0.35em')
          .attr('fill', '#fff').attr('font-size', isLeaf ? '8px' : '12px')
          .attr('font-weight', 'bold').text(label);

        // Branch labels
        if (!isLeaf && node.depth > 0) {
          mainGroup.append('text')
            .attr('x', node.x).attr('y', node.y + nodeRadius + 10)
            .attr('text-anchor', 'middle')
            .attr('fill', isActive ? '#00d4aa' : 'var(--muted)')
            .attr('font-size', '8px')
            .attr('font-weight', isActive ? 'bold' : 'normal')
            .text(node.data.name);
        }

        // Tooltip on click for leaf nodes
        if (isLeaf && tech) {
          g.on('click', function(event) {
            event.stopPropagation();
            showNotification('biotech',
              `${tech.name}: Recovery ${(tech.recovery * 100).toFixed(0)}%, Energy ${tech.energy} kWh/m, CAPEX ${tech.capex}/m/day`,
              'info'
            );
          });
        }
      });

      // Current values indicator
      svg.append('text').attr('x', 10).attr('y', 16)
        .attr('fill', 'var(--muted)').attr('font-size', '10px')
        .text(`Current: TSS=${tss} mg/L, TDS=${tds} mg/L`);
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      initOpexChart();

      // Initialize persona system
      initPersona();

      // Initialize step 1 as active
      goToStep(1);

      // Initialize reactive system
      bindReactiveInputs();
      CalculationEngine.runAll();

      // Initialize solution view (restore saved preference)
      const savedView = localStorage.getItem('solutionView') || 'grid';
      setSolutionView(savedView);

      // Initialize AI features
      updateAISuggestions();
      updateScenarios();
      renderWizard();
      logDecision('Proposal session started', 'New proposal workflow initiated with reactive AI', 'auto');
      logDecision('Reactive engine initialized', 'Real-time calculations and AI suggestions active', 'auto');

      // Simulate AI processing on step 2
      setTimeout(() => {
        const processing = document.querySelector('.ai-processing');
        if (processing) {
          processing.innerHTML = `
            <span class="material-icons-outlined" style="color:var(--success);font-size:24px">check_circle</span>
            <span class="ai-text" style="color:var(--success)">Reactive AI ready - ${state.autoComponents.length} auto-components</span>
          `;
        }
      }, 2000);
    });
  </script>
</body>
</html>
